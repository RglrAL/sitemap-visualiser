<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sitemap Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
   <!-- Add this to your HTML head section -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3e%3cdefs%3e%3cstyle%3e.cls-1%7bfill:%23007cb6%7d.cls-2%7bfill:%2372a300%7d%3c/style%3e%3c/defs%3e%3ccircle class='cls-1' cx='16' cy='6' r='3'/%3e%3ccircle class='cls-2' cx='8' cy='16' r='2.5'/%3e%3ccircle class='cls-2' cx='24' cy='16' r='2.5'/%3e%3ccircle class='cls-2' cx='5' cy='26' r='2'/%3e%3ccircle class='cls-2' cx='11' cy='26' r='2'/%3e%3ccircle class='cls-2' cx='21' cy='26' r='2'/%3e%3ccircle class='cls-2' cx='27' cy='26' r='2'/%3e%3cline x1='16' y1='9' x2='16' y2='12' stroke='%23333' stroke-width='2'/%3e%3cline x1='12' y1='12' x2='20' y2='12' stroke='%23333' stroke-width='2'/%3e%3cline x1='12' y1='12' x2='8' y2='14' stroke='%23333' stroke-width='2'/%3e%3cline x1='20' y1='12' x2='24' y2='14' stroke='%23333' stroke-width='2'/%3e%3cline x1='8' y1='18' x2='8' y2='22' stroke='%23333' stroke-width='1.5'/%3e%3cline x1='6' y1='22' x2='10' y2='22' stroke='%23333' stroke-width='1.5'/%3e%3cline x1='6' y1='22' x2='5' y2='24' stroke='%23333' stroke-width='1.5'/%3e%3cline x1='10' y1='22' x2='11' y2='24' stroke='%23333' stroke-width='1.5'/%3e%3cline x1='24' y1='18' x2='24' y2='22' stroke='%23333' stroke-width='1.5'/%3e%3cline x1='22' y1='22' x2='26' y2='22' stroke='%23333' stroke-width='1.5'/%3e%3cline x1='22' y1='22' x2='21' y2='24' stroke='%23333' stroke-width='1.5'/%3e%3cline x1='26' y1='22' x2='27' y2='24' stroke='%23333' stroke-width='1.5'/%3e%3c/svg%3e">
    <!-- Remove the old one and add this specific version -->
<script src="https://unpkg.com/3d-force-graph@1.71.4/dist/3d-force-graph.min.js"></script>

   
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #007cb6;
            --primary-dark: #005a87;
            --primary-light: #0099db;
            --secondary: #72A300;
            --secondary-dark: #5a8200;
            --secondary-light: #8abc00;
            --accent: #7b0046;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--gray-50);
            min-height: 100vh;
            color: var(--gray-900);
            line-height: 1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Modern Container */
        .container {
           max-width: 100% !important;
            width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: var(--shadow-2xl);
        }

        /* Improved Header Layout */
        .header {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.1;
        }

        .header-content {
            position: relative;
            z-index: 1;
            padding: 2rem 3rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-logo {
            width: 90px;
            height: 90px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .header-text {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin: 0;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
            font-weight: 400;
            margin: 0;
        }

        .theme-toggle {
            background: rgba(123, 0, 70, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .theme-toggle:hover {
            background: rgba(123, 0, 70, 0.3);
            transform: translateY(-1px);
        }

        /* Upload Section */
        .upload-section {
            padding: 1.5rem;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .upload-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .upload-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .upload-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: 12px;
            padding: 4rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--gray-50);
        }

        .upload-area:hover {
            border-color: var(--secondary);
            background: rgba(114, 163, 0, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--secondary);
            background: rgba(114, 163, 0, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            width: 56px;
            height: 56px;
            font-size: 1.75rem;
            margin: 0 auto 1rem;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .upload-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0.625rem 1.75rem;
            font-size: 0.95rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: var(--shadow-md);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .upload-btn:active {
            transform: translateY(0);
        }

        /* URL Input Section */
        .url-input-wrapper {
            position: relative;
        }

        .url-input-wrapper::before {
            content: '🔗';
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.25rem;
            opacity: 0.5;
        }

        .url-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            outline: none;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .url-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 124, 182, 0.1);
        }

        /* Quick Access */
        .quick-access-title {
            font-size: 1.0rem;
            font-weight: 650;
            
            margin-bottom: 0.75rem;
            
            letter-spacing: 0.05em;
        }

        .quick-access-grid {
            display: grid;
            gap: 0.625rem;
        }

        .quick-access-btn {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            overflow: hidden;
        }

        .quick-access-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 124, 182, 0.1), transparent);
            transition: width 0.6s ease;
        }

        .quick-access-btn:hover::before {
            width: 100%;
        }

        .quick-access-btn:hover {
            border-color: var(--secondary);
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .site-logo {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .quick-access-btn:hover .site-logo {
            transform: rotate(5deg);
        }

        .site-name {
            font-size: 0.875rem;
            color: var(--gray-700);
            font-weight: 500;
        }

        /* Stats */
        .stats {
    display: flex;
    justify-content: space-around;
    padding: 15px 20px; /* Reduced from 20px */
    background: #f8f9ff;
    margin: 5px 0px; /* Reduced from 20px 30px */
    border-radius: 10px;
    position: relative;
}

.stat-item {
    text-align: center;
    position: relative;
}

.stat-number {
    font-size: 1.5rem; /* Reduced from 2rem */
    font-weight: bold;
    color: var(--secondary);
    transition: all 0.3s ease;
    line-height: 1.2; /* Add line-height for tighter spacing */
}

.stat-label {
    color: #666;
    margin-top: 2px; /* Reduced from 5px */
    font-size: 0.85rem; /* Slightly smaller */
}

        /* Tree Container */
        .tree-container {
            padding: 0rem;
            min-height: 600px;
            background: var(--gray-50);
            position: relative;
            overflow: hidden;
        }

        .tree-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(0, 124, 182, 0.05) 0%, transparent 70%);
            pointer-events: none;
        }

        /* Modern Controls */
        .controls {
            background: white;
            border-top: 1px solid var(--gray-200);
            padding: 1.5rem 0;
            box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.05);
        }

        .controls-inner {
            max-width: 1440px;
            margin: 0 auto;
            padding: 0 3rem;
        }

        /* Search Input */
        .search-wrapper {
    position: relative;
    max-width: 400px;
    margin-bottom: 1.5rem;
    z-index: 1000;  /* Add this */
}

        .search-input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            outline: none;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
            color: #333;
            position: relative !important;
            z-index: 10 !important;
            pointer-events: auto !important;
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
        }

        .search-input:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(0, 124, 182, 0.1);
        }

        /* Search Navigation */
        .search-navigation {
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            gap: 4px;
        }

        .search-navigation.show {
            display: flex;
        }

        .search-nav-btn {
            background: var(--gray-200);
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--gray-700);
            transition: all 0.2s;
        }

        .search-nav-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
        }

        .search-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .search-results-info {
            position: absolute;
            right: 120px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            display: none;
        }

        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .search-clear.active {
            opacity: 1;
        }

        /* Search Highlighting */
        .node.search-result circle {
            stroke: #ff4d4f !important;
            stroke-width: 4px !important;
            filter: drop-shadow(0 0 8px rgba(255, 77, 79, 0.6));
        }

        .node.search-path circle {
            stroke: #ffa726 !important;
            stroke-width: 3px !important;
            opacity: 0.8;
        }

        .node.search-current circle {
            stroke: #2196f3 !important;
            stroke-width: 5px !important;
            filter: drop-shadow(0 0 12px rgba(33, 150, 243, 0.8));
            animation: pulse 1.5s ease-in-out infinite;
        }

        .link.search-path {
            stroke: #ffa726 !important;
            stroke-width: 3px !important;
            opacity: 0.8;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Search Suggestions */
        .search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid var(--gray-200);
    border-top: none;
    border-radius: 0 0 12px 12px;
    max-height: 300px;
    overflow-y: auto;
    display: none;
    z-index: 999;  /* Increased z-index */
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);  /* Better shadow */
    margin-top: -2px;  /* Connect to input */
}

        .search-suggestion {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
            transition: background 0.2s;
        }

        .search-suggestion:hover {
            background: var(--gray-50);
        }

        .search-suggestion:last-child {
            border-bottom: none;
        }

        .search-suggestion-name {
            font-weight: 500;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .search-suggestion-path {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        /* View Switcher */
        .view-switcher {
            display: inline-flex;
            background: var(--gray-100);
            border-radius: 12px;
            padding: 0.25rem;
            margin-bottom: 1.5rem;
        }

        .view-option {
            padding: 0.5rem 1.5rem;
            border: none;
            background: none;
            color: var(--gray-600);
            cursor: pointer;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .view-option:hover {
            color: var(--gray-900);
        }

        .view-option.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow);
        }

        /* Action Buttons */
        .action-grid {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .action-btn {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(0, 124, 182, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: transparent;
        }

        .action-btn.primary:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        
        /* Tree Controls - Sticky at bottom */
/* Tree Controls - Sticky at bottom */
.tree-controls {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.75rem;
    background: rgba(255, 255, 255, 0.2);  /* Changed from 0.95 to 0.85 */
    padding: 0.75rem;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    border: 1px solid rgba(0, 0, 0, 0.08);  /* Slightly more transparent border */
    z-index: 999;
    backdrop-filter: blur(1px);
}

/* Add some bottom padding to tree container so content doesn't hide behind controls */
#treeContainer {
    padding-bottom: 100px; /* Space for sticky controls */
}

        .tree-control-btn {
    padding: 0.625rem 1.25rem;
    background: rgba(255, 255, 255, 0.9);  /* Slight transparency */
    border: 2px solid transparent;
    border-radius: 12px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--gray-700);
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Dark theme support */
body.dark-theme .tree-controls {
    background: rgba(31, 41, 55, 0.8);  /* Changed from 0.95 to 0.85 */
    border-color: rgba(255, 255, 255, 0.08);
}

body.dark-theme .tree-control-btn {
    background: rgba(55, 65, 81, 0.9);  /* Slight transparency */
    color: var(--gray-300);
}

        .tree-control-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Export Buttons */
        .export-buttons {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .export-float-btn {
            padding: 0.625rem 1.25rem;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-md);
        }

        .export-float-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 4rem;
        }
        
        body.dark-theme .loading {
    color: var(--gray-100);
}

body.dark-theme #loadingText {
    color: var(--gray-100) !important;
}

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            max-width: 300px;
            height: 6px;
            background: var(--gray-200);
            border-radius: 9999px;
            overflow: hidden;
            margin: 1.5rem auto 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 9999px;
        }

        /* Color Legend */
        .colour-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 1.5rem;
            background: white;
            margin: 0 0rem 0rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-700);
            transition: var(--transition);
            cursor: pointer;
        }

        .legend-item:hover {
            transform: scale(1.05);
            color: var(--gray-900);
        }

        .legend-colour {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            box-shadow: var(--shadow);
        }
        
        /* Interactive Legend Styles */
.legend-item {
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 5px 10px;
    border-radius: 5px;
}

.legend-item:hover {
    background: rgba(0, 124, 182, 0.1);
    transform: scale(1.05);
}

/* Highlight styles for nodes */
.node.legend-highlight circle {
    stroke-width: 4px !important;
    filter: drop-shadow(0 0 10px currentColor);
    animation: pulse 1.5s ease-in-out infinite;
}

.node.legend-fade circle {
    opacity: 0.2;
}

.node.legend-fade text {
    opacity: 0.3;
}

/* Don't fade the highlighted nodes */
.node.legend-highlight.legend-fade circle,
.node.legend-highlight.legend-fade text {
    opacity: 1;
}
        
        
        
        
        
        
        
        

        /* Tooltip */
        .tooltip {
            position: absolute;
            padding: 0.75rem 1rem;
            background: var(--gray-900);
            color: white;
            border-radius: 8px;
            font-size: 0.875rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 300px;
            box-shadow: var(--shadow-xl);
            z-index: 1000;
        }

        .tooltip::before {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid var(--gray-900);
        }
        
        
        /* Enhanced Tooltip/Popup Styles */
/* Change pointer-events from 'none' to 'auto' */
.enhanced-tooltip {
    position: absolute;
    padding: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    pointer-events: none;  /* Start with none */
    opacity: 0;
    transition: opacity 0.3s ease, transform 0.3s ease;
    max-width: 400px;
    min-width: 300px;
    font-size: 14px;
    z-index: 10000;
    overflow: hidden;
}

.enhanced-tooltip.visible {
    opacity: 1;
    pointer-events: auto !important;  /* Force pointer events when visible */
    transform: translateY(-5px);
}

.tooltip-header {
    background: linear-gradient(135deg, #1f4788 0%, #2d5aa0 100%);
    color: white;
    padding: 15px;
    font-weight: 600;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.tooltip-content {
    padding: 15px;
}

.tooltip-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 15px;
}

.tooltip-stat {
    background: #f8f9ff;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
}

.tooltip-stat-value {
    font-size: 20px;
    font-weight: bold;
    color: #1f4788;
    margin-bottom: 4px;
}

.tooltip-stat-label {
    font-size: 12px;
    color: #666;
}

.tooltip-meta {
    border-top: 1px solid #e0e0e0;
    padding-top: 12px;
    margin-top: 12px;
}

.tooltip-meta-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-size: 13px;
    color: #555;
}

.tooltip-meta-icon {
    width: 20px;
    margin-right: 8px;
    text-align: center;
}

.tooltip-actions {
    display: flex;
    gap: 8px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e0e0e0;
}

.tooltip-action-btn {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #e0e0e0;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    text-align: center;
    transition: all 0.2s ease;
    color: #1f4788;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

.tooltip-action-btn:hover {
    background: #f8f9ff;
    border-color: #1f4788;
    transform: translateY(-1px);
}

/* Freshness indicator */
.tooltip-freshness {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.freshness-new { background: #e8f5e8; color: #2e7d32; }
.freshness-fresh { background: #e8f5e8; color: #43a047; }
.freshness-recent { background: #fffde7; color: #f9a825; }
.freshness-aging { background: #fff3e0; color: #ef6c00; }
.freshness-old { background: #ffebee; color: #d32f2f; }
.freshness-stale { background: #ffebee; color: #b71c1c; }

/* Dark mode support */
/* Enhanced Dark mode support for tooltip */
body.dark-theme .enhanced-tooltip {
    background: #1f2937;
    box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    border: 1px solid #374151;
}

body.dark-theme .tooltip-header {
    background: linear-gradient(135deg, #72A300 0%, #5a8200 100%);
    color: white;
}

body.dark-theme .tooltip-content {
    color: #e5e7eb;
}

body.dark-theme .tooltip-stat {
    background: #374151;
    border: 1px solid #4b5563;
}

body.dark-theme .tooltip-stat-value {
    color: white;
}

body.dark-theme .tooltip-stat-label {
    color: #9ca3af;
}

body.dark-theme .tooltip-meta {
    border-top-color: #4b5563;
}

body.dark-theme .tooltip-meta-item {
    color: #d1d5db;
}

body.dark-theme .tooltip-meta-icon {
    opacity: 0.8;
}

body.dark-theme .tooltip-actions {
    border-top-color: #4b5563;
}

body.dark-theme .tooltip-action-btn {
    background: #374151;
    border-color: #4b5563;
    color: #e5e7eb;
}

body.dark-theme .tooltip-action-btn:hover {
    background: #4b5563;
    border-color: #72A300;
    color: white;
}

/* Dark mode freshness badges */
body.dark-theme .freshness-new { 
    background: #065f46; 
    color: #34d399; 
}

body.dark-theme .freshness-fresh { 
    background: #064e3b; 
    color: #6ee7b7; 
}

body.dark-theme .freshness-recent { 
    background: #713f12; 
    color: #fbbf24; 
}

body.dark-theme .freshness-aging { 
    background: #7c2d12; 
    color: #fb923c; 
}

body.dark-theme .freshness-old { 
    background: #991b1b; 
    color: #f87171; 
}

body.dark-theme .freshness-stale { 
    background: #7f1d1d; 
    color: #fca5a5; 
}

/* Fix text colors in dark mode */
body.dark-theme .tooltip-meta-item span:last-child {
    color: white !important;  /* Make URLs green in dark mode */
}

body.dark-theme .tooltip-header > span:first-child {
    color: white !important;
}
        
        
        
        

        /* Node Styles */
        /* Node Styles */
.node circle {
    cursor: pointer;
    transition: var(--transition);
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    pointer-events: all; /* Add this line */
}

        .node circle:hover {
            stroke-width: 3px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
        }

        .node text {
    font-family: 'Inter', sans-serif;
    font-size: 0.75rem;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    pointer-events: all; /* Add this line */
}

        .link {
            fill: none;
            stroke: var(--gray-300);
            stroke-opacity: 0.6;
            stroke-width: 2px;
            transition: var(--transition);
        }

        /* Dark Mode */
        body.dark-theme {
            background: var(--gray-600);
            color: var(--gray-100);
        }

        body.dark-theme .container {
            background: var(--gray-800);
            box-shadow: none;
        }

        body.dark-theme .header {
            background: linear-gradient(135deg, #007cb6 0%, #005a87 5%);
        }

       body.dark-theme .upload-section {
    background: var(--gray-800);
    border-color: var(--gray-700);
}

body.dark-theme .upload-section h2,
body.dark-theme .upload-section h3,
body.dark-theme .upload-section label,
body.dark-theme .upload-section .upload-text {
    color: var(--gray-100);
}

body.dark-theme .file-input-label {
    background: var(--gray-700);
    color: var(--gray-100);
    border-color: var(--gray-600);
}

body.dark-theme .file-input-label:hover {
    background: var(--gray-600);
    border-color: var(--gray-500);
}

/* URL input in dark mode */
body.dark-theme .url-input {
    background: var(--gray-700);
    border-color: var(--gray-600);
    color: var(--gray-100);
}

body.dark-theme .url-input::placeholder {
    color: var(--gray-400);
}

body.dark-theme .url-submit {
    background: var(--primary);
    color: white;
}


        body.dark-theme .tree-container {
            background: var(--gray-900);
            border-top: 1px solid var(--gray-700);
        }

        body.dark-theme .tree-container::before {
            background: radial-gradient(circle, rgba(0, 124, 182, 0.1) 0%, transparent 70%);
        }
        
        body.dark-theme .drop-zone {
    background: var(--gray-700);
    border-color: var(--gray-600);
    color: var(--gray-100);
}

body.dark-theme .drop-zone.dragover {
    background: var(--gray-600);
    border-color: var(--primary);
}

body.dark-theme .drop-zone p {
    color: var(--gray-100);
}

body.dark-theme .drop-zone small {
    color: var(--gray-300);
}

        body.dark-theme .upload-card,
        body.dark-theme .controls,
        body.dark-theme .colour-legend {
            background: var(--gray-800);
            border-color: var(--gray-700);
        }

        body.dark-theme .stats {
            background: #34495e;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-theme .stat-number {
            color: #72A300;
        }

        body.dark-theme .stat-label {
            color: #ecf0f1;
        }

        body.dark-theme .upload-area {
            background: var(--gray-900);
            border-color: var(--gray-700);
        }

        body.dark-theme .url-input,
        body.dark-theme .search-input {
            background: var(--gray-900) !important;
            border-color: var(--gray-700);
            color: white !important;
        }

        body.dark-theme .view-switcher {
            background: var(--gray-900);
        }

        body.dark-theme .tree-control-btn:hover,
        body.dark-theme .export-float-btn:hover {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        body.dark-theme .view-option.active {
            background: var(--gray-700);
            color: var(--secondary);
        }

        body.dark-theme .tree-controls,
        body.dark-theme .export-float-btn {
            background: var(--gray-800);
            border-color: var(--gray-700);
            color: var(--gray-100);
             box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4); 
        }

        body.dark-theme .link {
            stroke: var(--gray-600);
        }

        body.dark-theme .tooltip {
            background: var(--gray-700);
        }

        body.dark-theme .quick-access-btn {
    background: var(--gray-800);  /* Dark background */
    border-color: var(--gray-700);
    color: var(--gray-100);
    transition: all 0.3s ease;
}

        body.dark-theme .quick-access-btn:hover {
    border-color: var(--secondary);
    background: rgba(114, 163, 0, 0.15);
    box-shadow: 0 4px 12px rgba(114, 163, 0, 0.2);
}

        body.dark-theme .quick-access-btn::before {
    background: linear-gradient(90deg, transparent, rgba(114, 163, 0, 0.3), transparent);
}

        body.dark-theme .site-name {
    color: var(--gray-100);  /* Brighter text */
    font-weight: 600;  /* Slightly bolder for readability */
}

body.dark-theme .quick-access-title {
    color: var(--gray-300);  /* Brighter than current */
}




        body.dark-theme .search-suggestions {
            background: var(--gray-800);
            border-color: var(--gray-700);
        }

        body.dark-theme .search-suggestion {
            border-bottom-color: var(--gray-700);
        }

        body.dark-theme .search-suggestion:hover {
            background: var(--gray-700);
        }

        body.dark-theme .search-suggestion-name {
            color: var(--gray-100);
        }

        body.dark-theme .search-suggestion-path {
            color: var(--gray-400);
        }

        /* Breadcrumb Navigation */
        .breadcrumb-container {
            background: white;
            padding: 2px 0px 0px 0px;
            border-bottom: 1px solid var(--gray-200);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: none;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.9rem;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .breadcrumb-crumb {
    color: var(--primary);
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    text-decoration: none;
    max-width: 300px; /* Increased from 200px */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: inline-block; /* Add this for ellipsis to work properly */
}

@media (max-width: 768px) {
    .breadcrumb-crumb {
        max-width: 150px; /* Smaller on mobile */
    }
}

@media (min-width: 1200px) {
    .breadcrumb-crumb {
        max-width: 400px; /* Larger on desktop */
    }
}

        .breadcrumb-crumb:hover {
            background: var(--gray-100);
            color: var(--primary-dark);
        }

        .breadcrumb-crumb.current {
            color: var(--gray-700);
            font-weight: 600;
            cursor: default;
        }

        .breadcrumb-crumb.current:hover {
            background: transparent;
        }

        .breadcrumb-separator {
            color: var(--gray-400);
            font-size: 0.8rem;
        }

        body.dark-theme .breadcrumb-container {
            background: var(--gray-800);
            border-bottom-color: var(--gray-700);
        }

        body.dark-theme .breadcrumb-crumb {
            color: var(--secondary);
        }

        /* Dashboard styles - Original Analytics Section */
.dashboard {
    padding: 20px 20px;
    background: #f8f9ff;
    font-family: 'Segoe UI', sans-serif;
}

.dashboard-header {
    text-align: center;
    margin-bottom: 30px;
}

.dashboard-header h2 {
    color: #1f4788;
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.dashboard-subtitle {
    color: #666;
    font-size: 1.1rem;
}



/* Dark Mode Dashboard Styles */
body.dark-theme .dashboard {
    background: var(--gray-900);
    color: var(--gray-100);
}

body.dark-theme .dashboard-header h2 {
    color: var(--gray-100);
}

body.dark-theme .dashboard-subtitle {
    color: var(--gray-400);
}

/* Metric Cards */
body.dark-theme .metric-card {
    background: var(--gray-800);
    border-left-color: var(--secondary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

body.dark-theme .metric-card:hover {
    box-shadow: 0 6px 20px rgba(114, 163, 0, 0.2);
    background: var(--gray-750);
}

body.dark-theme .metric-value {
    color: var(--secondary);
}

body.dark-theme .metric-label {
    color: var(--gray-400);
}

body.dark-theme .metric-change {
    font-weight: 600;
}

body.dark-theme .metric-change.positive {
    background: rgba(46, 125, 50, 0.2);
    color: #81c784;
}

body.dark-theme .metric-change.neutral {
    background: rgba(33, 150, 243, 0.2);
    color: #64b5f6;
}

/* Chart Cards */
body.dark-theme .chart-card {
    background: var(--gray-800);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

body.dark-theme .chart-title {
    color: var(--gray-100);
}

/* Insights Cards */
body.dark-theme .insight-card {
    background: var(--gray-800);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

body.dark-theme .insight-title {
    color: var(--gray-100);
}

body.dark-theme .insight-content {
    color: var(--gray-300);
}

/* Progress Bars */
body.dark-theme .progress-bar-container {
    background: var(--gray-700);
}

body.dark-theme .progress-bar-fill {
    filter: brightness(1.2);
}

/* Issues Lists */
body.dark-theme .issue-critical {
    background: rgba(244, 67, 54, 0.1);
    border-left-color: #ef5350;
    color: var(--gray-100);
}

body.dark-theme .issue-warning {
    background: rgba(255, 152, 0, 0.1);
    border-left-color: #ffa726;
    color: var(--gray-100);
}

body.dark-theme .issue-info {
    background: rgba(33, 150, 243, 0.1);
    border-left-color: #42a5f5;
    color: var(--gray-100);
}

/* Recommendations */
body.dark-theme .recommendation-list {
    color: var(--gray-300);
}

body.dark-theme .recommendation-list li {
    border-bottom-color: var(--gray-700);
}

/* Category Tags */
body.dark-theme .category-tag {
    background: rgba(30, 71, 136, 0.3);
    color: #90caf9;
}

/* Performance Gauge */
body.dark-theme .gauge-score {
    filter: brightness(1.2);
}

body.dark-theme .performance-gauge {
    color: var(--gray-100);
}

/* Language/Category sections in charts */
body.dark-theme .charts-section h3 {
    color: var(--gray-100);
}

body.dark-theme .charts-section h4 {
    color: var(--gray-100) !important;
}

/* Progress bars in category sections */
body.dark-theme div[style*="background: #f0f0f0"] {
    background: var(--gray-700) !important;
}



body.dark-theme div[style*="color: #1f4788"] {
    color: var(--gray-100) !important;
}

body.dark-theme div[style*="color: #444"] {
    color: var(--gray-300) !important;
}

/* Recommendations box */
body.dark-theme div[style*="background: #e8f2ff"] {
    background: rgba(33, 150, 243, 0.1) !important;
    color: var(--gray-100) !important;
}

body.dark-theme div[style*="background: #e8f2ff"] h4 {
    color: #90caf9 !important;
}

body.dark-theme div[style*="background: #e8f2ff"] ul {
    color: var(--gray-300) !important;
}

/* Export buttons in dashboard */
body.dark-theme button[style*="background: #4a90e2"] {
    background: var(--secondary) !important;
}

body.dark-theme button[style*="background: #666"] {
    background: var(--gray-700) !important;
    border: 1px solid var(--gray-600) !important;
}

/* Language distribution cards */


body.dark-theme div[style*="background: #f0f8f0"] {
    background: rgba(114, 163, 0, 0.1) !important;
}

/* Category bars */
body.dark-theme div[style*="background: #e3f2fd"] {
    background: var(--gray-700) !important;
}

body.dark-theme div[style*="background: #e8f5e8"] {
    background: var(--gray-700) !important;
}

/* Fix specific dashboard text elements */
body.dark-theme .dashboard span[style*="color: #1f4788"],
body.dark-theme .dashboard span[style*="color: #52734d"] {
    color: var(--gray-100) !important;
}

body.dark-theme .dashboard span[style*="color: #666"],
body.dark-theme .dashboard span[style*="color: #888"] {
    color: var(--gray-400) !important;
}

/* Grid backgrounds */
body.dark-theme div[style*="background: #f9f9f9"] {
    background: var(--gray-850) !important;
}



/* Links in dashboard */
body.dark-theme .dashboard a {
    color: var(--secondary) !important;
}

body.dark-theme .dashboard a:hover {
    color: var(--secondary-light) !important;
}


.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.metric-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-left: 4px solid #4a90e2;
    transition: transform 0.2s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: #1f4788;
    margin-bottom: 5px;
}

.metric-label {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 8px;
}

.metric-change {
    font-size: 0.8rem;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 500;
}

.metric-change.positive {
    background: #e8f5e8;
    color: #2d7d32;
}

.metric-change.neutral {
    background: #e3f2fd;
    color: #1976d2;
}

.charts-section {
    margin-bottom: 30px;
}

.charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.chart-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.chart-title {
    color: #1f4788;
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 15px;
    text-align: center;
}

.insights-section {
    margin-bottom: 30px;
}

.insights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.insight-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.insight-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.insight-icon {
    font-size: 1.5rem;
    margin-right: 10px;
}

.insight-title {
    color: #1f4788;
    font-size: 1.1rem;
    font-weight: 600;
}

.insight-content {
    color: #444;
    line-height: 1.5;
}

.performance-gauge {
    text-align: center;
    padding: 20px;
}

.gauge-container {
    position: relative;
    width: 200px;
    height: 100px;
    margin: 0 auto 20px;
}

.gauge-score {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
    font-weight: bold;
    color: #1f4788;
}

.issues-list {
    list-style: none;
    padding: 0;
}

.issues-list li {
    padding: 10px 15px;
    margin-bottom: 8px;
    border-radius: 8px;
    display: flex;
    align-items: flex-start;
}

.issue-critical {
    background: #ffebee;
    border-left: 4px solid #f44336;
}

.issue-warning {
    background: #fff8e1;
    border-left: 4px solid #ff9800;
}

.issue-info {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
}

.issue-icon {
    margin-right: 10px;
    margin-top: 2px;
}

.category-breakdown {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
}

.category-tag {
    background: #e8f2ff;
    color: #1f4788;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.progress-bar-container {
    background: #f0f0f0;
    border-radius: 10px;
    height: 8px;
    margin: 10px 0;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.8s ease;
}

.recommendation-list {
    list-style: none;
    padding: 0;
}

.recommendation-list li {
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    align-items: flex-start;
}

.recommendation-list li:last-child {
    border-bottom: none;
}

.recommendation-icon {
    margin-right: 10px;
    margin-top: 2px;
}

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                padding: 1.5rem;
                flex-direction: column;
                gap: 1rem;
            }

            .header-left {
                flex-direction: column;
                text-align: center;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .upload-section {
                padding: 1.25rem;
            }

            .upload-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .stats {
                padding: 1.5rem;
                flex-wrap: wrap;
                gap: 1rem;
                margin: 15px;
            }

            .stat-item {
                flex: 1 1 calc(50% - 0.5rem);
                min-width: 120px;
            }

            .stat-number {
                font-size: 2rem;
            }

            .controls-inner {
                padding: 0 1.5rem;
            }

            .action-grid {
                flex-direction: column;
            }

            .tree-controls {
        bottom: 1rem;
        gap: 0.5rem;
        width: auto; /* Changed from calc(100% - 2rem) */
        max-width: calc(100% - 2rem); /* Prevent overflow */
        padding: 0.5rem 0.75rem; /* Even padding on both sides */
        left: 50%;
        transform: translateX(-50%);
        justify-content: center; /* Center the buttons */
    }

            .tree-control-btn {
        padding: 0.75rem;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        justify-content: center;
        margin: 0; /* Remove any default margins */
    }

            .tree-control-btn .btn-text {
                display: none;
            }

            .export-buttons {
                top: 1rem;
                right: 1rem;
            }

            .export-float-btn {
                padding: 0.625rem;
                border-radius: 50%;
                width: 44px;
                height: 44px;
                justify-content: center;
                font-size: 0;
            }

            .export-float-btn svg {
                width: 20px;
                height: 20px;
                margin: 0;
            }
        }

        @media (max-width: 480px) {
            .stats {
                margin: 10px;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            .tree-control-btn,
            .export-float-btn {
                width: 40px;
                height: 40px;
            }
        }
        
        
        
        /* Collapsible Upload Section */
.upload-section {
    transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                opacity 0.3s ease,
                transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    max-height: 1000px; /* Adjust based on your content */
    transform-origin: top;
}

.upload-section.collapsed {
    max-height: 0;
    opacity: 0;
    transform: scaleY(0);
    padding-top: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.upload-toggle-btn {
    position: absolute;
    bottom: -20px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: 20px;
    padding: 8px 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--gray-700);
    transition: all 0.3s ease;
    z-index: 10;
    box-shadow: var(--shadow-md);
}

.upload-toggle-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
    transform: translateX(-50%) translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.upload-toggle-icon {
    transition: transform 0.3s ease;
    font-size: 1rem;
}

.upload-toggle-btn.collapsed .upload-toggle-icon {
    transform: rotate(180deg);
}

/* Dark mode support */
body.dark-theme .upload-toggle-btn {
    background: var(--gray-800);
    border-color: var(--gray-700);
    color: var(--gray-200);
}

body.dark-theme .upload-toggle-btn:hover {
    background: var(--secondary);
    border-color: var(--secondary);
}

/* Mobile adjustments */
@media (max-width: 768px) {
    .upload-toggle-btn {
        padding: 6px 16px;
        font-size: 0.8rem;
    }
}



/* Modern Navigation Bar */
.nav-bar {
    background: white;
    border-bottom: 1px solid var(--gray-200);
    padding: 0 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    height: 48px;
    position: sticky;
    top: 0;
    z-index: 999;  /* Change from 1000 to 999 */
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* When scrolled, add more shadow */
.nav-bar.scrolled {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.nav-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.nav-btn {
    padding: 0.5rem 1rem;
    background: none;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--gray-700);
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.nav-btn:hover {
    background: var(--gray-100);
    color: var(--gray-900);
}

.nav-btn.active {
    background: var(--primary);
    color: white;
}

/* Reports Dropdown */
.nav-dropdown {
    position: relative;
}

.nav-dropdown-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.nav-dropdown-btn::after {
    content: '▼';
    font-size: 0.7rem;
    transition: transform 0.2s ease;
}

.nav-dropdown.open .nav-dropdown-btn::after {
    transform: rotate(180deg);
}

.nav-dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 0.5rem;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    min-width: 200px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
}

.nav-dropdown.open .nav-dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.nav-dropdown-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background 0.2s ease;
    border-bottom: 1px solid var(--gray-100);
}

.nav-dropdown-item:last-child {
    border-bottom: none;
}

.nav-dropdown-item:hover {
    background: var(--gray-50);
}

.nav-dropdown-item:first-child {
    border-radius: 12px 12px 0 0;
}

.nav-dropdown-item:last-child {
    border-radius: 0 0 12px 12px;
}

/* Search in nav */
.nav-search {
    flex: 1;
    max-width: 400px;
    margin: 0 auto;
    position: relative; /* Add this */
}


.nav-search .search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    max-height: 300px;
    overflow-y: auto;
    display: none;
    z-index: 999;  /* Lower than mobile menu (1001) */
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    margin-top: 30px;
}

.nav-search input {
    width: 100%;
    padding: 0.5rem 1rem;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    background: var(--gray-50);
    position: relative;  /* Add this */
    z-index: 10001;     /* Higher than suggestions */
}


/* Dark mode adjustments */
body.dark-theme .nav-search .search-suggestions {
    background: var(--gray-800);
    border-color: var(--gray-700);
}


/* Optional: Add a small arrow pointing up to the search box */
.nav-search .search-suggestions::before {
    content: '';
    position: absolute;
    top: -8px;
    left: 20px;
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-bottom: 8px solid var(--gray-200);
}

.nav-search .search-suggestions::after {
    content: '';
    position: absolute;
    top: -6px;
    left: 22px;
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 6px solid white;
}

/* Dark mode arrow */
body.dark-theme .nav-search .search-suggestions::after {
    border-bottom-color: var(--gray-800);
}

.nav-search input:focus {
    outline: none;
    border-color: var(--primary);
    background: white;
    box-shadow: 0 0 0 3px rgba(0, 124, 182, 0.1);
}

/* Dark mode button in nav */
.nav-theme-btn {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

/* Dark mode support */
body.dark-theme .nav-bar {
    background: var(--gray-800);
    border-bottom-color: var(--gray-700);
}

body.dark-theme .nav-btn {
    color: var(--gray-300);
}

body.dark-theme .nav-btn:hover {
    background: var(--gray-700);
    color: white;
}

body.dark-theme .nav-btn.active {
    background: var(--secondary);
}

body.dark-theme .nav-dropdown-menu {
    background: var(--gray-800);
    border-color: var(--gray-700);
}

body.dark-theme .nav-dropdown-item {
    border-bottom-color: var(--gray-700);
}

body.dark-theme .nav-dropdown-item:hover {
    background: var(--gray-700);
}

body.dark-theme .nav-search input {
    background: var(--gray-900);
    border-color: var(--gray-700);
    color: white;
}

.drop-zone-title {
    color: var(--gray-800);
    margin-bottom: 0.5rem;
}

body.dark-theme .drop-zone-title {
    color: var(--gray-100);
}



/* Hide mobile menu button on desktop */
.mobile-menu-btn {
    display: none;
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    z-index: 1002;
}

.mobile-menu-btn span {
    display: block;
    width: 25px;
    height: 3px;
    background: var(--gray-700);
    margin: 4px 0;
    transition: all 0.3s ease;
}

/* Mobile nav menu - hidden by default */
.mobile-nav-menu {
    position: fixed;
    top: 0;
    left: -300px;
    width: 280px;
    height: 100vh;
    background: white;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    transition: left 0.3s ease;
    z-index: 10001;  /* Increase from 1001 to 10001 */
    overflow-y: auto;
    padding: 20px;
}

/* Dark theme support for mobile menu */
body.dark-theme .mobile-nav-menu {
    background: var(--gray-800);
}

body.dark-theme .mobile-menu-btn span {
    background: var(--gray-300);
}

/* Show mobile menu when open */
.nav-bar.menu-open .mobile-nav-menu {
    left: 0;
}

/* Mobile menu overlay */
.mobile-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    z-index: 10000;  /* Increase from 1000 to 10000 */
}

.nav-bar.menu-open .mobile-menu-overlay {
    opacity: 1;
    visibility: visible;
}

/* Mobile nav sections */
.mobile-nav-section {
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--gray-200);
}

.mobile-nav-section:last-child {
    border-bottom: none;
}

.mobile-nav-section h3 {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-600);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.mobile-nav-item {
    display: block;
    width: 100%;
    padding: 12px 16px;
    background: none;
    border: none;
    text-align: left;
    cursor: pointer;
    font-size: 1rem;
    color: var(--gray-700);
    border-radius: 8px;
    transition: all 0.2s ease;
}

.mobile-nav-item:hover {
    background: var(--gray-100);
    color: var(--gray-900);
}

.mobile-nav-item.active {
    background: var(--primary);
    color: white;
}

/* Dark theme mobile nav items */
body.dark-theme .mobile-nav-section {
    border-bottom-color: var(--gray-700);
}

body.dark-theme .mobile-nav-section h3 {
    color: var(--gray-400);
}

body.dark-theme .mobile-nav-item {
    color: var(--gray-300);
}

body.dark-theme .mobile-nav-item:hover {
    background: var(--gray-700);
    color: white;
}

/* Mobile responsive styles */
@media (max-width: 768px) {
    /* Show mobile menu button */
    .mobile-menu-btn {
        display: block;
    }
    
    /* Hide desktop nav elements on mobile */
    .nav-group,
    .nav-separator,
    .nav-dropdown {
        display: none !important;
    }
    
    /* Adjust nav bar layout for mobile */
    .nav-bar {
        padding: 0.5rem 1rem;
        justify-content: space-between;
    }
    
    /* Make search full width on mobile */
    .nav-search {
        flex: 1;
        margin: 0 0.5rem;
        max-width: none;
    }
    
    /* Adjust upload toggle for mobile */
    .nav-btn.upload-toggle {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }
    
    .nav-btn.upload-toggle .upload-toggle-text {
        display: none;
    }
    
    /* Show only icon on mobile */
    .nav-btn.upload-toggle::before {
        content: '';
        font-size: 1.2rem;
    }
}


/* Menu open state animations */

.nav-bar.menu-open .mobile-menu-btn span:nth-child(1) {
    transform: rotate(45deg) translate(5px, 12px);  /* Increased to 12px */
}

.nav-bar.menu-open .mobile-menu-btn span:nth-child(2) {
    opacity: 0;
}

.nav-bar.menu-open .mobile-menu-btn span:nth-child(3) {
    transform: rotate(-45deg) translate(6px, 0px);  /* Changed to 0px to move down */
}






.nav-separator {
    width: 1px;
    height: 24px;
    background: var(--gray-300);
    margin: 0 0.75rem;
    opacity: 0.5;
}

body.dark-theme .nav-separator {
    background: var(--gray-600);
}

/* Hide separator on mobile */
@media (max-width: 768px) {
    .nav-separator {
        display: none;
    }
}


.nav-btn.upload-toggle {
    background: var(--gray-100);
    border: 1px solid var(--gray-300);
    display: flex;
    align-items: center;
    
}

.nav-btn.upload-toggle:hover {
    background: var(--gray-200);
    border-color: var(--gray-400);
}

.upload-chevron {
    font-size: 1.0rem;
    transition: transform 0.9s ease;
}

.upload-section.collapsed ~ .nav-bar .upload-chevron {
    transform: rotate(180deg);
}

/* Dark mode */
body.dark-theme .nav-btn.upload-toggle {
    background: var(--gray-700);
    border-color: var(--gray-600);
}

body.dark-theme .nav-btn.upload-toggle:hover {
    background: var(--gray-600);
}


/* Dark mode stats section */
body.dark-theme #stats {
    background: var(--gray-800);
    border-color: var(--gray-700);
}

body.dark-theme .stat-card {
    background: var(--gray-700);
    border-color: var(--gray-600);
}

body.dark-theme .stat-card:hover {
    background: var(--gray-600);
    border-color: var(--gray-500);
}

body.dark-theme .stat-value {
    color: var(--gray-100);
}

body.dark-theme .stat-label {
    color: var(--gray-300);
}

/* If the stats use different class names */
body.dark-theme .stats-container {
    color: var(--gray-100);
}

body.dark-theme .stats-item {
    color: var(--gray-100);
}

/* Force all text in stats section to be light in dark mode */
body.dark-theme #stats * {
    color: var(--gray-100);
}


/* Legend styling */
.legend-label {
    color: var(--gray-800);
}

body.dark-theme .legend-label {
    color: var(--gray-100);
}

/* Also style the legend container in dark mode */
body.dark-theme #colourLegend {
    background: var(--gray-800);
    border-color: var(--gray-700);
}




/* Mobile optimizations for ultra-compact stats and legend */
@media (max-width: 768px) {
    .stats {
        padding: 6px 8px !important;
        margin: 6px 10px !important;
        gap: 4px !important;
        display: flex !important;
        flex-wrap: nowrap !important; /* Force single line */
        background: var(--gray-50);
        border-radius: 6px;
    }
    
    .stat-item {
        flex: 1 1 25% !important; /* Equal width for all 4 */
        min-width: 0 !important; /* Allow shrinking */
        text-align: center;
        padding: 2px !important;
        border-right: 1px solid var(--gray-200);
    }
    
    .stat-item:last-child {
        border-right: none;
    }
    
    .stat-number {
        font-size: 1rem !important;
        font-weight: 600 !important;
        margin: 0 !important;
        line-height: 1 !important;
    }
    
    .stat-label {
        font-size: 0.55rem !important;
        color: var(--gray-600);
        line-height: 1.1 !important;
        margin-top: 1px !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Fix legend overflow - make it wrap properly */
    .colour-legend {
        padding: 8px 10px !important;
        margin: 0 10px 8px !important;
        gap: 6px 10px !important;
        display: flex !important;
        flex-wrap: wrap !important;
        justify-content: center !important;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .legend-item {
        font-size: 0.7rem !important;
        padding: 3px 6px !important;
        margin: 0 !important;
        border-radius: 4px;
        background: var(--gray-50);
        flex: 0 0 auto !important;
    }
    
    .legend-colour {
        width: 10px !important;
        height: 10px !important;
        border-radius: 2px !important;
    }
}

/* For very small screens - make even more compact */
@media (max-width: 480px) {
    .stats {
        padding: 4px 6px !important;
        margin: 4px 8px !important;
        gap: 2px !important;
    }
    
    .stat-number {
        font-size: 0.9rem !important;
    }
    
    .stat-label {
        font-size: 0.5rem !important;
    }
    
    .colour-legend {
        padding: 0px 8px !important;
        margin: 0 8px 6px !important;
        gap: 4px 8px !important;
    }
    
    .legend-item {
        font-size: 0.65rem !important;
        padding: 2px 5px !important;
    }
    
    .legend-colour {
        width: 8px !important;
        height: 8px !important;
    }
}

/* For extremely small screens (under 380px) */
@media (max-width: 380px) {
    .stat-number {
        font-size: 0.85rem !important;
    }
    
    .stat-label {
        font-size: 0.45rem !important;
        font-weight: 500;
    }
}

/* Dark theme adjustments */
body.dark-theme .stats {
    background: var(--gray-800);
}

body.dark-theme .stat-item {
    border-right-color: var(--gray-700);
}

body.dark-theme .colour-legend {
    background: var(--gray-800);
}

body.dark-theme .legend-item {
    background: var(--gray-700);
}


/* Compact header for mobile */
@media (max-width: 768px) {
    .header {
        padding: 0rem 0 !important; /* Reduced from 2rem */
    }
    
    .header-content {
        padding: 1rem 1.5rem !important; /* Reduced padding */
        flex-direction: column !important;
        gap: 0.5rem !important;
    }
    
    .header-left {
        flex-direction: row !important; /* Keep logo and text side by side */
        gap: 0.75rem !important;
        align-items: center !important;
    }
    
    .header-logo {
        width: 60px !important; /* Smaller logo */
        height: 60px !important;
        border-radius: 8px !important;
    }
    
    .header-logo img {
        height: 50px !important;
        width: auto !important;
    }
    
    .header-text {
        gap: 0 !important;
    }
    
    .header h1 {
        font-size: 1.25rem !important; /* Smaller title */
        margin: 0 !important;
        line-height: 1.2 !important;
    }
    
    .header p {
        font-size: 0.875rem !important; /* Smaller subtitle */
        margin: 0 !important;
        line-height: 1.3 !important;
        display: none !important; /* Hide subtitle on mobile to save space */
    }
}

/* For very small screens - even more compact */
@media (max-width: 480px) {
    .header {
        padding: 0rem 0 !important;
    }
    
    .header-content {
        padding: 0.75rem 1rem !important;
    }
    
    .header-logo {
        width: 50px !important;
        height: 50px !important;
    }
    
    .header-logo img {
        height: 40px !important;
    }
    
    .header h1 {
        font-size: 1.1rem !important;
    }
}




/* Left-align mobile content with padding */
@media (max-width: 768px) {
    /* Left-align header */
    .header-content {
        align-items: flex-start !important;
    }
    
    .header-left {
        justify-content: flex-start !important;
        width: 100%;
    }
    
    /* Left-align stats */
    .stats {
        margin-left: 16px !important;
        margin-right: 16px !important;
    }
    
    /* Left-align legend */
    .colour-legend {
        margin-left: 16px !important;
        margin-right: 16px !important;
        justify-content: flex-start !important;
    }
    
    /* Left-align nav bar items */
    .nav-bar {
        padding-left: 16px !important;
        padding-right: 16px !important;
    }
    
    /* Left-align upload section content */
    .upload-container {
        padding: 0 16px !important;
    }
    
    .upload-card {
        margin: 0 0 1rem 0 !important;
    }
    
    /* Left-align breadcrumb */
    .breadcrumb-container {
        padding-left: 16px !important;
        padding-right: 16px !important;
    }
}

/* For smaller screens, reduce padding slightly */
@media (max-width: 480px) {
    .header-content,
    .stats,
    .colour-legend,
    .nav-bar,
    .upload-container,
    .breadcrumb-container {
        padding-left: 12px !important;
        padding-right: 12px !important;
    }
    
    .stats,
    .colour-legend {
        margin-left: 12px !important;
        margin-right: 12px !important;
    }
}



/* Mobile responsive dashboard */
@media (max-width: 768px) {
    .dashboard {
        
    }
    
    .dashboard-header {
        margin-bottom: 20px !important;
        margin-top: 20px !important;
    }
    
    .dashboard-header h2 {
        font-size: 1.75rem !important;
    }
    
    .dashboard-subtitle {
        font-size: 0.95rem !important;
    }
    
    /* Make metrics stack vertically on mobile */
    .metrics-grid {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
    }
    
    .metric-card {
        padding: 15px !important;
    }
    
    .metric-value {
        font-size: 1.75rem !important;
    }
    
    .metric-label {
        font-size: 0.85rem !important;
    }
    
    /* Stack charts vertically */
    .charts-grid {
        grid-template-columns: 1fr !important;
        gap: 15px !important;
    }
    
    .chart-card {
        padding: 15px !important;
        min-height: 200px !important;
    }
    
    .chart-title {
        font-size: 1rem !important;
    }
    
    /* Make insights responsive */
    .insights-grid {
        grid-template-columns: 1fr !important;
        gap: 15px !important;
    }
    
    .insight-card {
        padding: 15px !important;
    }
    
    .insight-title {
        font-size: 1rem !important;
    }
    
    .insight-content {
        font-size: 0.9rem !important;
    }
    
    /* Adjust performance gauge */
    .gauge-container {
        width: 150px !important;
        height: 75px !important;
    }
    
    .gauge-score {
        font-size: 1.5rem !important;
    }
    
    /* Make lists more compact */
    .issues-list li,
    .recommendation-list li {
        padding: 8px 12px !important;
        font-size: 0.85rem !important;
        margin-bottom: 6px !important;
    }
    
    /* Compact category tags */
    .category-tag {
        font-size: 0.75rem !important;
        padding: 2px 8px !important;
    }
}

/* For very small screens */
@media (max-width: 480px) {
    .dashboard {
        padding: 8px !important;
    }
    
    .dashboard-header h2 {
        font-size: 1.5rem !important;
        line-height: 1.2 !important;
    }
    
    .metric-card {
        padding: 12px !important;
    }
    
    .metric-value {
        font-size: 1.5rem !important;
    }
    
    .chart-card {
        padding: 12px !important;
        min-height: 180px !important;
    }
    
    .insight-card {
        padding: 12px !important;
    }
}

/* Horizontal scroll for wide tables/content if needed */
@media (max-width: 768px) {
    .dashboard table {
        display: block !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
    }
    
    .dashboard pre,
    .dashboard .code-block {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
        max-width: 100% !important;
    }
}

/* Two column layout for metrics on tablets */
@media (min-width: 481px) and (max-width: 768px) {
    .metrics-grid {
        grid-template-columns: repeat(2, 1fr) !important;
    }
}

/* Mobile responsive upload section (placeholder) */
@media (max-width: 768px) {
    .upload-section {
        padding: 1rem !important;
    }
    
    .upload-container {
        grid-template-columns: 1fr !important; /* Stack cards vertically */
        gap: 1rem !important;
        max-width: 100% !important;
        padding: 0 !important;
    }
    
    .upload-card {
        padding: 1.25rem !important;
        margin: 0 !important;
    }
    
    .upload-card h3 {
        font-size: 1.1rem !important;
        margin-bottom: 0.75rem !important;
    }
    
    .upload-area {
        padding: 2.5rem 1rem !important;
        border-radius: 8px !important;
    }
    
    .upload-icon {
        width: 40px !important;
        height: 40px !important;
        font-size: 1.5rem !important;
        margin: 0 auto 0.75rem !important;
        border-radius: 12px !important;
    }
    
    .drop-zone-title {
        font-size: 1rem !important;
        margin-bottom: 0.5rem !important;
    }
    
    .upload-btn {
        padding: 0.5rem 1.25rem !important;
        font-size: 0.875rem !important;
        border-radius: 8px !important;
    }
    
    /* URL input section */
    .url-input-wrapper {
        margin-bottom: 0.75rem !important;
    }
    
    .url-input {
        padding: 0.625rem 0.875rem 0.625rem 2.5rem !important;
        font-size: 0.875rem !important;
        border-radius: 8px !important;
    }
    
    .url-input-wrapper::before {
        font-size: 1rem !important;
        left: 0.75rem !important;
    }
    
    /* Quick access section */
    .quick-access-title {
        font-size: 0.8rem !important;
        margin-bottom: 0.5rem !important;
    }
    
    .quick-access-grid {
        gap: 0.5rem !important;
    }
    
    .quick-access-btn {
        padding: 0.625rem !important;
        border-radius: 8px !important;
        gap: 0.75rem !important;
    }
    
    .site-logo {
        width: 36px !important;
        height: 36px !important;
        border-radius: 8px !important;
    }
    
    .site-logo img {
        height: 2.5rem !important;
    }
    
    .site-name {
        font-size: 0.8rem !important;
    }
}

/* For very small screens */
@media (max-width: 480px) {
    .upload-section {
        padding: 0.75rem !important;
    }
    
    .upload-card {
        padding: 1rem !important;
        border-radius: 12px !important;
    }
    
    .upload-area {
        padding: 2rem 0.75rem !important;
    }
    
    .upload-icon {
        width: 36px !important;
        height: 36px !important;
        font-size: 1.25rem !important;
    }
    
    .drop-zone-title {
        font-size: 0.9rem !important;
    }
    
    .upload-btn {
        padding: 0.45rem 1rem !important;
        font-size: 0.8rem !important;
    }
    
    .quick-access-btn {
        padding: 0.5rem !important;
        font-size: 0.75rem !important;
    }
    
    .site-logo {
        width: 32px !important;
        height: 32px !important;
    }
    
    .site-logo img {
        height: 2rem !important;
    }
}

/* Ensure the loading overlay is also responsive */
@media (max-width: 768px) {
    .loading {
        position: fixed !important;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        z-index: 9999;
        /* Remove the display: flex !important - let JavaScript control display */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        margin: 0 !important;
    }
    
    /* Only apply flex when it's actually shown */
    .loading[style*="display: block"] {
        display: flex !important;
    }
    
    body.dark-theme .loading {
        background: rgba(17, 24, 39, 0.95);
    }
    
    body.dark-theme #loadingText {
    color: var(--gray-100) !important; /* Light gray text */
}
    
     /* Ensure the spinner and text are centered and sized appropriately */
    .loading .spinner {
        width: 60px !important;
        height: 60px !important;
        margin: 0 auto 2rem !important;
    }
    
    .loading p {
        font-size: 1.1rem !important;
        text-align: center;
        margin-bottom: 1.5rem !important;
    }
    
    .loading .progress-bar {
        width: 80% !important;
        max-width: 300px !important;
    }
}


/* For very small screens, adjust padding */
@media (max-width: 480px) {
    .loading {
        padding: 15px;
    }
    
    .loading .spinner {
        width: 50px !important;
        height: 50px !important;
    }
    
    .loading p {
        font-size: 1rem !important;
    }
}


/* Fix Analytics Dashboard overflow on mobile */
@media (max-width: 768px) {
    /* Target the dashboard container and placeholder */
    #dashboardView,
    .dashboard-view {
        width: 100% !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
        padding: 0 !important;
    }
    
    /* The purple box itself */
    #dashboardView > div,
    .dashboard-placeholder,
    .analytics-dashboard-placeholder {
        width: calc(100% - 32px) !important;
        max-width: 100% !important;
        margin: 16px !important;
        padding: 30px 20px !important;
        box-sizing: border-box !important;
        overflow-wrap: break-word !important;
        word-wrap: break-word !important;
    }
    
    /* Fix text overflow */
    #dashboardView h2,
    #dashboardView h3,
    .analytics-dashboard-placeholder h2 {
        font-size: 1.5rem !important;
        text-align: center !important;
        margin-bottom: 16px !important;
    }
    
    #dashboardView p,
    .analytics-dashboard-placeholder p {
        font-size: 0.9rem !important;
        text-align: center !important;
        padding: 0 10px !important;
        line-height: 1.4 !important;
    }
    
    /* Chart icon if present */
    #dashboardView img,
    #dashboardView svg,
    .chart-icon {
        max-width: 80px !important;
        height: auto !important;
        margin: 0 auto 20px !important;
    }
}

/* For very small screens */
@media (max-width: 480px) {
    #dashboardView > div,
    .dashboard-placeholder,
    .analytics-dashboard-placeholder {
        margin: 12px !important;
        padding: 24px 16px !important;
    }
    
    #dashboardView h2 {
        font-size: 1.25rem !important;
    }
    
    #dashboardView p {
        font-size: 0.85rem !important;
        padding: 0 5px !important;
    }
}

/* Ensure no horizontal scroll on the body */
@media (max-width: 768px) {
    body {
        overflow-x: hidden !important;
    }
    
    .container {
        overflow-x: hidden !important;
    }
}

/* Fix Analytics Dashboard inline styles on mobile */
@media (max-width: 768px) {
    /* Target the dashboard placeholder with inline styles */
    div[style*="width: 100%"][style*="height: 400px"][style*="background: linear-gradient"] {
        width: calc(100% - 32px) !important;
        height: auto !important;
        min-height: 300px !important;
        margin: 16px !important;
        padding: 40px 20px !important;
    }
    
    /* Adjust the emoji/icon */
    div[style*="width: 100%"][style*="height: 400px"] > div:first-child {
        font-size: 3rem !important;
        margin-bottom: 16px !important;
    }
    
    /* Adjust the title */
    div[style*="width: 100%"][style*="height: 400px"] > div:nth-child(2) {
        font-size: 20px !important;
    }
    
    /* Adjust the subtitle */
    div[style*="width: 100%"][style*="height: 400px"] > div:last-child {
        font-size: 14px !important;
        padding: 0 10px !important;
    }
}

/* For very small screens */
@media (max-width: 480px) {
    div[style*="width: 100%"][style*="height: 400px"][style*="background: linear-gradient"] {
        width: calc(100% - 24px) !important;
        margin: 12px !important;
        min-height: 250px !important;
        padding: 30px 15px !important;
    }
    
    div[style*="width: 100%"][style*="height: 400px"] > div:first-child {
        font-size: 2.5rem !important;
    }
    
    div[style*="width: 100%"][style*="height: 400px"] > div:nth-child(2) {
        font-size: 18px !important;
    }
    
    div[style*="width: 100%"][style*="height: 400px"] > div:last-child {
        font-size: 13px !important;
    }
}

/* Hide KPIs/stats on mobile */
@media (max-width: 768px) {
    .stats,
    #stats {
        display: none !important;
    }
}


/* Hide drag and drop text on mobile */
@media (max-width: 768px) {
    .drop-zone-title,
    h3.drop-zone-title {
        display: none !important;
    }
    
    /* Adjust padding since we're removing the title */
    .upload-area {
        padding: 2rem 1rem !important;
    }
}






/* Freshness filter styles */
.node.freshness-highlight circle {
    stroke-width: 3px !important;
    filter: drop-shadow(0 0 8px currentColor);
}

.node.freshness-fade circle {
    opacity: 0.2;
}

.node.freshness-fade text {
    opacity: 0.3;
}

/* Don't fade highlighted nodes */
.node.freshness-highlight.freshness-fade circle,
.node.freshness-highlight.freshness-fade text {
    opacity: 1;
}



/* Remove top spacing in dashboard view */
#treeContainer {
    transition: margin-top 0.3s ease;
}


/* Mobile specific adjustments */
@media (max-width: 768px) {
    body[data-view="dashboard"] #treeContainer {
        margin-top: -20px !important;
        padding-top: 0 !important;
        padding-bottom: 80px; /* Less space needed on mobile */
    }
    
    .dashboard {
        padding-top: 15px !important;
    }
}



/* Smooth transitions for view switching */
#stats, #colourLegend {
    transition: all 0.3s ease;
    overflow: hidden;
}

/* Force remove space in dashboard view */
body[data-view="dashboard"] #stats,
body[data-view="dashboard"] #colourLegend {
    position: absolute !important;
    left: -9999px !important;
    height: 0 !important;
    margin: 20 !important;
    padding: 0 !important;
}

/* Ensure dashboard starts at top on mobile */
@media (max-width: 768px) {
    body[data-view="dashboard"] .dashboard {
        margin-top: -20px !important; /* Negative margin to pull it up */
    }
}



/* Collapsible stats */
.stats {
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
}


.stats.collapsed {
    height: 40px !important;
    padding: 0 !important;
    margin: 0 !important;
    overflow: hidden;
    position: relative;
    display: flex !important; /* Ensure it stays flex */
    align-items: center;
    justify-content: center;
}


.stats.collapsed .stat-item {
    display: none !important;
}

.stats.collapsed .stats-toggle {
    position: relative;
    margin: 0 auto;
}

/* Optional: Also allow legend to collapse */
.colour-legend.collapsed {
    height: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
    opacity: 0;
    overflow: hidden;
}

/* Stats toggle button */
.stats-toggle {
    position: absolute;
    top: 10px;
    right: 10px;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    padding: 4px 12px;
    cursor: pointer;
    font-size: 0.75rem;
    color: var(--gray-600);
    transition: all 0.2s ease;
    z-index: 10;
    min-width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}


body.dark-theme .stats.collapsed {
    background: var(--gray-800);
}

.stats-toggle:hover {
    background: var(--gray-100);
    border-color: var(--gray-400);
}

body.dark-theme .stats-toggle {
    background: var(--gray-700);
    border-color: var(--gray-600);
    color: var(--gray-300);
}

body.dark-theme .stats-toggle:hover {
    background: var(--gray-600);
}


/* Dark Mode Placeholder Styles */
body.dark-theme .tree-placeholder {
    background: var(--gray-800) !important;
    border-color: var(--gray-700) !important;
    color: var(--gray-100) !important;
}

body.dark-theme .dashboard-placeholder {
    background: linear-gradient(135deg, #374151 0%, #1f2937 100%) !important;
}

/* Style for placeholder text */
body.dark-theme .placeholder-icon {
    filter: brightness(0.8);
}

body.dark-theme .placeholder-title {
    color: var(--gray-100) !important;
}

body.dark-theme .placeholder-subtitle {
    color: var(--gray-400) !important;
}



/* Mobile Action Sheet */
.mobile-action-sheet {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    display: none;
}

.action-sheet-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}

.action-sheet-content {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-radius: 20px 20px 0 0;
    padding: 20px;
    box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
    max-height: 50vh;
    overflow-y: auto;
}

.action-sheet-content h3 {
    margin: 0 0 10px 0;
    color: #1f4788;
}

.action-sheet-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
}

.action-sheet-button {
    padding: 15px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 500;
    text-align: center;
    cursor: pointer;
    text-decoration: none;
    display: block;
    background: #f0f0f0;
    color: #333;
}

.action-sheet-button.primary {
    background: #1f4788;
    color: white;
}

.action-sheet-button.cancel {
    background: transparent;
    color: #666;
}

/* Dark mode support */
body.dark-theme .action-sheet-content {
    background: #1f2937;
    color: #e5e7eb;
}

body.dark-theme .action-sheet-content h3 {
    color: #72A300;
}

body.dark-theme .action-sheet-button {
    background: #374151;
    color: #e5e7eb;
}

body.dark-theme .action-sheet-button.primary {
    background: #72A300;
    color: white;
}

/* Disable enhanced tooltip on mobile */
@media (max-width: 768px) {
    .enhanced-tooltip {
        display: none !important;
    }
}



/* Enhanced Mobile Action Sheet */
.action-sheet-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}

.action-sheet-header h3 {
    margin: 0;
    color: #1f4788;
    font-size: 1.2rem;
    flex: 1;
    margin-right: 10px;
}

/* Mobile Freshness Badge */
.mobile-freshness-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    white-space: nowrap;
}

.freshness-dot {
    font-size: 1.2rem;
    line-height: 1;
}

.freshness-days {
    opacity: 0.8;
    font-weight: 400;
    margin-left: 4px;
}

/* Freshness color schemes */
.mobile-freshness-badge.freshness-new {
    background: #e8f5e8;
    color: #2e7d32;
}

.mobile-freshness-badge.freshness-fresh {
    background: #e8f5e8;
    color: #43a047;
}

.mobile-freshness-badge.freshness-recent {
    background: #fffde7;
    color: #f9a825;
}

.mobile-freshness-badge.freshness-aging {
    background: #fff3e0;
    color: #ef6c00;
}

.mobile-freshness-badge.freshness-old {
    background: #ffebee;
    color: #d32f2f;
}

.mobile-freshness-badge.freshness-stale {
    background: #ffebee;
    color: #b71c1c;
}

/* Metadata section */
.action-sheet-metadata {
    background: #f8f9ff;
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 20px;
}

.metadata-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 0;
    font-size: 0.9rem;
    color: #666;
}

.metadata-item:not(:last-child) {
    border-bottom: 1px solid #e0e0e0;
}

.metadata-icon {
    font-size: 1rem;
    width: 24px;
    text-align: center;
}

/* Updated action buttons */
.action-sheet-button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 15px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 500;
    text-align: center;
    cursor: pointer;
    text-decoration: none;
    background: #f0f0f0;
    color: #333;
    transition: all 0.2s ease;
}

.action-sheet-button span {
    font-size: 1.1rem;
}

.action-sheet-button:active {
    transform: scale(0.98);
}

/* Dark mode updates */
body.dark-theme .action-sheet-header {
    border-bottom-color: #374151;
}

body.dark-theme .action-sheet-header h3 {
    color: #e5e7eb;
}

body.dark-theme .action-sheet-metadata {
    background: #374151;
}

body.dark-theme .metadata-item {
    color: #9ca3af;
    border-bottom-color: #4b5563;
}

/* Dark mode freshness badges */
body.dark-theme .mobile-freshness-badge.freshness-new {
    background: rgba(46, 125, 50, 0.2);
    color: #81c784;
}

body.dark-theme .mobile-freshness-badge.freshness-fresh {
    background: rgba(67, 160, 71, 0.2);
    color: #81c784;
}

body.dark-theme .mobile-freshness-badge.freshness-recent {
    background: rgba(249, 168, 37, 0.2);
    color: #ffd54f;
}

body.dark-theme .mobile-freshness-badge.freshness-aging {
    background: rgba(239, 108, 0, 0.2);
    color: #ffb74d;
}

body.dark-theme .mobile-freshness-badge.freshness-old {
    background: rgba(211, 47, 47, 0.2);
    color: #ef5350;
}

body.dark-theme .mobile-freshness-badge.freshness-stale {
    background: rgba(183, 28, 28, 0.2);
    color: #ef5350;
}

/* Add subtle animation */
@keyframes slideUp {
    from {
        transform: translateY(100%);
    }
    to {
        transform: translateY(0);
    }
}

.action-sheet-content {
    animation: slideUp 0.3s ease;
}



/* Improve touch targets on mobile */
@media (max-width: 768px) {
    .node circle {
        /* Make touch targets bigger on mobile */
        stroke-width: 20px;
        stroke-opacity: 0;
        paint-order: stroke;
    }
    
    .node text {
        pointer-events: none; /* Prevent text from blocking touches */
    }
    
    /* Visible stroke remains normal */
    .node circle::after {
        stroke-width: 2px;
        stroke-opacity: 1;
    }
}

/* Prevent unwanted touch behaviors */
#treeContainer {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    user-select: none;
}


/* Mobile Info Toast */
.mobile-info-toast {
    position: fixed;
    bottom: 100px; /* Above tree controls */
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: white;
    border-radius: 25px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.15);
    padding: 0;
    max-width: 85%;
    min-width: 200px;
    z-index: 1000;
    overflow: hidden;
    animation: slideUp 0.3s ease forwards;
    -webkit-tap-highlight-color: transparent;
}

@keyframes slideUp {
    to {
        transform: translateX(-50%) translateY(0);
    }
}

.toast-content {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    padding: 12px 16px;
    border-left: 5px solid #ddd;  /* Increased from 4px */
}

.toast-title {
    font-weight: 600;
    color: #1f4788;
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
}

.toast-age {
    color: #666;
    font-size: 13px;    /* Increased from 12px */
    font-weight: 600;   /* Made it semi-bold */
    padding: 4px 12px;  /* Slightly more padding */
    background: #f0f0f0;
    border-radius: 12px;
    white-space: nowrap;
}

.toast-link {
    color: #007cb6;
    text-decoration: none;
    font-weight: 600;
    padding: 6px 14px;
    background: #e3f2fd;
    border-radius: 15px;
    font-size: 13px;
    white-space: nowrap;
    transition: all 0.2s ease;
}

.toast-link:active {
    transform: scale(0.95);
    background: #bbdefb;
}

/* All 6 freshness levels for toast */
.toast-content.new { 
    border-left-color: #2e7d32;  /* Dark green */
}
.toast-content.new::before {
    content: '✓';
    color: #2e7d32;
}

.toast-content.fresh { 
    border-left-color: #43a047;  /* Medium green */
}
.toast-content.fresh::before {
    content: '✓';
    color: #43a047;
}

.toast-content.recent { 
    border-left-color: #fdd835;  /* Yellow */
}
.toast-content.recent::before {
    content: '◐';
    color: #f9a825;
}

.toast-content.aging { 
    border-left-color: #fb8c00;  /* Orange */
}
.toast-content.aging::before {
    content: '!';
    color: #fb8c00;
}

.toast-content.old { 
    border-left-color: #e53935;  /* Bright red */
}
.toast-content.old::before {
    content: '⚠';
    color: #e53935;
}

.toast-content.stale { 
    border-left-color: #b71c1c;  /* Dark red */
}
.toast-content.stale::before {
    content: '⚠';
    color: #b71c1c;
}

/* Optional: Add subtle background tints */
.toast-content.new,
.toast-content.fresh {
    background: linear-gradient(to right, rgba(76, 175, 80, 0.05) 0%, transparent 50%);
}

.toast-content.recent {
    background: linear-gradient(to right, rgba(253, 216, 53, 0.05) 0%, transparent 50%);
}

.toast-content.aging {
    background: linear-gradient(to right, rgba(251, 140, 0, 0.05) 0%, transparent 50%);
}

.toast-content.old,
.toast-content.stale {
    background: linear-gradient(to right, rgba(229, 57, 53, 0.05) 0%, transparent 50%);
}

/* Dark mode support */
body.dark-theme .mobile-info-toast {
    background: #1f2937;
    box-shadow: 0 4px 24px rgba(0,0,0,0.4);
}

body.dark-theme .toast-content {
    border-left-color: #374151;
}

body.dark-theme .toast-title {
    color: #e5e7eb;
}

body.dark-theme .toast-age {
    background: #374151;
    color: #9ca3af;
}

body.dark-theme .toast-link {
    background: rgba(114, 163, 0, 0.2);
    color: #72A300;
}

body.dark-theme .toast-link:active {
    background: rgba(114, 163, 0, 0.3);
}

/* Adjust position if tree controls are visible */
.tree-controls + .mobile-info-toast {
    bottom: 120px;
}

/* Smaller toast on very small screens */
@media (max-width: 380px) {
    .mobile-info-toast {
        max-width: 90%;
        bottom: 90px;
    }
    
    .toast-content {
        gap: 8px;
        padding: 10px 12px;
        font-size: 13px;
    }
    
    .toast-title {
        max-width: 140px;
    }
    
    .toast-link {
        padding: 5px 10px;
        font-size: 12px;
    }
}


/* Text hover styles */
.node text {
    transition: all 0.2s ease;
}

.node text:hover {
    fill: #007cb6 !important;
    cursor: help;
}

/* Dark mode text hover */
body.dark-theme .node text:hover {
    fill: #72A300 !important;
}


.search-suggestion:hover,
.search-suggestion.active {
    background: var(--gray-100);
}

#3d-graph-container {
    position: relative !important;
    overflow: visible !important; /* CHANGE: was 'hidden' */
    width: 100% !important;
    height: calc(100vh - 200px) !important;
    min-height: 500px !important;
    overflow: hidden !important;
    background: var(--gray-50);
    display: none;
    z-index: 1 !important;
    margin: 0 !important;
    padding: 0 !important;
    box-sizing: border-box !important;
    margin-top: 20px !important; /* Add some top margin */
}

#3d-graph-container canvas {
    width: 100% !important;
    height: 100% !important;
    display: block !important;
}

/* Optional: Make it responsive like your tree container */
@media (max-width: 768px) {
    #3d-graph-container {
        height: calc(100vh - 160px) !important; /* Less space needed on mobile */
        margin-top: 10px !important;
    }
}


/* Camera Controls */
.camera-controls-3d {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    gap: 10px;
    z-index: 1000;
}

.camera-controls-3d button {
    padding: 8px 16px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}

.camera-controls-3d button:hover {
    background: #4a90e2;
    color: white;
}

/* Node Panel */
.node-panel-3d {
    position: absolute;
    top: 80px;
    right: 20px;
    width: 300px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 1001;
}

.panel-header {
    padding: 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.panel-header h3 {
    margin: 0;
    color: #1f4788;
}

.panel-header button {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #999;
}

.panel-content {
    padding: 15px;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.panel-actions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
}

.panel-actions button {
    flex: 1;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    font-size: 12px;
}

/* Search 3D */
.search-3d {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
}

.search-3d input {
    width: 300px;
    padding: 10px 20px;
    border: 2px solid #ddd;
    border-radius: 25px;
    font-size: 14px;
    outline: none;
}

.search-3d input:focus {
    border-color: #4a90e2;
}

/* Performance Controls */
.perf-controls-3d {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    gap: 15px;
    align-items: center;
    font-size: 14px;
}

/* Dark mode support */
body.dark-theme .camera-controls-3d button,
body.dark-theme .node-panel-3d,
body.dark-theme .search-3d input,
body.dark-theme .perf-controls-3d {
    background: #1f2937;
    color: #e5e7eb;
    border-color: #374151;
}

body.dark-theme #3d-graph-container {
    background: var(--gray-900);
}

/* Ensure dashboard is visible */
body[data-view="dashboard"] #treeContainer {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
}

body[data-view="dashboard"] .dashboard {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
}


/* When 3D view is active, maximize container */
body[data-view="3d"] .container {
    max-width: 100% !important;
}


/* Enhanced dark mode styles for 3D controls */
body.dark-theme .controls-3d {
    background: rgba(31, 41, 55, 0.95) !important;
    color: #e5e7eb !important;
    border: 1px solid rgba(75, 85, 99, 0.3) !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important;
}

body.dark-theme .control-section {
    border-bottom-color: rgba(75, 85, 99, 0.5) !important;
}

body.dark-theme .control-title {
    color: #72A300 !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

body.dark-theme .control-btn {
    background: rgba(55, 65, 81, 0.8) !important;
    color: #e5e7eb !important;
    border: 1px solid rgba(75, 85, 99, 0.5) !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

body.dark-theme .control-btn:hover {
    background: #72A300 !important;
    color: white !important;
    border-color: #72A300 !important;
    box-shadow: 0 2px 8px rgba(114, 163, 0, 0.3) !important;
}

body.dark-theme .control-btn.active {
    background: #72A300 !important;
    color: white !important;
    border-color: #5a8200 !important;
}

body.dark-theme .control-input {
    background: rgba(31, 41, 55, 0.8) !important;
    border: 1px solid rgba(75, 85, 99, 0.5) !important;
    color: #e5e7eb !important;
}

body.dark-theme .control-input:focus {
    border-color: #72A300 !important;
    box-shadow: 0 0 0 3px rgba(114, 163, 0, 0.2) !important;
}

body.dark-theme .control-input::placeholder {
    color: rgba(156, 163, 175, 0.6) !important;
}

body.dark-theme .minimize-btn {
    color: #9ca3af !important;
    background: rgba(55, 65, 81, 0.5) !important;
    border-radius: 4px !important;
    width: 24px !important;
    height: 24px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

body.dark-theme .minimize-btn:hover {
    background: rgba(75, 85, 99, 0.8) !important;
    color: #e5e7eb !important;
}

body.dark-theme .node-details-3d {
    background: rgba(31, 41, 55, 0.95) !important;
    color: #e5e7eb !important;
    border: 1px solid rgba(75, 85, 99, 0.3) !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important;
}

body.dark-theme .node-details-3d h3 {
    color: #72A300 !important;
}

body.dark-theme .node-details-3d a {
    background: #72A300 !important;
    border-color: #5a8200 !important;
}

body.dark-theme .node-details-3d a:hover {
    background: #5a8200 !important;
}

/* Dark mode scrollbar for controls */
body.dark-theme .controls-3d::-webkit-scrollbar {
    width: 8px;
}

body.dark-theme .controls-3d::-webkit-scrollbar-track {
    background: rgba(31, 41, 55, 0.5);
    border-radius: 4px;
}

body.dark-theme .controls-3d::-webkit-scrollbar-thumb {
    background: rgba(75, 85, 99, 0.8);
    border-radius: 4px;
}

body.dark-theme .controls-3d::-webkit-scrollbar-thumb:hover {
    background: rgba(107, 114, 128, 0.9);
}

/* Dark mode for control slider */
body.dark-theme .control-slider {
    background: rgba(75, 85, 99, 0.3) !important;
}

body.dark-theme .control-slider::-webkit-slider-thumb {
    background: #72A300 !important;
}

body.dark-theme .control-slider::-moz-range-thumb {
    background: #72A300 !important;
}

/* Dark mode for checkboxes */
body.dark-theme .control-label input[type="checkbox"] {
    accent-color: #72A300;
}

/* Stats display in dark mode */
body.dark-theme #3d-graph-container > div[style*="bottom: 20px"] {
    background: rgba(31, 41, 55, 0.9) !important;
    color: #e5e7eb !important;
    border: 1px solid rgba(75, 85, 99, 0.3) !important;
}

/* Mobile dark mode enhancements */
@media (max-width: 768px) {
    body.dark-theme .mobile-handle {
        background: rgba(75, 85, 99, 0.8) !important;
    }
    
    body.dark-theme .mobile-fab {
        background: #72A300 !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5) !important;
    }
    
    body.dark-theme #mobileBackFab {
        background: rgba(75, 85, 99, 0.9) !important;
    }
}



/* Add this CSS to your styles section */
#3d-graph-container {
    position: relative !important;
    overflow: hidden !important; /* Prevent labels from overflowing */
}

#labels3d {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    pointer-events: none !important;
    overflow: hidden !important;
}

.node-label-3d {
    position: absolute !important;
    transform-origin: center bottom;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

/* Ensure labels don't appear when 3D view is hidden */
body:not([data-view="3d"]) #labels3d {
    display: none !important;
}

/* Prevent labels from appearing outside container on mobile */
@media (max-width: 768px) {
    #3d-graph-container {
        position: fixed !important;
        top: 0;
        left: 0;
        width: 100vw !important;
        height: 100vh !important;
        overflow: hidden !important;
    }
}


// Add this CSS to your styles:
.node-label-3d::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 2px;
    height: 8px;
    background: currentColor;
    opacity: 0.6;
}



/* Fix dark theme for tree visualization */
body.dark-theme .node text {
    fill: #ffffff !important;
    opacity: 1 !important; /* Override the 0.3 opacity that's making text faint */
}

body.dark-theme .node circle {
    stroke: #374151 !important;
    stroke-width: 2px !important;
}

body.dark-theme .link {
    stroke: #4b5563 !important;
    stroke-opacity: 0.6 !important;
}

body.dark-theme #treeContainer {
    background: var(--gray-900) !important;
}

body.dark-theme #treeContainer svg {
    background: var(--gray-900) !important;
}

/* Fix search highlights in dark mode */
body.dark-theme .node.search-result circle {
    stroke: #ff6b6b !important;
}

body.dark-theme .node.search-current circle {
    stroke: #4ecdc4 !important;
}

/* Fix legend highlights in dark mode */
body.dark-theme .node.legend-highlight circle {
    filter: drop-shadow(0 0 10px currentColor) !important;
}

body.dark-theme .node.legend-fade circle {
    opacity: 0.2 !important;
}

body.dark-theme .node.legend-fade text {
    opacity: 0.3 !important;
}

body.dark-theme .node.legend-highlight.legend-fade circle,
body.dark-theme .node.legend-highlight.legend-fade text {
    opacity: 1 !important;
}


/* Add this to the mobile CSS section */
.mobile-control-grid.three-col .control-btn.active {
    background: #007cb6 !important;
    color: white !important;
    border-color: #005a87 !important;
}

body.dark-theme .mobile-control-grid.three-col .control-btn.active {
    background: #72A300 !important;
    color: white !important;
    border-color: #5a8200 !important;
}


@media (max-width: 768px) {
    /* Ensure mobile control grids work properly */
    .mobile-control-grid {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
        margin-bottom: 20px !important;
        width: 100% !important;
    }
    
    .mobile-control-grid.three-col {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 8px !important; /* Smaller gap for 3 columns */
    }
    
    /* Make control buttons more visible */
    .control-btn {
        min-height: 60px !important; /* Taller for easier tapping */
        padding: 8px 4px !important;
        font-size: 12px !important;
        border-radius: 12px !important;
        margin-bottom: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 6px !important;
        background: #f8f9ff !important;
        border: 2px solid #e0e0e0 !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }
    
    .control-btn:active {
        transform: scale(0.95) !important;
        background: #007cb6 !important;
        color: white !important;
    }
    
    .control-btn-icon {
        font-size: 20px !important;
        line-height: 1 !important;
    }
    
    .control-btn-text {
        font-size: 10px !important;
        line-height: 1.2 !important;
        font-weight: 600 !important;
    }
    
    /* Dark theme for control buttons */
    body.dark-theme .control-btn {
        background: #374151 !important;
        border-color: #4b5563 !important;
        color: #e5e7eb !important;
    }
    
    body.dark-theme .control-btn:active {
        background: #72A300 !important;
        color: white !important;
    }
}


@media (max-width: 768px) {
    /* Fix mobile controls scrolling */
    .mobile-control-content {
        padding: 15px 20px 30px !important; /* Extra bottom padding */
        max-height: calc(80vh - 120px) !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important; /* Smooth iOS scrolling */
        scrollbar-width: thin !important; /* Firefox */
    }
    
    /* Custom scrollbar for webkit browsers */
    .mobile-control-content::-webkit-scrollbar {
        width: 6px !important;
    }
    
    .mobile-control-content::-webkit-scrollbar-track {
        background: #f1f1f1 !important;
        border-radius: 3px !important;
    }
    
    .mobile-control-content::-webkit-scrollbar-thumb {
        background: #007cb6 !important;
        border-radius: 3px !important;
    }
    
    .mobile-control-content::-webkit-scrollbar-thumb:hover {
        background: #005a87 !important;
    }
    
    /* Add scroll indicator */
    .mobile-control-content::after {
        content: '⬇️ Scroll for more options';
        position: sticky;
        bottom: 0;
        display: block;
        text-align: center;
        padding: 10px;
        background: linear-gradient(transparent, rgba(255,255,255,0.9));
        font-size: 12px;
        color: #666;
        pointer-events: none;
    }
    
    body.dark-theme .mobile-control-content::after {
        background: linear-gradient(transparent, rgba(31,41,55,0.9));
        color: #9ca3af;
    }
}

@media (max-width: 768px) {
    .controls-3d {
        max-height: 90vh !important; /* Increase from 80vh */
        transform: translateY(calc(100% - 70px)) !important; /* Show more of the handle */
    }
    
    .mobile-control-content {
        max-height: calc(90vh - 140px) !important; /* Adjust accordingly */
    }
}

    </style>
</head>
<body>

    <div class="container">
        <div class="header" style="position: relative;">
   			 <div class="header-content">
                <div class="header-left">
                    
                    
                    <div class="header-text">
                        <h1>Sitemap Visualizer</h1>
                        <p>Upload your XML sitemap to create interactive visualisations and analytics</p>
                    </div>
                </div>
               
            </div>
            
        </div>
        
         <!-- Modern Navigation Bar -->
       <!-- Modern Navigation Bar -->
<div class="nav-bar" id="navBar">
    <!-- Mobile menu button (only visible on mobile) -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">
        <span></span>
        <span></span>
        <span></span>
    </button>
    
    <!-- Desktop: Upload toggle (hidden on mobile) -->
    <button class="nav-btn upload-toggle" id="uploadToggleBtn" onclick="toggleUploadSection()" data-mobile-icon="📤">
        <span class="upload-toggle-text">Hide Upload</span>
        <span class="upload-chevron">▲</span>
    </button>
    
    <div class="nav-separator"></div>
    
    <!-- Desktop nav group (hidden on mobile) -->
    <div class="nav-group">
        <button class="nav-btn" id="treeViewBtn">
            <span>Tree View</span>
        </button>
        <button class="nav-btn" id="dashboardViewBtn" data-mobile-icon="📊">
            <span>Dashboard</span>
        </button>
        
        
        <!-- ADD THIS NEW BUTTON -->
    <button class="nav-btn" id="3dViewBtn" onclick="show3DView()">
        <span>3D View</span>
    </button>
        
        <div class="nav-separator"></div>
        
        <div class="nav-dropdown" id="reportsDropdown">
            <button class="nav-btn nav-dropdown-btn" onclick="toggleReportsDropdown()" data-mobile-icon="📋">
                <span>Reports</span>
            </button>
            <div class="nav-dropdown-menu">
                <div class="nav-dropdown-item" onclick="showContentFreshnessAnalysis(); closeReportsDropdown();">
                    Content Freshness
                </div>
                <div class="nav-dropdown-item" onclick="showCategoryBreakdown(); closeReportsDropdown();">
                    Category Breakdown
                </div>
                <div class="nav-dropdown-item" onclick="showURLPatternAnalysis(); closeReportsDropdown();">
                    URL Patterns
                </div>
            </div>
        </div>
    </div>
    
    <!-- Search (visible on all screen sizes) -->
    <div class="nav-search">
        <input type="text" 
               id="navSearchInput" 
               placeholder="Search pages..." 
               autocomplete="off" />
               <div class="search-suggestions" id="searchSuggestions"></div>
    </div>
    
    <!-- Theme toggle (visible on all screen sizes) -->
    <button class="nav-btn nav-theme-btn" onclick="toggleTheme()" aria-label="Toggle dark theme">
        <span id="themeIcon">🌙</span>
    </button>
    
    <!-- Mobile menu (slides in from left) -->
    <div class="mobile-nav-menu">
        <div class="mobile-nav-section">
            <button class="mobile-nav-item" onclick="toggleUploadSection(); closeMobileMenu();">
                <span style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <span>Upload Section</span>
                    <span class="upload-chevron">▲</span>
                </span>
            </button>
        </div>
        
        <div class="mobile-nav-section">
            <h3>Views</h3>
            <button class="mobile-nav-item active" id="mobileTreeBtn" onclick="switchView('tree'); closeMobileMenu();">
                Tree View
            </button>
            <button class="mobile-nav-item" id="mobileDashboardBtn" onclick="switchView('dashboard'); closeMobileMenu();">
                Dashboard
            </button>
                        <button class="mobile-nav-item" id="mobileDashboardBtn" onclick="show3DView(); closeMobileMenu();">
                3D View
            </button>
        </div>
        
        <div class="mobile-nav-section">
            <h3>Reports</h3>
            <button class="mobile-nav-item" onclick="showContentFreshnessAnalysis(); closeMobileMenu();">
                Content Freshness
            </button>
            <button class="mobile-nav-item" onclick="showCategoryBreakdown(); closeMobileMenu();">
                Category Breakdown
            </button>
            <button class="mobile-nav-item" onclick="showURLPatternAnalysis(); closeMobileMenu();">
                URL Patterns
            </button>
        </div>
    </div>
    
    <!-- Overlay -->
    <div class="mobile-menu-overlay" onclick="closeMobileMenu()"></div>
</div>
        
        
        
        
        

        <div class="upload-section">
            <div class="upload-container">
            
            
              <div class="upload-card">
                    <h2 class="quick-access-title">Quick Access</h2>
                    <div class="quick-access-grid">
                        <button class="quick-access-btn" onclick="loadQuickSite('https://www.citizensinformation.ie/sitemap.xml')">
                            <div class="site-logo">
                                <img src="data:image/png;base64,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" 
         alt="CI Logo"  style="height: 3.5rem;">
                            </div>
                            <div class="site-name"><b>Citizens Information</b></div>
                        </button>
                        
                        <button class="quick-access-btn" onclick="loadQuickSite('https://www.citizensinformationboard.ie/sitemap.xml')">
                            <div class="site-logo">
                                <img src="data:image/png;base64,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" 
         alt="CI Logo"  style="height: 3.5rem; ">
                            </div>
                            <div class="site-name"><b>Citizens Information Board</b></div>
                        </button>
                        
                        <button class="quick-access-btn" onclick="loadQuickSite('https://www.mabs.ie/sitemap.xml')">
                            <div class="site-logo">
                                <img src="data:image/png;base64,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" alt="MABS Logo" style="height: 3.5rem; ">
                            </div>
                            <div class="site-name"><b>MABS</b></div>
                        </button>
                    </div>
                </div>
            
            
            
                <div class="upload-card">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">📁</div>
                       <h3 class="drop-zone-title">Drop sitemap.xml here</h3>
                        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                            Choose File
                        </button>
                        <input type="file" id="fileInput" class="file-input" accept=".xml" style="display: none;" />
                    </div>
                </div>
                
                
                
                
                <div class="upload-card">
                    <h2 class="quick-access-title">Load from URL</h2>
                    <div class="url-input-wrapper">
                        <input type="url" id="urlInput" class="url-input" placeholder="https://example.com/sitemap.xml" />
                    </div>
                    <button class="upload-btn" onclick="loadFromURL()" style="width: 100%; margin-top: 1rem;">
                        Load Sitemap
                    </button>
                </div>
                
                
                
               
                
                
            </div>
        </div>
        
        
        
       
        
        
        
        
        

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText" style="color: var(--gray-700); font-weight: 500;">Processing your sitemap...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-item">
                <div class="stat-number" id="totalPages">0</div>
                <div class="stat-label">Total Pages</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="mainCategories">0</div>
                <div class="stat-label">Main Categories</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="maxDepth">0</div>
                <div class="stat-label">Max Depth</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="avgDepth">0</div>
                <div class="stat-label">Avg Depth</div>
            </div>
        </div>

        <div class="colour-legend" id="colourLegend" style="display: none;">
            <!-- Legend items will be dynamically generated -->
        </div>
        
        <div class="breadcrumb-container" id="breadcrumbContainer">
            <div class="breadcrumb" id="breadcrumb">
                <!-- Breadcrumb items will be dynamically added here -->
            </div>
        </div>

        <!-- Replace your existing tree-container with this -->
<div class="visualization-wrapper">
    <div class="tree-container" id="treeContainer">
        <!-- Visualisation will be rendered here -->
    </div>
    
    <div id="3d-graph-container" style="display: none;"></div>
</div>

        <div class="controls" id="controls" style="display: none;">
            <div class="controls-inner">
                <div class="search-wrapper">
                    <input type="text" 
                           class="search-input" 
                           id="searchInput" 
                           placeholder="Search pages..." 
                           autocomplete="off" />
                    
                    <div class="search-navigation" id="searchNavigation">
                        <button class="search-nav-btn" id="searchPrevBtn" onclick="navigateToPreviousResult()" title="Previous result (Shift+Enter)">
                            ↑
                        </button>
                        <button class="search-nav-btn" id="searchNextBtn" onclick="navigateToNextResult()" title="Next result (Enter)">
                            ↓
                        </button>
                    </div>
                    
                    <div class="search-results-info" id="searchResultsInfo"></div>
                    
                    <button class="search-clear" id="searchClearBtn" onclick="clearSearch()" aria-label="Clear search">
                        ✕
                    </button>
                    
                    <div class="search-suggestions" id="searchSuggestions"></div>
                </div>

                
                
                
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Global variables
        let treeData = null;
        let svg, g, root, tree, tooltip;
        let width = 1120, height = 600;
        let allNodes = [];
        let isMobile = window.innerWidth <= 768;
        let i = 0;
        let maxSiteDepth = 0;
        let currentView = 'tree';
        let isDarkTheme = false;
        let siteStats = null;
        let siteAnalysis = null;
        let globalZoom = null; // Store zoom behavior globally
        let searchTimeout = null;

        // Search variables
        let searchResults = [];
        let currentResultIndex = -1;
        let searchInitialized = false;
        let freshnessViewEnabled = false;
        let activeFreshnessFilter = null;
        let tooltipMouseOver = false;
let hideTooltipTimeout = null;
let is3DViewActive = false;
let flyThroughTimeout = null;
let isMobile3D = false;
let touchStartDistance = 0;
let labels3DUpdateInterval = null;

// At the top with global variables
// Better mobile detection that runs immediately


// Function to clean up 3D labels
window.cleanup3DLabels = function() {
    // Clear any update intervals
    if (labels3DUpdateInterval) {
        cancelAnimationFrame(labels3DUpdateInterval);
        labels3DUpdateInterval = null;
    }
    
    // Remove labels container
    const labelsContainer = document.getElementById('labels3d');
    if (labelsContainer) {
        labelsContainer.remove();
    }
    
    // Remove any style tags we added
    const labelStyles = document.getElementById('labels3d-styles');
    if (labelStyles) {
        labelStyles.remove();
    }
}

// Function to add persistent labels to 3D visualization
function addPersistentLabels() {
    // Clean up any existing labels first
    window.cleanup3DLabels();
    
    // Safety checks
    if (!Graph3D || !graphData || !is3DViewActive) {
        console.warn('Cannot add labels - 3D graph not ready');
        return;
    }
    
    const container = document.getElementById('3d-graph-container');
    if (!container) {
        console.warn('No 3D container found');
        return;
    }
    
    // Create labels container
    const labelsContainer = document.createElement('div');
    labelsContainer.id = 'labels3d';
    labelsContainer.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 100;
        overflow: hidden;
    `;
    container.appendChild(labelsContainer);
    
    // Add styles if not already present
    if (!document.getElementById('labels3d-styles')) {
        const style = document.createElement('style');
        style.id = 'labels3d-styles';
        style.textContent = `
            .node-label-3d {
                position: absolute;
                color: white;
                font-weight: bold;
                text-shadow: 
                    -2px -2px 4px rgba(0,0,0,0.9),
                    2px -2px 4px rgba(0,0,0,0.9),
                    -2px 2px 4px rgba(0,0,0,0.9),
                    2px 2px 4px rgba(0,0,0,0.9),
                    0 0 8px rgba(0,0,0,1);
                pointer-events: none;
                text-align: center;
                font-family: Arial, sans-serif;
                white-space: nowrap;
                user-select: none;
                transition: opacity 0.2s ease;
                z-index: 1000;
            }
            .node-label-3d.root {
                font-size: 18px;
                color: #ff6b6b;
                font-weight: 900;
                z-index: 1001;
            }
            .node-label-3d.level1 {
                font-size: 14px;
                color: #4ecdc4;
                font-weight: 700;
                z-index: 1000;
            }
            .node-label-3d.level2 {
                font-size: 12px;
                color: #ffe66d;
                font-weight: 600;
                z-index: 999;
            }
            /* Remove level3 and level4 styles - we won't show these anymore */
            .node-label-3d.hidden {
                opacity: 0;
            }
            
            /* Dark mode support */
            body.dark-theme .node-label-3d {
                text-shadow: 
                    -2px -2px 4px rgba(0,0,0,1),
                    2px -2px 4px rgba(0,0,0,1),
                    -2px 2px 4px rgba(0,0,0,1),
                    2px 2px 4px rgba(0,0,0,1),
                    0 0 10px rgba(0,0,0,1);
            }
        `;
        document.head.appendChild(style);
    }
    
    // Create label elements for important nodes
    const labelElements = new Map();
    
    // UPDATED: Reduce the maximum depth for labels by 1
    const maxLabelDepth = graphData.nodes.length > 500 ? 1 : 
                         graphData.nodes.length > 200 ? 2 : 3; // Reduced each by 1
    const nodesToLabel = graphData.nodes.filter(node => node.depth <= maxLabelDepth);
    
    console.log(`Creating labels for ${nodesToLabel.length} nodes (max depth: ${maxLabelDepth})`);
    
    nodesToLabel.forEach(node => {
        const label = document.createElement('div');
        label.className = `node-label-3d ${
            node.depth === 0 ? 'root' : 
            node.depth === 1 ? 'level1' : 
            node.depth === 2 ? 'level2' : 
            'level3' // This will rarely be used now
        }`;
        label.textContent = node.name;
        label.style.opacity = '0'; // Start hidden
        labelsContainer.appendChild(label);
        labelElements.set(node.id, label);
    });
    
    // Function to update label positions
    function updateLabels() {
        if (!Graph3D || !is3DViewActive) {
            if (labels3DUpdateInterval) {
                cancelAnimationFrame(labels3DUpdateInterval);
                labels3DUpdateInterval = null;
            }
            return;
        }
        
        const camera = Graph3D.camera();
        const container = document.getElementById('3d-graph-container');
        if (!container || !camera) {
            labels3DUpdateInterval = requestAnimationFrame(updateLabels);
            return;
        }
        
        const rect = container.getBoundingClientRect();
        const cameraDistance = camera.position.length();
        
        // Get the renderer and scene for proper coordinate transformation
        const renderer = Graph3D.renderer();
        const scene = Graph3D.scene();
        
        labelElements.forEach((label, nodeId) => {
            const node = graphData.nodes.find(n => n.id === nodeId);
            if (!node) {
                label.style.opacity = '0';
                return;
            }
            
            // Get node's position in 3D space
            let nodePos;
            if (node.__threeObj && node.__threeObj.position) {
                nodePos = node.__threeObj.position.clone();
            } else if (node.x !== undefined && node.y !== undefined && node.z !== undefined) {
                nodePos = new THREE.Vector3(node.x, node.y, node.z);
            } else {
                label.style.opacity = '0';
                return;
            }
            
            // Calculate distance from camera
            const distanceFromCamera = nodePos.distanceTo(camera.position);
            
            // Hide labels that are too far away
            const maxDistance = cameraDistance * 1.5;
            if (distanceFromCamera > maxDistance) {
                label.style.opacity = '0';
                return;
            }
            
            // Project 3D position to 2D screen coordinates
            const vector = nodePos.clone();
            vector.project(camera);
            
            // Convert to screen coordinates
            const x = (vector.x * 0.5 + 0.5) * rect.width;
            const y = (-vector.y * 0.5 + 0.5) * rect.height;
            
            // Check if node is behind camera
            if (vector.z > 1) {
                label.style.opacity = '0';
                return;
            }
            
            // Position the label
            label.style.left = `${x}px`;
			label.style.top = `${y}px`;
		label.style.transform = 'translate(-50%, -120%)';  // Position above node
            
            // Calculate opacity based on distance
            const fadeStart = maxDistance * 0.5;
            const fadeEnd = maxDistance;
            let opacity = 1;
            
            if (distanceFromCamera > fadeStart) {
                opacity = 1 - ((distanceFromCamera - fadeStart) / (fadeEnd - fadeStart));
            }
            
            // Additional check for nodes that are too close to camera edges
            const margin = 50;
            if (x < margin || x > rect.width - margin || y < margin || y > rect.height - margin) {
                opacity *= 0.3;
            }
            
            label.style.opacity = Math.max(0, Math.min(1, opacity));
            
            // Optional: Scale based on distance
            const scale = Math.max(0.7, Math.min(1.5, cameraDistance / (distanceFromCamera * 2)));
            const baseSize = node.depth === 0 ? 18 : node.depth === 1 ? 14 : 12;
            label.style.fontSize = `${baseSize * scale}px`;
        });
        
        labels3DUpdateInterval = requestAnimationFrame(updateLabels);
    }
    
    // Start updating labels
    console.log('Starting label update loop');
    updateLabels();
}

// Function to toggle 3D labels
// Replace the existing toggleLabels3D function
function toggleLabels3D() {
    const labelsContainer = document.getElementById('labels3d');
    const checkbox = document.querySelector('input[onchange="toggleLabels3D()"]');
    
    if (labelsContainer) {
        // If labels exist, toggle their visibility
        if (labelsContainer.style.display === 'none') {
            labelsContainer.style.display = 'block';
            if (!labels3DUpdateInterval && is3DViewActive) {
                addPersistentLabels();
            }
            if (checkbox) checkbox.checked = true;
        } else {
            labelsContainer.style.display = 'none';
            if (labels3DUpdateInterval) {
                cancelAnimationFrame(labels3DUpdateInterval);
                labels3DUpdateInterval = null;
            }
            if (checkbox) checkbox.checked = false;
        }
    } else {
        // If no labels exist, create them
        if (is3DViewActive) {
            addPersistentLabels();
            if (checkbox) checkbox.checked = true;
        }
    }
}

document.getElementById('treeViewBtn').onclick = function() {
    if (currentView !== 'tree') {
        switchView('tree');
    }
};


function checkIfMobile() {
    const userAgent = navigator.userAgent.toLowerCase();
    const isMobileUA = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
    const isSmallScreen = window.innerWidth <= 768;
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    
    return isMobileUA || (isSmallScreen && isTouchDevice);
}

// Set it immediately
isMobile = checkIfMobile();

// Update dimensions based on mobile state
function updateDimensions() {
    const container = document.getElementById('treeContainer');
    if (!container) return;
    
    // Update mobile state
    isMobile = checkIfMobile();
    
    const containerRect = container.getBoundingClientRect();
    const padding = window.innerWidth <= 480 ? 20 : window.innerWidth <= 768 ? 30 : 80;
    
    if (isMobile) {
        width = Math.max(300, containerRect.width - padding);
        height = Math.max(500, Math.min(window.innerHeight * 0.7, 800));
    } else {
        width = Math.max(800, containerRect.width - padding);
        height = 700;
    }
    
    if (window.innerWidth <= 480) {
        width = Math.min(width, window.innerWidth - 10);
    }
}

// Update isMobile when needed
window.addEventListener('resize', function() {
    isMobile = checkIfMobile();
});

// Initial check
isMobile = checkIfMobile();
        
        
        // Enhanced tooltip/popup functionality
function createEnhancedTooltip() {
    // Remove old enhanced tooltip if exists
    d3.select("#enhancedTooltip").remove();
    
    // Create new enhanced tooltip
    const tooltip = d3.select("body")
        .append("div")
        .attr("id", "enhancedTooltip")
        .attr("class", "enhanced-tooltip")
        .style("opacity", 0);
    
    return tooltip;
}

// Initialize enhanced tooltip variable
let enhancedTooltip = null;
let tooltipTimeout = null;

        // Colour scheme
        const colourScheme = {
            home: '#1f4788',
            language: '#2d5aa0', 
            category: '#4a90e2',
            section: '#7fb069',
            page: '#52734d'
        };



		// Upload section collapse functionality
function toggleUploadSection() {
    const uploadSection = document.querySelector('.upload-section');
    const toggleBtn = document.getElementById('uploadToggleBtn');
    const toggleText = toggleBtn?.querySelector('.upload-toggle-text');
    const chevron = toggleBtn?.querySelector('.upload-chevron');
    
    if (uploadSection) {
        uploadSection.classList.toggle('collapsed');
        const isCollapsed = uploadSection.classList.contains('collapsed');
        
        if (toggleBtn) {
            toggleBtn.classList.toggle('collapsed');
            if (toggleText) {
                toggleText.textContent = isCollapsed ? 'Show Sitemap Upload' : 'Hide Sitemap Upload';
            }
            if (chevron) {
                chevron.style.transform = isCollapsed ? 'rotate(180deg)' : 'rotate(0deg)';
            }
        }
        
        
        
        if (!isCollapsed) {
            uploadSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
}
setTimeout(adjustScrollAfterToggle, 100);




// Add scroll effect to nav bar
window.addEventListener('scroll', function() {
    const navBar = document.getElementById('navBar');
    if (navBar) {
        if (window.scrollY > 50) {
            navBar.classList.add('scrolled');
        } else {
            navBar.classList.remove('scrolled');
        }
    }
});




function toggleMobileMenu() {
    const navBar = document.getElementById('navBar');
    if (navBar) {
        navBar.classList.toggle('menu-open');
    }
}

function closeMobileMenu() {
    const navBar = document.getElementById('navBar');
    if (navBar) {
        navBar.classList.remove('menu-open');
    }
}

// Add overlay div
const overlay = document.createElement('div');
overlay.className = 'mobile-menu-overlay';
overlay.onclick = closeMobileMenu;
document.querySelector('.nav-bar').appendChild(overlay);






// Auto-collapse upload section after successful load
function autoCollapseUploadSection() {
    const uploadSection = document.querySelector('.upload-section');
    const toggleBtn = document.getElementById('uploadToggleBtn');
    const toggleText = toggleBtn?.querySelector('.upload-toggle-text');
    
    // Only collapse if it's currently expanded
    if (uploadSection && !uploadSection.classList.contains('collapsed')) {
        // Add a small delay for better UX (let user see the load happened)
        setTimeout(() => {
            uploadSection.classList.add('collapsed');
            if (toggleBtn) {
                toggleBtn.classList.add('collapsed');
                if (toggleText) toggleText.textContent = 'Show Sitemap Upload';
            }
            localStorage.setItem('uploadSectionCollapsed', 'true');
            
            // Ensure nav bar is visible since the upload toggle is now part of it
            const navBar = document.getElementById('navBar');
            if (navBar) {
                navBar.style.display = 'flex';
            }
            
            // Smooth scroll to stats if needed
            setTimeout(() => {
                const stats = document.getElementById('stats');
                if (stats) {
                    stats.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300);
        }, 500); // 500ms delay so user sees the upload success
    }
}

// Initialize upload section state on page load
function initializeUploadSection() {
    // Always start with upload section expanded
    const uploadSection = document.querySelector('.upload-section');
    const toggleBtn = document.getElementById('uploadToggleBtn');
    const toggleText = toggleBtn?.querySelector('.upload-toggle-text');
    
    if (uploadSection && toggleBtn) {
        uploadSection.classList.remove('collapsed');
        toggleBtn.classList.remove('collapsed');
        if (toggleText) toggleText.textContent = 'Hide Sitemap Upload';
    }
}

// Add keyboard support
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + U to toggle upload section
    if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
        e.preventDefault();
        toggleUploadSection();
    }
});




// Reports dropdown functionality
function toggleReportsDropdown() {
    const dropdown = document.getElementById('reportsDropdown');
    dropdown.classList.toggle('open');
    
    // Close on outside click
    if (dropdown.classList.contains('open')) {
        setTimeout(() => {
            document.addEventListener('click', closeReportsDropdownOnOutside);
        }, 10);
    }
}




function closeReportsDropdown() {
    const dropdown = document.getElementById('reportsDropdown');
    dropdown.classList.remove('open');
    document.removeEventListener('click', closeReportsDropdownOnOutside);
}

function closeReportsDropdownOnOutside(e) {
    const dropdown = document.getElementById('reportsDropdown');
    if (!dropdown.contains(e.target)) {
        closeReportsDropdown();
    }
}





// Add this function to properly clean up labels
window.cleanup3DLabels = function() {
    // Clear any update intervals
    if (labels3DUpdateInterval) {
        cancelAnimationFrame(labels3DUpdateInterval);
        labels3DUpdateInterval = null;
    }
    
    // Remove labels container
    const labelsContainer = document.getElementById('labels3d');
    if (labelsContainer) {
        labelsContainer.remove();
    }
    
    // Remove any style tags we added
    const labelStyles = document.getElementById('labels3d-styles');
    if (labelStyles) {
        labelStyles.remove();
    }
}







// Adjust scroll position when toggling
function adjustScrollAfterToggle() {
    const uploadSection = document.querySelector('.upload-section');
    const isCollapsed = uploadSection.classList.contains('collapsed');
    
    if (isCollapsed) {
        // Scroll to header if we're near the upload section
        const headerBottom = document.querySelector('.header').getBoundingClientRect().bottom;
        if (window.scrollY < headerBottom + 200) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
}






        // Utility functions
        function formatDate(date) {
    if (!date || !(date instanceof Date) || isNaN(date.getTime())) return 'N/A';
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

        function formatNodeName(name) {
            return name
                .replace(/-/g, ' ')
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase())
                .replace(/\.(html|php|asp|jsp)$/i, '');
        }

        function getNodeColour(d) {
    // If freshness view is enabled
    if (freshnessViewEnabled) {
        // Check if node has lastModified date
        if (d.data && d.data.lastModified) {
            const now = new Date();
            const lastMod = new Date(d.data.lastModified);
            const daysSince = Math.floor((now - lastMod) / (1000 * 60 * 60 * 24));
            
            // More distinct color scale
            if (daysSince < 30) return '#2e7d32';        // New - Dark green
            if (daysSince < 90) return '#43a047';        // Fresh - Medium green  
            if (daysSince < 180) return '#fdd835';       // Recent - Bright yellow
            if (daysSince < 365) return '#fb8c00';       // Aging - Bright orange
            if (daysSince < 730) return '#e53935';       // Old - Bright red
            return '#b71c1c';                             // Stale - Dark red
        } else {
            // No date information - show in gray
            return '#9e9e9e';
        }
    }
    
    // Default depth-based coloring
    if (d.depth === 0) return colourScheme.home;
    if (d.depth === 1) return colourScheme.language;
    if (d.depth === 2) return colourScheme.category;
    if (d.children || d._children) return colourScheme.section;
    return colourScheme.page;
}

        function updateDimensions() {
            const container = document.getElementById('treeContainer');
            if (!container) return;
            
            const containerRect = container.getBoundingClientRect();
            const padding = window.innerWidth <= 480 ? 20 : window.innerWidth <= 768 ? 30 : 80;
            
            if (window.innerWidth <= 768) {
                width = Math.max(300, containerRect.width - padding);
                height = Math.max(500, Math.min(window.innerHeight * 0.7, 800));
                isMobile = true;
            } else {
                width = Math.max(800, containerRect.width - padding);
                height = 700;
                isMobile = false;
            }
            
            if (window.innerWidth <= 480) {
                width = Math.min(width, window.innerWidth - 10);
            }
        }

        // Update the theme toggle to update the icon
window.toggleTheme = function() {
    isDarkTheme = !isDarkTheme;
    document.body.classList.toggle('dark-theme');
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) {
        themeIcon.textContent = isDarkTheme ? '☀️' : '🌙';
    }
    
    // Force immediate theme reapplication
    setTimeout(() => {
        reapplyThemeStyles();
        
        // If we're in tree view, force a visual update
        if (currentView === 'tree' && g) {
            const isDark = document.body.classList.contains('dark-theme');
            g.selectAll('g.node text')
                .style('fill', isDark ? '#ffffff !important' : '#333333 !important');
            g.selectAll('path.link')
                .style('stroke', isDark ? '#4b5563' : '#999');
        }
    }, 50);
    
    // Refresh preview if no data is loaded
    if (!treeData) {
        showViewPreview(currentView);
    }
}




// Connect nav search to existing search functionality
document.addEventListener('DOMContentLoaded', function() {
    const navSearchInput = document.getElementById('navSearchInput');
    if (navSearchInput) {
        navSearchInput.addEventListener('input', function(e) {
            // Sync with main search input
            const mainSearchInput = document.getElementById('searchInput');
            if (mainSearchInput) {
                mainSearchInput.value = e.target.value;
                mainSearchInput.dispatchEvent(new Event('input'));
            }
        });
    }
});


// Add this after your existing JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Create and append overlay if it doesn't exist
    if (!document.querySelector('.mobile-menu-overlay')) {
        const overlay = document.createElement('div');
        overlay.className = 'mobile-menu-overlay';
        overlay.onclick = closeMobileMenu;
        document.body.appendChild(overlay); // Append to body instead of nav-bar
    }
});



document.addEventListener('DOMContentLoaded', function() {
    // Tree View button
    const treeViewBtn = document.getElementById('treeViewBtn');
    if (treeViewBtn) {
        treeViewBtn.removeEventListener('click', treeViewBtn.onclick); // Remove any existing
        treeViewBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Tree button clicked');
            switchView('tree');
        });
    }
    
    // Dashboard button
    const dashboardViewBtn = document.getElementById('dashboardViewBtn');
    if (dashboardViewBtn) {
        // Remove any existing handlers first
        dashboardViewBtn.replaceWith(dashboardViewBtn.cloneNode(true));
        
        // Get the fresh button reference
        const freshDashboardBtn = document.getElementById('dashboardViewBtn');
        freshDashboardBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Dashboard button clicked');
            switchView('dashboard');
        });
    }
});
    
    // 3D View button
    const threeDViewBtn = document.getElementById('3dViewBtn');
if (threeDViewBtn) {
    threeDViewBtn.removeEventListener('click', threeDViewBtn.onclick);
    threeDViewBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('3D button clicked');
        switchView('3d');
    });
}


        // File handling
        function handleFile(file) {
    if (!file.name.toLowerCase().endsWith('.xml')) {
        alert('Please upload an XML file');
        return;
    }

    showLoading('Processing file...');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            parseSitemap(e.target.result, file.name);
            
            // Clear the file input so the same file can be selected again
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.value = '';
            }
        } catch (error) {
            console.error('Error parsing sitemap:', error);
            alert('Error parsing sitemap. Please check the file format.');
            hideLoading();
            
            // Clear the file input even on error
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.value = '';
            }
        }
    };
    reader.readAsText(file);
}

        // URL loading
        window.loadFromURL = async function() {
    const urlInput = document.getElementById('urlInput');
    if (!urlInput) return;
    
    const url = urlInput.value.trim();
    
    if (!url) {
        alert('Please enter a sitemap URL');
        return;
    }
    
    showLoading('Loading from URL...');
    
    // Try each proxy until one works
    for (let i = 0; i < CORS_PROXIES.length; i++) {
        try {
            console.log(`Trying proxy ${i + 1}...`);
            const proxyUrl = CORS_PROXIES[i](url);
            
            const response = await fetch(proxyUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            let xmlContent;
            
            // Handle different proxy response formats
            if (proxyUrl.includes('allorigins')) {
                const data = await response.json();
                xmlContent = data.contents;
            } else if (proxyUrl.includes('codetabs')) {
                xmlContent = await response.text();
            } else {
                xmlContent = await response.text();
            }
            
            if (xmlContent && xmlContent.includes('<?xml')) {
                console.log('Successfully loaded sitemap!');
                parseSitemap(xmlContent, url);
                return; // Success!
            } else {
                throw new Error('Invalid XML content');
            }
        } catch (error) {
            console.error(`Proxy ${i + 1} failed:`, error.message);
            
            // If all proxies fail
            if (i === CORS_PROXIES.length - 1) {
                alert(`Unable to load sitemap. All proxy services failed. You can:\n\n1. Download the sitemap manually\n2. Use the file upload option instead`);
                hideLoading();
            }
        }
    }
}


// Add list of CORS proxies to try
const CORS_PROXIES = [
    url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
    url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
    url => `https://cors-anywhere.herokuapp.com/${url}` // Often requires activation
];



        // Quick site loading
        // Enhanced load function with fallbacks
window.loadQuickSite = async function(url) {
    const urlInput = document.getElementById('urlInput');
    if (urlInput) {
        urlInput.value = url;
    }
    
    const clickedButton = event.target.closest('.quick-access-btn');
    if (clickedButton) {
        clickedButton.classList.add('loading');
    }
    
    const siteName = url.includes('citizensinformationboard') ? 'Citizens Information Board' :
                   url.includes('citizensinformation') ? 'Citizens Information' :
                   url.includes('mabs.ie') ? 'MABS' : 'site';
    
    showLoading(`Loading ${siteName} sitemap...`);
    
    let success = false;
    
    // Try each proxy until one works
    for (let i = 0; i < CORS_PROXIES.length; i++) {
        try {
            console.log(`Trying proxy ${i + 1}...`);
            const proxyUrl = CORS_PROXIES[i](url);
            
            const response = await fetch(proxyUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            let xmlContent;
            
            // Handle different proxy response formats
            if (proxyUrl.includes('allorigins')) {
                const data = await response.json();
                xmlContent = data.contents;
            } else if (proxyUrl.includes('codetabs')) {
                xmlContent = await response.text();
            } else {
                xmlContent = await response.text();
            }
            
            if (xmlContent && xmlContent.includes('<?xml')) {
                console.log('Successfully loaded sitemap!');
                parseSitemap(xmlContent, url);
                success = true;
                break; // Success - exit loop!
            } else {
                throw new Error('Invalid XML content');
            }
        } catch (error) {
            console.error(`Proxy ${i + 1} failed:`, error.message);
            
            // If all proxies fail
            if (i === CORS_PROXIES.length - 1) {
                alert(`Unable to load ${siteName} sitemap. All proxy services failed. You can:\n\n1. Download the sitemap manually from ${url}\n2. Use the file upload option instead`);
                hideLoading();
            }
        }
    }
    
    // Always remove loading state
    if (clickedButton) {
        clickedButton.classList.remove('loading');
    }
}

        // Loading functions
        function showLoading(text) {
    const loading = document.getElementById('loading');
    const loadingText = document.getElementById('loadingText');
    
    if (loading) {
        loading.style.display = 'block';
        
        // Prevent body scroll on mobile while loading
        if (window.innerWidth <= 768) {
            document.body.style.overflow = 'hidden';
        }
    }
    
    if (loadingText) {
        loadingText.textContent = text;
    }
}

        function hideLoading() {
    const loading = document.getElementById('loading');
    if (loading) {
        loading.style.display = 'none';
        
        // Restore body scroll
        document.body.style.overflow = '';
    }
}

        function updateProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            if (progressFill) progressFill.style.width = percent + '%';
        }

        // Parse sitemap
        function parseSitemap(xmlString, source) {
    try {
        // Reset 3D view if active when loading new sitemap
        if (is3DViewActive) {
            is3DViewActive = false;
            if (Graph3D) {
                try {
                    Graph3D._destructor();
                } catch (e) {
                    console.error('Error destroying Graph3D:', e);
                }
                Graph3D = null;
            }
            graphData = null;
            
            const container3D = document.getElementById('3d-graph-container');
            if (container3D) {
                container3D.innerHTML = '';
                container3D.style.display = 'none';
            }
        }
        
        // Force view to tree when loading new sitemap
        currentView = 'tree';
        document.body.setAttribute('data-view', 'tree');
        
        // Debug mobile detection
        console.log("isMobile:", isMobile, "Window width:", window.innerWidth);
        
        // Reset search when loading new sitemap
        searchInitialized = false;
        searchResults = [];
        currentResultIndex = -1;
        
        updateProgress(20);
        
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlString, "text/xml");
        
        const parserError = xmlDoc.querySelector('parsererror');
        if (parserError) {
            throw new Error('Invalid XML format');
        }
        
        const urls = xmlDoc.getElementsByTagName('url');
        
        if (urls.length === 0) {
            const locs = xmlDoc.getElementsByTagName('loc');
            if (locs.length === 0) {
                alert('No URLs found in sitemap. Please check the file format.');
                hideLoading();
                return;
            }
        }

        updateProgress(40);

        let rootDomain = 'Website';
        try {
            const firstUrl = urls[0] ? urls[0].getElementsByTagName('loc')[0].textContent : 
                            xmlDoc.getElementsByTagName('loc')[0].textContent;
            const urlObj = new URL(firstUrl);
            rootDomain = urlObj.hostname;
        } catch (e) {
            console.warn('Could not extract domain');
        }

        const tree = { 
            name: rootDomain, 
            children: {}, 
            url: '', 
            depth: 0,
            pageCount: 0,
            lastModified: null,
            lastModDates: []
        };
        
        let totalPages = 0;
        let maxDepth = 0;
        let depthCounts = {};
        let actualDepthCounts = {};
        let pageDepthCounts = {};
        const urlList = urls.length > 0 ? urls : xmlDoc.getElementsByTagName('loc');
        const allLastModDates = [];

        updateProgress(60);

        // Build tree structure
        for (let urlElement of urlList) {
            const loc = urlElement.tagName === 'loc' ? urlElement : urlElement.getElementsByTagName('loc')[0];
            if (!loc) continue;

            const urlPath = loc.textContent;
            totalPages++;

            // Extract lastmod data
            let lastMod = null;
            if (urlElement.tagName === 'url') {
                const lastModElement = urlElement.getElementsByTagName('lastmod')[0];
                if (lastModElement && lastModElement.textContent) {
                    lastMod = lastModElement.textContent.trim();
                    try {
                        const testDate = new Date(lastMod);
                        if (!isNaN(testDate.getTime())) {
                            allLastModDates.push(lastMod);
                        } else {
                            console.warn('Invalid date format:', lastMod);
                            lastMod = null;
                        }
                    } catch (e) {
                        console.warn('Error parsing date:', lastMod, e);
                        lastMod = null;
                    }
                }
            }

            try {
                const urlObj = new URL(urlPath);
                const pathParts = urlObj.pathname.split('/').filter(part => part.length > 0);
                
                let current = tree;
                let depth = 0;
                const pathNodes = [current];

                pathParts.forEach((part, index) => {
                    depth = index + 1;
                    if (!current.children[part]) {
                        current.children[part] = {
                            name: formatNodeName(part),
                            children: {},
                            url: index === pathParts.length - 1 ? urlPath : '',
                            depth: depth,
                            fullPath: pathParts.slice(0, index + 1).join('/'),
                            pageCount: 0,
                            lastModified: null,
                            lastModDates: []
                        };
                    }
                    current = current.children[part];
                    pathNodes.push(current);
                    current.pageCount++;
                    
                    if (lastMod) {
                        current.lastModDates.push(lastMod);
                        if (!current.lastModified || new Date(lastMod) > new Date(current.lastModified)) {
                            current.lastModified = lastMod;
                        }
                    }
                });

                maxDepth = Math.max(maxDepth, depth);
                
                for (let d = 0; d <= depth; d++) {
                    depthCounts[d] = (depthCounts[d] || 0) + 1;
                }
                
                if (pathParts.length > 0) {
                    pageDepthCounts[depth] = (pageDepthCounts[depth] || 0) + 1;
                }
            } catch (e) {
                console.warn('Could not parse URL:', urlPath, e);
            }
        }

        // Count all nodes at each depth
        function countNodesAtEachDepth(node, currentDepth = 0) {
            actualDepthCounts[currentDepth] = (actualDepthCounts[currentDepth] || 0) + 1;
            
            if (node.children) {
                Object.values(node.children).forEach(child => {
                    countNodesAtEachDepth(child, currentDepth + 1);
                });
            }
        }
        
        countNodesAtEachDepth(tree);

        updateProgress(80);

        tree.lastModDates = allLastModDates;
        updateParentLastModDates(tree);
        
        treeData = convertToHierarchy(tree);
        maxSiteDepth = maxDepth;
        
        const mainCategories = Object.keys(tree.children).length;
        const avgDepth = calculateAverageDepth(tree);
        
        // Update stats
        const totalPagesEl = document.getElementById('totalPages');
        const mainCategoriesEl = document.getElementById('mainCategories');
        const maxDepthEl = document.getElementById('maxDepth');
        const avgDepthEl = document.getElementById('avgDepth');
        
        if (totalPagesEl) totalPagesEl.textContent = totalPages.toLocaleString();
        if (mainCategoriesEl) mainCategoriesEl.textContent = mainCategories;
        if (maxDepthEl) maxDepthEl.textContent = maxDepth;
        if (avgDepthEl) avgDepthEl.textContent = avgDepth;
        
        generateDynamicLegend(maxDepth, actualDepthCounts);
        calculateSiteAnalytics(tree, totalPages, maxDepth, pageDepthCounts);
        
        updateProgress(100);
        
        setTimeout(() => {
            hideLoading();
            const stats = document.getElementById('stats');
            const controls = document.getElementById('controls');
            const colourLegend = document.getElementById('colourLegend');
            
            if (stats) stats.style.display = 'flex';
            
            // Add toggle button if it doesn't exist
            if (!stats.querySelector('.stats-toggle')) {
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'stats-toggle';
                toggleBtn.innerHTML = stats.classList.contains('collapsed') ? '+' : '−';
                toggleBtn.onclick = toggleStats;
                toggleBtn.title = 'Toggle stats';
                stats.appendChild(toggleBtn);
            }
            
            const navBar = document.getElementById('navBar');
            if (navBar) navBar.style.display = 'flex';
            
            if (colourLegend) colourLegend.style.display = 'flex';
            
            createVisualization();
            
            // Auto-collapse upload section after successful load
            autoCollapseUploadSection();
            
            // Enable all nav buttons
            const buttons = ['treeViewBtn', 'dashboardViewBtn', 'reportsDropdown'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.style.opacity = '1';
                    btn.style.pointerEvents = 'auto';
                }
            });
            
            // Initialize search after tree is rendered
            setTimeout(() => {
                initializeSearch();
            }, 100);
        }, 300);
        
    } catch (error) {
        console.error('Error parsing sitemap:', error);
        alert('Error parsing sitemap: ' + error.message);
        hideLoading();
    }
}

// This function should be defined OUTSIDE of parseSitemap
function updateParentLastModDates(node) {
    if (!node) return null;
    
    if (Object.keys(node.children).length === 0) {
        return node.lastModified;
    }
    
    let latestDate = node.lastModified ? new Date(node.lastModified) : null;
    
    for (let childKey in node.children) {
        const childLastMod = updateParentLastModDates(node.children[childKey]);
        
        if (childLastMod) {
            const childDate = new Date(childLastMod);
            if (!latestDate || childDate > latestDate) {
                latestDate = childDate;
                node.lastModified = childLastMod;
            }
        }
    }
    
    return node.lastModified;
}
        // Convert to hierarchy
        function convertToHierarchy(node) {
            const result = {
                name: node.name,
                url: node.url,
                depth: node.depth,
                fullPath: node.fullPath || '',
                pageCount: node.pageCount || 0,
                lastModified: node.lastModified || null,
                lastModDates: node.lastModDates || []
            };

            const childrenArray = Object.values(node.children);
            if (childrenArray.length > 0) {
                result.children = childrenArray.map(child => convertToHierarchy(child));
                result._children = null;
            }

            return result;
        }

        // Calculate average depth
        function calculateAverageDepth(tree) {
            let totalDepth = 0;
            let pageCount = 0;
            
            function traverse(node, depth = 0) {
                if (!node.children || Object.keys(node.children).length === 0) {
                    totalDepth += depth;
                    pageCount++;
                } else {
                    Object.values(node.children).forEach(child => traverse(child, depth + 1));
                }
            }
            
            traverse(tree);
            return pageCount > 0 ? Math.round((totalDepth / pageCount) * 10) / 10 : 0;
        }

        // Calculate site analytics
        function calculateSiteAnalytics(tree, totalPages, maxDepth, pageDepthCounts) {
            const categoryStats = {};
            const languageStats = {};
            
            const rootChildren = Object.values(tree.children || {});
            const hasLanguageFolders = rootChildren.some(child => 
                child.name && (child.name.toLowerCase() === 'en' || 
                              child.name.toLowerCase() === 'ga' || 
                              child.name.toLowerCase() === 'english' ||
                              child.name.toLowerCase() === 'irish')
            );
            
            if (hasLanguageFolders) {
                Object.values(tree.children).forEach(lang => {
                    const langName = detectLanguageName(lang.name);
                    const langPageCount = countPagesInNode(lang);
                    
                    languageStats[langName] = {
                        name: langName,
                        originalName: lang.name,
                        pages: langPageCount,
                        percentage: Math.round((langPageCount / totalPages) * 100),
                        categories: Object.keys(lang.children || {}).length,
                        avgDepth: calculateNodeAverageDepth(lang),
                        maxDepth: calculateNodeMaxDepth(lang),
                        children: {}
                    };
                    
                    if (lang.children) {
                        Object.values(lang.children).forEach(category => {
                            const pageCount = countPagesInNode(category);
                            const categoryKey = `${langName}/${category.name}`;
                            
                            categoryStats[categoryKey] = {
                                name: category.name,
                                language: langName,
                                pages: pageCount,
                                percentage: Math.round((pageCount / totalPages) * 100),
                                langPercentage: Math.round((pageCount / langPageCount) * 100),
                                depth: category.depth,
                                avgDepth: calculateNodeAverageDepth(category),
                                maxDepth: calculateNodeMaxDepth(category),
                                subcategories: Object.keys(category.children || {}).length,
                                fullPath: categoryKey
                            };
                            
                            languageStats[langName].children[category.name] = categoryStats[categoryKey];
                        });
                    }
                });
            } else {
                const langName = 'en';
                const langPageCount = totalPages;
                
                languageStats[langName] = {
                    name: langName,
                    originalName: 'Main Site',
                    pages: langPageCount,
                    percentage: 100,
                    categories: Object.keys(tree.children || {}).length,
                    avgDepth: calculateAverageDepth(tree),
                    maxDepth: maxDepth,
                    children: {}
                };
                
                Object.values(tree.children || {}).forEach(category => {
                    const pageCount = countPagesInNode(category);
                    const categoryKey = `${langName}/${category.name}`;
                    
                    categoryStats[categoryKey] = {
                        name: category.name,
                        language: langName,
                        pages: pageCount,
                        percentage: Math.round((pageCount / totalPages) * 100),
                        langPercentage: Math.round((pageCount / langPageCount) * 100),
                        depth: category.depth,
                        avgDepth: calculateNodeAverageDepth(category),
                        maxDepth: calculateNodeMaxDepth(category),
                        subcategories: Object.keys(category.children || {}).length,
                        fullPath: categoryKey
                    };
                    
                    languageStats[langName].children[category.name] = categoryStats[categoryKey];
                });
            }

            const avgDepth = calculateAverageDepth(tree);
            
            const depthDistribution = Object.keys(pageDepthCounts).map(depth => ({
                depth: parseInt(depth),
                count: pageDepthCounts[depth],
                percentage: Math.round((pageDepthCounts[depth] / totalPages) * 100)
            })).sort((a, b) => a.depth - b.depth);
            
            siteStats = {
                totalPages,
                maxDepth,
                avgDepth,
                categoryCount: Object.keys(tree.children).length,
                hasLanguageFolders: hasLanguageFolders,
                languageStats: Object.values(languageStats).sort((a, b) => b.pages - a.pages),
                categoryStats: Object.values(categoryStats).sort((a, b) => b.pages - a.pages),
                depthDistribution: depthDistribution,
                categoryBreakdown: Object.values(categoryStats)
                    .sort((a, b) => b.pages - a.pages),
                largestCategory: Object.values(categoryStats)
                    .reduce((max, cat) => cat.pages > max.pages ? cat : max, {pages: 0, name: 'None', percentage: 0})
            };
            
            siteAnalysis = generateSiteAnalysis();
        }

        function detectLanguageName(name) {
            const lowerName = name.toLowerCase();
            if (lowerName === 'en' || lowerName === 'english') return 'en';
            if (lowerName === 'ga' || lowerName === 'irish' || lowerName === 'gaeilge') return 'ga';
            if (lowerName.includes('en') || lowerName.includes('eng')) return 'en';
            if (lowerName.includes('ga') || lowerName.includes('irish')) return 'ga';
            return name;
        }

        function calculateNodeAverageDepth(node, currentDepth = 0) {
            if (!node.children || Object.keys(node.children).length === 0) {
                return currentDepth;
            }
            
            let totalDepth = 0;
            let leafCount = 0;
            
            function traverse(n, depth) {
                if (!n.children || Object.keys(n.children).length === 0) {
                    totalDepth += depth;
                    leafCount++;
                } else {
                    Object.values(n.children).forEach(child => traverse(child, depth + 1));
                }
            }
            
            traverse(node, currentDepth);
            return leafCount > 0 ? Math.round((totalDepth / leafCount) * 10) / 10 : currentDepth;
        }

        function calculateNodeMaxDepth(node, currentDepth = 0) {
            if (!node.children || Object.keys(node.children).length === 0) {
                return currentDepth;
            }
            
            let maxDepth = currentDepth;
            Object.values(node.children).forEach(child => {
                maxDepth = Math.max(maxDepth, calculateNodeMaxDepth(child, currentDepth + 1));
            });
            
            return maxDepth;
        }

        function countPagesInNode(node) {
            if (!node.children || Object.keys(node.children).length === 0) {
                return 1;
            }
            return Object.values(node.children)
                .reduce((total, child) => total + countPagesInNode(child), 0);
        }

        function generateSiteAnalysis() {
            const issues = [];
            const recommendations = [];
            const strengths = [];
            
            if (siteStats.maxDepth > 6) {
                issues.push({
                    type: 'critical',
                    title: 'Site Too Deep',
                    description: `Your site has ${siteStats.maxDepth} levels of depth. This can hurt SEO and user experience.`
                });
            } else if (siteStats.maxDepth >= 5) {
                issues.push({
                    type: 'warning',
                    title: 'Deep Site Structure',
                    description: `Site depth of ${siteStats.maxDepth} levels is acceptable but could be optimized.`
                });
            } else {
                strengths.push('Optimal site depth for SEO and navigation');
            }
            
            const imbalancedCategories = siteStats.categoryBreakdown.filter(cat => 
                cat.percentage > 50 || (cat.percentage < 5 && siteStats.totalPages > 20)
            );
            
            if (imbalancedCategories.length > 0) {
                issues.push({
                    type: 'warning',
                    title: 'Unbalanced Content Distribution',
                    description: 'Some categories have disproportionate amounts of content.'
                });
            } else {
                strengths.push('Well-balanced content distribution across categories');
            }
            
            if (siteStats.totalPages > 10000) {
                recommendations.push({
                    title: 'Large Site Optimization',
                    description: 'Consider implementing pagination, faceted navigation, or content archiving.'
                });
            } else if (siteStats.totalPages < 10) {
                recommendations.push({
                    title: 'Content Expansion Opportunity',
                    description: 'Your site has limited content. Consider expanding to improve SEO potential.'
                });
            } else {
                strengths.push('Good content volume for search engine visibility');
            }
            
            let score = 100;
            score -= issues.filter(i => i.type === 'critical').length * 20;
            score -= issues.filter(i => i.type === 'warning').length * 10;
            score = Math.max(0, score);
            
            return {
                score,
                issues,
                recommendations,
                strengths
            };
        }
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        // Generate legend
        function generateDynamicLegend(maxDepth, actualDepthCounts) {
    const legendContainer = document.getElementById('colourLegend');
    if (!legendContainer) return;
    
    legendContainer.innerHTML = '';
    actualDepthCounts[0] = 1;
    
    let totalLeafNodes = 0;
    
    function countLeafNodes(node) {
        if (!node.children || Object.keys(node.children).length === 0) {
            totalLeafNodes++;
        } else {
            Object.values(node.children).forEach(child => countLeafNodes(child));
        }
    }
    
    if (treeData) {
        countLeafNodes(treeData);
    }
    
    // Store legend data for hover functionality
    window.legendData = [];
    
    for (let depth = 0; depth <= maxDepth; depth++) {
        let label = '';
        let colour = '';
        let count = actualDepthCounts[depth] || 0;
        let filterFunction = null;
        
        switch (depth) {
            case 0:
                label = 'Root';
                colour = colourScheme.home;
                filterFunction = (d) => d.depth === 0;
                break;
            case 1:
                label = maxDepth >= 4 ? 'Languages' : 'Categories';
                colour = colourScheme.language;
                filterFunction = (d) => d.depth === 1;
                break;
            case 2:
                label = maxDepth >= 4 ? 'Categories' : 'Sections';
                colour = colourScheme.category;
                filterFunction = (d) => d.depth === 2;
                break;
            default:
                if (depth === maxDepth) {
                    label = 'Pages';
                    colour = colourScheme.page;
                    count = totalLeafNodes;
                    filterFunction = (d) => !d.children && !d._children;
                } else {
                    label = 'Level ' + depth;
                    colour = colourScheme.section;
                    filterFunction = (d) => d.depth === depth;
                }
                break;
        }
        
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.dataset.depth = depth;
        legendItem.dataset.label = label;
        legendItem.innerHTML = `
            <div class="legend-colour" style="background: ${colour};"></div>
            <span class="legend-label">${label} (${count})</span>
        `;
        
        // Store the filter function
        window.legendData.push({
            depth: depth,
            label: label,
            filterFunction: filterFunction,
            colour: colour
        });
        
        // Add hover events
        legendItem.addEventListener('mouseenter', function() {
            highlightNodesByLegend(depth);
            this.classList.add('active');
        });
        
legendItem.addEventListener('mouseleave', function() {
    // Only clear if there's no permanent highlight
    if (window.permanentHighlight === null) {
        clearLegendHighlights();
        this.classList.remove('active');
    } else {
        // Reapply the permanent highlight
        highlightNodesByLegend(window.permanentHighlight);
        // Keep the active class on the permanent item
        document.querySelectorAll('.legend-item').forEach(item => {
            item.classList.toggle('active', item.dataset.depth == window.permanentHighlight);
        });
    }
});
        
        // Optional: Add click to toggle permanent highlight
        legendItem.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    toggleLegendHighlight(parseInt(this.dataset.depth));
});
        
        legendContainer.appendChild(legendItem);
    }
}



// Function to highlight nodes based on legend hover
function highlightNodesByLegend(depth) {
    if (!g || !window.legendData) return;
    
    const legendItem = window.legendData.find(item => item.depth == depth);
    if (!legendItem) return;
    
    // Clear any existing legend highlights
    clearLegendHighlights();
    
    // Add fade class to all nodes first
    g.selectAll('g.node')
        .classed('legend-fade', true);
    
    // Highlight matching nodes
    g.selectAll('g.node')
        .filter(legendItem.filterFunction)
        .classed('legend-highlight', true)
        .classed('legend-fade', false);
    
    // Also fade the links
    g.selectAll('path.link')
        .style('opacity', 0.2);
}

// Clear legend highlights
function clearLegendHighlights() {
    if (!g) return;
    
    g.selectAll('g.node')
        .classed('legend-highlight', false)
        .classed('legend-fade', false);
    
    g.selectAll('path.link')
        .style('opacity', null);
}

// Toggle permanent highlight (optional feature)
window.permanentHighlight = null;

function toggleLegendHighlight(depth) {
    if (window.permanentHighlight === depth) {
        clearLegendHighlights();
        window.permanentHighlight = null;
        document.querySelectorAll('.legend-item').forEach(item => {
            item.classList.remove('active');
        });
    } else {
        window.permanentHighlight = depth;
        highlightNodesByLegend(depth);
        
        // Update active state
        document.querySelectorAll('.legend-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.depth == depth) {
                item.classList.add('active');
            }
        });
    }
}


// Add this new function to reapply theme styles
// Enhanced function to reapply theme styles
function reapplyThemeStyles() {
    const isDark = document.body.classList.contains('dark-theme');
    console.log('Reapplying theme styles. Dark mode:', isDark);
    
    // Update tree visualization elements
    const treeContainer = document.getElementById('treeContainer');
    if (treeContainer) {
        treeContainer.style.background = isDark ? 'var(--gray-900)' : 'var(--gray-50)';
    }
    
    // Update SVG background
    const svgElement = document.querySelector('#treeContainer svg');
    if (svgElement) {
        svgElement.style.background = isDark ? 'var(--gray-900)' : 'var(--gray-50)';
    }
    
    // Update all node text elements - try multiple selectors
    if (g && g.selectAll) {
        const nodeTexts = g.selectAll('g.node text');
        if (nodeTexts.size() > 0) {
            nodeTexts.style('fill', isDark ? '#ffffff' : '#333333');
            console.log(`Updated ${nodeTexts.size()} node text elements`);
        }
        
        // Update link elements
        const links = g.selectAll('path.link');
        if (links.size() > 0) {
            links.style('stroke', isDark ? '#4b5563' : '#999');
            console.log(`Updated ${links.size()} link elements`);
        }
    }
    
    // Fallback: Direct DOM selection if d3 selection doesn't work
    const allNodeTexts = document.querySelectorAll('#treeContainer .node text');
    if (allNodeTexts.length > 0) {
        allNodeTexts.forEach(text => {
            text.style.fill = isDark ? '#ffffff' : '#333333';
        });
        console.log(`Fallback: Updated ${allNodeTexts.length} text elements`);
    }
    
    const allLinks = document.querySelectorAll('#treeContainer .link');
    if (allLinks.length > 0) {
        allLinks.forEach(link => {
            link.style.stroke = isDark ? '#4b5563' : '#999';
        });
        console.log(`Fallback: Updated ${allLinks.length} link elements`);
    }
    
    // Update dashboard elements if they exist
    const dashboard = document.querySelector('.dashboard');
    if (dashboard) {
        dashboard.classList.toggle('dark-theme', isDark);
    }
}


        // Create visualization
        function createVisualization() {
    d3.select("#treeContainer").selectAll("*").remove();
    updateDimensions();
    
    // Check current theme state
    const isDark = document.body.classList.contains('dark-theme');
    
    // Add export buttons
    const exportContainer = d3.select("#treeContainer")
        .append("div")
        .attr("class", "export-buttons")
        .style("display", currentView === 'tree' ? 'flex' : 'none');
            
            exportContainer.append("button")
                .attr("class", "export-float-btn")
                .attr("onclick", "exportSVG()")
                .html(`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Export SVG`);
            
            exportContainer.append("button")
                .attr("class", "export-float-btn")
                .attr("onclick", "exportPNG()")
                .html(`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                Export PNG`);
            
            // Add tree control buttons
            const treeControls = d3.select("#treeContainer")
        .append("div")
        .attr("class", "tree-controls")
        .style("display", currentView === 'tree' ? 'flex' : 'none');
            
            treeControls.append("button")
    .attr("class", "tree-control-btn")
    .attr("onclick", "expandAll()")
    .attr("aria-label", "Expand All")
    .attr("title", "Expand All")
    .html(`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 6 15 12 9 18"></polyline>
    </svg>
    <span class="btn-text">Expand All</span>`);
            
            treeControls.append("button")
    .attr("class", "tree-control-btn")
    .attr("onclick", "collapseAll()")
    .attr("aria-label", "Collapse All")
    .attr("title", "Collapse All")
    .html(`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
    <span class="btn-text">Collapse All</span>`);
            
            treeControls.append("button")
                .attr("class", "tree-control-btn")
                .attr("onclick", "resetZoom()")
                .attr("aria-label", "Reset View")
                .attr("title", "Reset View")
                .html(`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <span class="btn-text">Reset View</span>`);
                
                treeControls.append("button")
    .attr("class", "tree-control-btn")
    .attr("id", "freshnessToggleBtn")
    .attr("onclick", "toggleFreshnessView()")
    .attr("aria-label", "Toggle Freshness View")
    .attr("title", "Toggle Freshness View")
    .html(`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="8" r="7"></circle>
        <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
    </svg>
    <span class="btn-text">Freshness</span>`);

            svg = d3.select("#treeContainer")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .style("display", "block")
        .style("margin", "0 auto")
        .style("background", isDark ? 'var(--gray-900)' : 'var(--gray-50)'); // Apply theme background immediately
    
    // Add touch-action CSS for mobile
    if (checkIfMobile()) {
        svg.style("touch-action", "manipulation");
    }

    g = svg.append("g")
        .attr("transform", isMobile ? "translate(40,20)" : "translate(60,30)");

    tooltip = d3.select("#tooltip");
    tree = d3.tree().size([height - (isMobile ? 40 : 60), width - (isMobile ? 80 : 120)]);
            
            tree.separation((a, b) => {
    if (a.parent === b.parent) {
        // More space between siblings
        return isMobile ? 1.5 : 1.2;
    }
    // More space between different families
    return isMobile ? 2.5 : 2;
});

            root = d3.hierarchy(treeData);
            root.x0 = height / 2;
            root.y0 = 0;

            allNodes = root.descendants();
            
            // Smart initial expansion
            if (root.children) {
                const hasLanguageFolders = root.children.some(child => 
                    child.data && child.data.name && 
                    (child.data.name.toLowerCase() === 'en' || 
                     child.data.name.toLowerCase() === 'ga' ||
                     child.data.name.toLowerCase() === 'english' ||
                     child.data.name.toLowerCase() === 'irish')
                );
                
                if (hasLanguageFolders) {
                    root.children.forEach(child => {
                        if (child.children) {
                            child._children = child.children;
                            child.children = null;
                        }
                    });
                    
                    const englishNode = root.children.find(child => 
                        child.data && child.data.name && 
                        (child.data.name.toLowerCase() === 'en' || 
                         child.data.name.toLowerCase() === 'english')
                    );
                    
                    if (englishNode && englishNode._children) {
                        englishNode.children = englishNode._children;
                        englishNode._children = null;
                        if (englishNode.children) {
                            englishNode.children.forEach(collapse);
                        }
                    }
                } else {
                    root.children.forEach(collapse);
                }
            }
            
       update(root);

    globalZoom = createOptimizedZoom();

    svg.call(globalZoom)
       .on("zoom.cull", () => {
           requestAnimationFrame(cullInvisibleNodes);
       });

    if (isMobile) {
        svg.on("touchstart", function(event) { event.preventDefault(); });
        
        if (root) {
            const initialScale = 0.6;
            svg.call(globalZoom.transform, d3.zoomIdentity.scale(initialScale));
        }
    }
    
    // CRITICAL: Apply theme styles after everything is created and rendered
    setTimeout(() => {
        reapplyThemeStyles();
    }, 200); // Increased delay to ensure all elements are rendered
}
		
		
		
		

        function collapse(d) {
            if (d.children) {
                if (d.depth > 1) {
                    d._children = d.children;
                    d._children.forEach(collapse);
                    d.children = null;
                } else {
                    d.children.forEach(collapse);
                }
            }
        }

        function update(source) {
    if (!root || !tree) return;
    
    // Check theme at the start
    const isDark = document.body.classList.contains('dark-theme');
    
    // Use requestAnimationFrame for smooth rendering
    requestAnimationFrame(() => {
        const duration = 750;
        const treeLayout = tree(root);
        const nodes = treeLayout.descendants();
        const links = treeLayout.descendants().slice(1);
        
        // Pre-calculate values
        const nodeSpacing = isMobile ? 300 : 350;
        const nodeRadius = isMobile ? 10 : 6;
        const textOffset = isMobile ? -15 : -13;
        const maxTextLength = isMobile ? 30 : 50;
        
        // Batch position calculations
        nodes.forEach(d => {
            d.y = d.depth * nodeSpacing;
            // Cache display name to avoid recalculating
            if (!d.displayName || d.data.name !== d._cachedName) {
                d._cachedName = d.data.name;
                d.displayName = d.data.name.length > maxTextLength 
                    ? d.data.name.substring(0, maxTextLength) + '...' 
                    : d.data.name;
            }
        });
        
        // Spread out crowded nodes (your existing logic)
        adjustNodeSpacing(nodes);
        
        // Update nodes with better data binding
        const node = g.selectAll('g.node')
            .data(nodes, d => d.id || (d.id = ++i));
        
        // ENTER - Create new nodes
        const nodeEnter = node.enter().append('g')
    .attr('class', 'node')
    .attr('transform', d => `translate(${source.y0},${source.x0})`)
    .style('cursor', 'pointer');

// Remove all event handlers from the group - we'll add them to specific elements
    
    
        // Add circle once
        // In the update() function, modify the nodeEnter circle creation:
nodeEnter.append('circle')
    .attr('r', 1e-6)
    .style('fill', d => d._children ? 'lightsteelblue' : '#fff')
    .style('stroke', '#fff')
    .style('stroke-width', '2px')
    .on('click', function(event, d) {
        event.stopPropagation();
        
        // Hide any tooltip on circle click
        if (enhancedTooltip) {
            enhancedTooltip
                .classed("visible", false)
                .style("opacity", 0)
                .style("pointer-events", "none");
        }
        
        // Handle expand/collapse
        if (checkIfMobile()) {
            handleMobileNodeTap(event, d);
        } else {
            click(event, d);
        }
    })
    // Add touch event handlers for mobile
    .on('touchstart', function(event, d) {
        event.preventDefault();
        event.stopPropagation();
        
        // Trigger the click handler
        d3.select(this).dispatch('click');
    });
        
        // Add text once
        const textElement = nodeEnter.append('text')
            .attr('dy', '.35em')
            .attr('text-anchor', d => d.children || d._children ? 'end' : 'start')
            .style('fill-opacity', 1e-6)
            .style('fill', isDark ? '#ffffff' : '#333333') // Apply theme immediately
            .style('cursor', 'pointer');

// Add hover events only to text elements on desktop
if (!checkIfMobile()) {
    textElement
        .on('mouseenter', function(event, d) {
            // Visual feedback on hover
            d3.select(this)
                .style('text-decoration', 'underline')
                .style('font-weight', '600');
            
            handleEnhancedMouseOver(event, d);
        })
        .on('mouseleave', function(event, d) {
            // Remove visual feedback
            d3.select(this)
                .style('text-decoration', 'none')
                .style('font-weight', '500');
            
            handleEnhancedMouseOut(event, d);
        });
}
        
        // ENTER + UPDATE - Merge and update all nodes
        const nodeUpdate = nodeEnter.merge(node);
        
        // Transition to new positions
        nodeUpdate.transition()
            .duration(duration)
            .attr('transform', d => `translate(${d.y},${d.x})`);
        
        // Update circle attributes
        nodeUpdate.select('circle')
            .transition()
            .duration(duration)
            .attr('r', nodeRadius)
            .style('fill', d => getNodeColour(d));
        
        // Update text attributes - only update what changed
        nodeUpdate.select('text')
            .attr('x', d => d.children || d._children ? 
                (textOffset) : Math.abs(textOffset))
            .text(d => d.displayName)
            .transition()
            .duration(duration)
            .style('fill-opacity', 1)
            .style('fill', isDark ? '#ffffff' : '#333333'); // Ensure theme is applied
            
            
            // Reapply hover effects for desktop after update
if (!checkIfMobile()) {
    nodeUpdate.select('text')
        .on('mouseenter', function(event, d) {
            d3.select(this)
                .style('text-decoration', 'underline')
                .style('font-weight', '600');
            
            handleEnhancedMouseOver(event, d);
        })
        .on('mouseleave', function(event, d) {
            d3.select(this)
                .style('text-decoration', 'none')
                .style('font-weight', '500');
            
            handleEnhancedMouseOut(event, d);
        });
}
        
        // EXIT - Remove old nodes
        const nodeExit = node.exit()
            .transition()
            .duration(duration)
            .attr('transform', d => `translate(${source.y},${source.x})`)
            .style('opacity', 0)
            .remove();
        
        nodeExit.select('circle')
            .attr('r', 1e-6);
        
        nodeExit.select('text')
            .style('fill-opacity', 1e-6);
        
        // Update links more efficiently
        updateLinks(links, source, duration);
        
        // Store positions for next transition
        nodes.forEach(d => {
            d.x0 = d.x;
            d.y0 = d.y;
        });
        
        // Apply theme to any newly created elements
        setTimeout(() => {
            if (window.permanentHighlight !== null) {
                highlightNodesByLegend(window.permanentHighlight);
            }
            // Reapply theme to ensure consistency
            reapplyThemeStyles();
        }, duration + 100);
    });
}


function handleMobileNodeTap(event, d) {
    // Always do expand/collapse
    click(event, d);
    
    // Show info for all nodes with lastModified date
    if (d.data.lastModified || d.data.url) {
        showMinimalInfo(d);
    }
}

function showMinimalInfo(d) {
    // Remove any existing info toast
    d3.select(".mobile-info-toast").remove();
    
    const toast = d3.select("body")
        .append("div")
        .attr("class", "mobile-info-toast")
        .style("opacity", 0);
    
    // Calculate freshness - ALIGNED WITH DESKTOP VERSION
    let freshnessClass = '';
    let ageText = '';
    if (d.data.lastModified) {
        const now = new Date();
        const lastMod = new Date(d.data.lastModified);
        const daysSince = Math.floor((now - lastMod) / (1000 * 60 * 60 * 24));
        
        // Match desktop thresholds exactly
        if (daysSince < 30) {
            freshnessClass = 'new';        // Green - New
        } else if (daysSince < 90) {
            freshnessClass = 'fresh';      // Green - Fresh (1-3 months)
        } else if (daysSince < 180) {
            freshnessClass = 'recent';     // Yellow - Recent (3-6 months)
        } else if (daysSince < 365) {
            freshnessClass = 'aging';      // Orange - Aging (6-12 months)
        } else if (daysSince < 730) {
            freshnessClass = 'old';        // Red - Old (1-2 years)
        } else {
            freshnessClass = 'stale';     // Dark Red - Stale (2+ years)
        }
        
        // Format age text
        if (daysSince === 0) {
            ageText = 'Today';
        } else if (daysSince === 1) {
            ageText = 'Yesterday';
        } else if (daysSince < 7) {
            ageText = `${daysSince}d ago`;
        } else if (daysSince < 30) {
            ageText = `${Math.floor(daysSince / 7)}w ago`;
        } else if (daysSince < 365) {
            ageText = `${Math.floor(daysSince / 30)}mo ago`;
        } else {
            ageText = `${Math.floor(daysSince / 365)}y ago`;
        }
    }
    
    // Rest of the function remains the same...
    toast.html(`
        <div class="toast-content ${freshnessClass}">
            <span class="toast-title">${d.data.name}</span>
            ${ageText ? `<span class="toast-age">${ageText}</span>` : ''}
            <a href="${d.data.url}" target="_blank" class="toast-link" onclick="event.stopPropagation();">Visit →</a>
        </div>
    `);
    
    // Animate in
    toast.transition()
        .duration(200)
        .style("opacity", 1);
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        toast.transition()
            .duration(200)
            .style("opacity", 0)
            .on("end", function() {
                d3.select(this).remove();
            });
    }, 3000);
}












// Separate function for link updates
function updateLinks(links, source, duration) {
    const link = g.selectAll('path.link')
        .data(links, d => d.id);
    
    // Enter new links
    const linkEnter = link.enter().insert('path', 'g')
        .attr('class', 'link')
        .attr('d', d => {
            const o = {x: source.x0, y: source.y0};
            return diagonal(o, o);
        });
    
    // Update existing links
    const linkUpdate = linkEnter.merge(link);
    
    linkUpdate.transition()
        .duration(duration)
        .attr('d', d => diagonal(d, d.parent));
    
    // Remove old links
    link.exit().transition()
        .duration(duration)
        .attr('d', d => {
            const o = {x: source.x, y: source.y};
            return diagonal(o, o);
        })
        .remove();
}

// Extract node spacing logic into separate function
function adjustNodeSpacing(nodes) {
    const minNodeSpacing = isMobile ? 30 : 25;
    const familySpacing = isMobile ? 80 : 70;
    
    // Group nodes by depth
    const nodesByDepth = {};
    nodes.forEach(d => {
        if (!nodesByDepth[d.depth]) {
            nodesByDepth[d.depth] = [];
        }
        nodesByDepth[d.depth].push(d);
    });
    
    // Adjust spacing for each depth level
    Object.values(nodesByDepth).forEach(nodesAtDepth => {
        nodesAtDepth.sort((a, b) => a.x - b.x);
        
        for (let i = 1; i < nodesAtDepth.length; i++) {
            const prevNode = nodesAtDepth[i-1];
            const currNode = nodesAtDepth[i];
            const differentParents = prevNode.parent !== currNode.parent;
            const requiredSpacing = differentParents ? familySpacing : minNodeSpacing;
            
            if (currNode.x - prevNode.x < requiredSpacing) {
                currNode.x = prevNode.x + requiredSpacing;
            }
        }
    });
}

// Optimize mouse event handlers
function handleMouseOver(event, d) {
    if (isMobile || !tooltip) return;
    
    // Only show tooltip after a small delay to avoid flicker
    d.tooltipTimeout = setTimeout(() => {
        tooltip.transition().duration(200).style('opacity', .9);
        
        const lastModText = d.data.lastModified ? 
            '<br/>Last Modified: ' + formatDate(new Date(d.data.lastModified)) : '';
        const urlText = d.data.url ? 
            '<br/>URL: ' + d.data.url + '<br/><small>Ctrl+Click to visit</small>' : '<br/>Category';
        
        tooltip.html('<strong>' + d.data.name + '</strong>' + urlText + lastModText)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 28) + 'px');
    }, 300);
}

function handleMouseOut(event, d) {
    if (d.tooltipTimeout) {
        clearTimeout(d.tooltipTimeout);
        d.tooltipTimeout = null;
    }
    if (tooltip) {
        tooltip.transition().duration(500).style('opacity', 0);
    }
}



// Update handleEnhancedMouseOver to skip mobile entirely
function handleEnhancedMouseOver(event, d) {
    // Skip completely on mobile - use click instead
    if (isMobile) return;
    
    // Clear any existing timeout
    if (tooltipTimeout) clearTimeout(tooltipTimeout);
    
    // Show tooltip after short delay
    tooltipTimeout = setTimeout(() => {
        showEnhancedTooltip(event, d);
    }, 300);
}

function handleEnhancedMouseOut(event, d) {
    if (tooltipTimeout) {
        clearTimeout(tooltipTimeout);
        tooltipTimeout = null;
    }
    
    // Don't hide immediately - wait to see if mouse goes to tooltip
    if (hideTooltipTimeout) clearTimeout(hideTooltipTimeout);
    
    hideTooltipTimeout = setTimeout(() => {
        if (!tooltipMouseOver && enhancedTooltip) {
            enhancedTooltip
                .transition()
                .duration(200)
                .style("opacity", 0)
                .on("end", function() {
                    d3.select(this).classed("visible", false);
                });
        }
    }, 100); // Small delay to allow mouse to move to tooltip
}

function showEnhancedTooltip(event, d) {
    if (!enhancedTooltip || !d.data) return;
    
    const data = d.data;
    const now = new Date();
    
    // Calculate freshness
    let freshnessClass = '';
    let freshnessLabel = 'No date';
    if (data.lastModified) {
        const lastMod = new Date(data.lastModified);
        const daysSince = Math.floor((now - lastMod) / (1000 * 60 * 60 * 24));
        
        if (daysSince < 30) {
            freshnessClass = 'freshness-new';
            freshnessLabel = 'New';
        } else if (daysSince < 90) {
            freshnessClass = 'freshness-fresh';
            freshnessLabel = 'Fresh';
        } else if (daysSince < 180) {
            freshnessClass = 'freshness-recent';
            freshnessLabel = 'Recent';
        } else if (daysSince < 365) {
            freshnessClass = 'freshness-aging';
            freshnessLabel = 'Aging';
        } else if (daysSince < 730) {
            freshnessClass = 'freshness-old';
            freshnessLabel = 'Old';
        } else {
            freshnessClass = 'freshness-stale';
            freshnessLabel = 'Stale';
        }
    }
    
    // Calculate descendant count and sibling count
let descendantCount = 0;
let siblingCount = 0;

// Count descendants
function countDescendants(node) {
    if (node.children) {
        descendantCount += node.children.length;
        node.children.forEach(child => countDescendants(child));
    } else if (node._children) {
        descendantCount += node._children.length;
        node._children.forEach(child => countDescendants(child));
    }
}
countDescendants(d);

// Count siblings (nodes at same level with same parent)
if (d.parent) {
    siblingCount = (d.parent.children ? d.parent.children.length : 
                   d.parent._children ? d.parent._children.length : 0) - 1; // Subtract 1 to exclude self
}
    
    // Build popup content
    const isLeaf = !d.children && !d._children;
    const nodeType = d.depth === 0 ? 'Root' : 
                    d.depth === 1 ? 'Language/Category' :
                    isLeaf ? 'Page' : 'Section';
    
    let html = `
        <div class="tooltip-header">
            <span>${data.name}</span>
            <span class="tooltip-freshness ${freshnessClass}">${freshnessLabel}</span>
        </div>
        <div class="tooltip-content">
            <div class="tooltip-stats">
                <div class="tooltip-stat">
                    <div class="tooltip-stat-value">${d.depth}</div>
                    <div class="tooltip-stat-label">Depth Level</div>
                </div>
                <div class="tooltip-stat">
    <div class="tooltip-stat-value">${isLeaf ? siblingCount : descendantCount}</div>
    <div class="tooltip-stat-label">${isLeaf ? 'Sibling Pages' : 'Child Pages'}</div>
</div>
                ${data.pageCount ? `
                <div class="tooltip-stat">
                    <div class="tooltip-stat-value">${data.pageCount}</div>
                    <div class="tooltip-stat-label">Total Pages</div>
                </div>
                ` : ''}
                <div class="tooltip-stat">
                    <div class="tooltip-stat-value">${nodeType}</div>
                    <div class="tooltip-stat-label">Type</div>
                </div>
            </div>
            
            <div class="tooltip-meta">
                ${data.url ? `
                <div class="tooltip-meta-item">
                    <span class="tooltip-meta-icon">🔗</span>
                    <span style="word-break: break-all; color: #1f4788;">${data.url}</span>
                </div>
                ` : ''}
                
                ${data.lastModified ? `
                <div class="tooltip-meta-item">
                    <span class="tooltip-meta-icon">📅</span>
                    <span>Last updated: ${formatDate(new Date(data.lastModified))}</span>
                </div>
                ` : ''}
                
                ${data.fullPath ? `
                <div class="tooltip-meta-item">
                    <span class="tooltip-meta-icon">📍</span>
                    <span>Path: /${data.fullPath}</span>
                </div>
                ` : ''}
            </div>
            
            ${data.url ? `
            <div class="tooltip-actions">
                <a href="${data.url}" target="_blank" class="tooltip-action-btn">
                    <span>🔗</span>
                    <span>Visit Page</span>
                </a>
                <button class="tooltip-action-btn" onclick="window.focusOnNode('${d.id || data.name}')">
                    <span>🎯</span>
                    <span>Focus</span>
                </button>
                <button class="tooltip-action-btn" onclick="window.expandBranch('${d.id || data.name}')">
                    <span>🌳</span>
                    <span>Expand</span>
                </button>
            </div>
            ` : `
            <div class="tooltip-actions">
                <button class="tooltip-action-btn" onclick="window.focusOnNode('${d.id || data.name}')">
                    <span>🎯</span>
                    <span>Focus View</span>
                </button>
                ${!isLeaf ? `
                <button class="tooltip-action-btn" onclick="window.toggleNode('${d.id || data.name}')">
                    <span>${d.children ? '➖' : '➕'}</span>
                    <span>${d.children ? 'Collapse' : 'Expand'}</span>
                </button>
                ` : ''}
            </div>
            `}
        </div>
    `;
    
    enhancedTooltip.html(html);
    
    // Position tooltip
    const tooltipNode = enhancedTooltip.node();
    const tooltipRect = tooltipNode.getBoundingClientRect();
    const pageWidth = window.innerWidth;
    const pageHeight = window.innerHeight;
    
    let left = event.pageX + 15;
    let top = event.pageY - tooltipRect.height / 2;
    
    // Adjust if tooltip goes off screen
    if (left + tooltipRect.width > pageWidth - 20) {
        left = event.pageX - tooltipRect.width - 15;
    }
    
    if (top < 20) {
        top = 20;
    } else if (top + tooltipRect.height > pageHeight - 20) {
        top = pageHeight - tooltipRect.height - 20;
    }
    
    enhancedTooltip
        .style("left", left + "px")
        .style("top", top + "px")
        .style("opacity", 0)
        .classed("visible", true)
        .transition()
        .duration(200)
        .style("opacity", 1);
        
        // Add mouse events to the tooltip itself
    enhancedTooltip
        .on("mouseenter", function() {
            tooltipMouseOver = true;
            if (hideTooltipTimeout) clearTimeout(hideTooltipTimeout);
        })
        .on("mouseleave", function() {
            tooltipMouseOver = false;
            enhancedTooltip
                .transition()
                .duration(200)
                .style("opacity", 0)
                .on("end", function() {
                    d3.select(this).classed("visible", false);
                });
        });

}



// 1. Throttle zoom events for better performance
// In createOptimizedZoom function
function createOptimizedZoom() {
    let zoomTimeout;
    let lastTransform = d3.zoomIdentity;
    
    return d3.zoom()
        .scaleExtent([0.1, 3])
        .filter(function(event) {
            const mobile = checkIfMobile();
            
            if (!mobile) return true;
            
            // On mobile, allow single touches on nodes
            if (event.type.includes('touch')) {
                // Only prevent zoom for multi-touch (pinch)
                if (event.touches && event.touches.length > 1) {
                    return true; // Allow pinch zoom
                }
                
                // For single touch, check if it's on a node
                const target = event.target;
                const isNode = target.tagName === 'circle' || 
                              target.tagName === 'text' || 
                              target.closest('.node');
                
                // If it's a node, prevent zoom but allow the touch to propagate
                if (isNode) {
                    return false;
                }
            }
            
            return true;
        })
        .on("zoom", function(event) {
            lastTransform = event.transform;
            
            if (!zoomTimeout) {
                zoomTimeout = setTimeout(() => {
                    zoomTimeout = null;
                    g.attr("transform", lastTransform);
                }, 16);
            }
        });
}

// 2. Optimize node visibility culling
function cullInvisibleNodes() {
    if (!svg || !g) return;
    
    const bounds = svg.node().getBoundingClientRect();
    const transform = d3.zoomTransform(svg.node());
    
    g.selectAll('g.node').each(function(d) {
        const node = d3.select(this);
        
        // Calculate node position in viewport
        const x = d.y * transform.k + transform.x;
        const y = d.x * transform.k + transform.y;
        
        // Check if node is in viewport (with buffer)
        const buffer = 100;
        const inViewport = 
            x > -buffer && x < bounds.width + buffer &&
            y > -buffer && y < bounds.height + buffer;
        
        // Hide/show based on viewport
        node.style('display', inViewport ? null : 'none');
    });
}

// 3. Debounce resize events
let resizeTimeout;
function optimizedResize() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
        const wasMobile = isMobile;
        updateDimensions();
        
        if (svg && treeData) {
            if (wasMobile !== isMobile) {
                createVisualization();
            } else {
                svg.attr('width', width).attr('height', height);
                tree = d3.tree().size([height - (isMobile ? 40 : 60), width - (isMobile ? 80 : 120)]);
                if (root) update(root);
            }
        }
    }, 250);
}

// 4. Batch DOM updates for stats and dashboard
function batchUpdateStats(updates) {
    // Collect all DOM reads first
    const elements = updates.map(update => ({
        element: document.getElementById(update.id),
        value: update.value,
        property: update.property || 'textContent'
    }));
    
    // Then do all DOM writes in one frame
    requestAnimationFrame(() => {
        elements.forEach(({ element, value, property }) => {
            if (element) {
                element[property] = value;
            }
        });
    });
}

// 5. Optimize search with memoization
const searchCache = new Map();
function memoizedSearch(query) {
    // Check cache first
    if (searchCache.has(query)) {
        return searchCache.get(query);
    }
    
    // Perform search
    const results = performSearch(query);
    
    // Cache results (limit cache size)
    if (searchCache.size > 100) {
        const firstKey = searchCache.keys().next().value;
        searchCache.delete(firstKey);
    }
    searchCache.set(query, results);
    
    return results;
}

// 6. Lazy load tree expansion with visual feedback
function lazyExpandNode(d) {
    // Show loading indicator
    const circle = d3.select(`#node-${d.id} circle`);
    const originalFill = circle.style('fill');
    circle.style('fill', '#ffa500'); // Orange for loading
    
    // Simulate async loading (replace with actual data loading if needed)
    setTimeout(() => {
        if (d._children) {
            d.children = d._children;
            d._children = null;
        }
        
        // Restore original color
        circle.style('fill', originalFill);
        
        // Update tree
        update(d);
    }, 100);
}

// 7. Memory cleanup utility
function cleanupVisualization() {
    // Clear search cache
    searchCache.clear();
    
    // Remove event listeners
    if (svg) {
        svg.on('.zoom', null);
        svg.on('click', null);
    }
    
    // Clear references
    if (g) {
        g.selectAll('*').remove();
    }
    
    // Clear large data structures
    if (window.allPagesData && window.allPagesData.length > 1000) {
        window.allPagesData = null;
    }
    
    // Clear timeouts
    if (resizeTimeout) clearTimeout(resizeTimeout);
    if (searchTimeout) clearTimeout(searchTimeout);
}

        function diagonal(s, d) {
            return 'M ' + s.y + ' ' + s.x + 
                   ' C ' + (s.y + d.y) / 2 + ' ' + s.x + 
                   ', ' + (s.y + d.y) / 2 + ' ' + d.x + 
                   ', ' + d.y + ' ' + d.x;
        }




        function click(event, d) {
    if (d.children) {
        d._children = d.children;
        d.children = null;
    } else {
        d.children = d._children;
        d._children = null;
    }
    
    // Recalculate tree size for better spacing
    if (isMobile && root) {
        const newHeight = calculateDynamicHeight(root);
        tree.size([newHeight - 40, width - 80]);
        
        // Update SVG height
        if (svg) {
            svg.attr("height", newHeight);
        }
    }
    
    update(d);
    updateBreadcrumb(d);
}
    



// Add this function after the addMobileFABs function
function highlightLayoutButton(clickedButton) {
    // Remove active class from all layout buttons
    document.querySelectorAll('.mobile-control-grid.three-col .control-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to clicked button
    clickedButton.classList.add('active');
    
    // Show feedback
    clickedButton.style.transform = 'scale(0.95)';
    setTimeout(() => {
        clickedButton.style.transform = '';
    }, 150);
}



    
        
        
        
        // Calculate dynamic height based on visible nodes
function calculateDynamicHeight(node) {
    let visibleNodes = 0;
    let maxDepthNodes = 0;
    
    function countVisible(n, depth = 0) {
        visibleNodes++;
        
        // Count nodes at each depth to find the most crowded level
        if (n.children) {
            const childrenAtDepth = n.children.length;
            maxDepthNodes = Math.max(maxDepthNodes, childrenAtDepth);
            n.children.forEach(child => countVisible(child, depth + 1));
        }
    }
    
    countVisible(node);
    
    // Calculate height based on the most crowded level
    const nodeSpacing = isMobile ? 40 : 30;
    const baseHeight = isMobile ? 500 : 600;
    const calculatedHeight = Math.max(baseHeight, maxDepthNodes * nodeSpacing + 100);
    
    return Math.min(calculatedHeight, isMobile ? 1000 : 1200);
}




        // Control functions
        window.expandAll = function() {
            clearBreadcrumb();
            function expand(d) {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
                if (d.children) d.children.forEach(expand);
            }
            if (root) {
                expand(root);
                update(root);
            }
        }

        window.collapseAll = function() {
            clearBreadcrumb();
            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d._children.forEach(collapse);
                    d.children = null;
                }
            }
            if (root && root.children) {
                root.children.forEach(collapse);
                update(root);
            }
        }

       window.resetZoom = function() {
    try {
        // Clear search if active
        const searchInput = document.getElementById('searchInput');
        if (searchInput && searchInput.value) {
            clearSearch();
        }
        
        // Clear freshness filter if active
        if (window.activeFreshnessFilter) {
            clearFreshnessFilter();
        }
        
        // Clear legend highlights if active
        if (window.permanentHighlight !== null) {
            clearLegendHighlights();
            window.permanentHighlight = null;
            document.querySelectorAll('.legend-item').forEach(item => {
                item.classList.remove('active');
            });
        }
        
        // Clear breadcrumb
        clearBreadcrumb();
        
        // Reset the zoom and position
        if (!svg || !globalZoom) {
            console.log("Missing svg or globalZoom");
            return;
        }
        
        const scale = isMobile ? 0.6 : 0.8;
        const translateX = 0;
        const translateY = 0;
        
        svg.transition()
            .duration(750)
            .call(
                globalZoom.transform,
                d3.zoomIdentity.scale(scale).translate(translateX, translateY)
            );
            
        // Optional: Show a brief tooltip/notification
        const btn = document.querySelector('.tree-control-btn[aria-label="Reset View"]');
        if (btn) {
            btn.style.background = 'var(--success)';
            btn.style.color = 'white';
            setTimeout(() => {
                btn.style.background = '';
                btn.style.color = '';
            }, 500);
        }
        
    } catch (error) {
        console.error("Error in resetZoom:", error);
    }
}
        
        
        
        // Toggle Freshness View
window.toggleFreshnessView = function() {
    freshnessViewEnabled = !freshnessViewEnabled;
    
    // Clear any active filter when toggling off
    if (!freshnessViewEnabled && activeFreshnessFilter) {
        clearFreshnessFilter();
    }
    
    // Update button state
    const btn = document.getElementById('freshnessToggleBtn');
    if (btn) {
        if (freshnessViewEnabled) {
            btn.style.background = 'var(--primary)';
            btn.style.color = 'white';
            btn.style.borderColor = 'var(--primary)';
        } else {
            btn.style.background = '';
            btn.style.color = '';
            btn.style.borderColor = '';
        }
    }
    
    // Toggle freshness legend
    const existingLegend = document.getElementById('freshnessLegend');
    if (freshnessViewEnabled && !existingLegend) {
        showFreshnessLegend();
    } else if (!freshnessViewEnabled && existingLegend) {
        existingLegend.remove();
    }
    
    // Update node colors
    if (g) {
        g.selectAll('g.node circle')
            .transition()
            .duration(500)
            .style('fill', d => getNodeColour(d));
    }
}

// Show Freshness Legend
// Show Freshness Legend
function showFreshnessLegend() {
    const treeContainer = document.getElementById('treeContainer');
    if (!treeContainer) return;
    
    const legend = document.createElement('div');
    legend.id = 'freshnessLegend';
    
    // Adjust position for mobile
    const isMobileView = window.innerWidth <= 768;
    
    
    legend.style.cssText = `
        position: absolute;
        top: ${isMobileView ? '10px' : '20px'};
        left: ${isMobileView ? '10px' : '20px'};
        background: rgba(255, 255, 255, 0.95);
    border: 1px solid #ddd;
        border-radius: 8px;
        padding: ${isMobileView ? '10px' : '15px'};
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 100;
        font-size: ${isMobileView ? '0.8rem' : '1rem'};
    `;
    
    const freshnessCategories = [
    { days: 30, color: '#2e7d32', label: 'New (< 1 month)', id: 'new' },
    { days: 90, color: '#43a047', label: 'Fresh (1-3 months)', id: 'fresh' },
    { days: 180, color: '#fdd835', label: 'Recent (3-6 months)', id: 'recent' },
    { days: 365, color: '#fb8c00', label: 'Aging (6-12 months)', id: 'aging' },
    { days: 730, color: '#e53935', label: 'Old (1-2 years)', id: 'old' },
    { days: Infinity, color: '#b71c1c', label: 'Stale (> 2 years)', id: 'stale' },
    { days: -1, color: '#9e9e9e', label: 'No date info', id: 'nodate' }
];
    
    let html = `<div style="font-weight: bold; margin-bottom: ${isMobileView ? '8px' : '10px'}; color: #333;">Content Freshness</div>`;
    html += `<div style="display: flex; flex-direction: column; gap: ${isMobileView ? '4px' : '6px'};">`;
    
    freshnessCategories.forEach(cat => {
        html += `
            <div class="freshness-legend-item" 
                 data-freshness-id="${cat.id}"
                 style="display: flex; align-items: center; gap: 8px; 
                        padding: 4px 8px; margin: -4px -8px; border-radius: 4px;
                        cursor: pointer; transition: all 0.2s ease;"
                 onmouseover="this.style.background='rgba(0,0,0,0.05)'"
                 onmouseout="this.style.background='transparent'"
                 onclick="window.filterByFreshness('${cat.id}')">
                <div style="width: ${isMobileView ? '12px' : '16px'}; 
                           height: ${isMobileView ? '12px' : '16px'}; 
                           background: ${cat.color}; 
                           border-radius: 50%;
                           flex-shrink: 0;"></div>
                <span style="font-size: ${isMobileView ? '0.75rem' : '0.85rem'}; 
                            color: #666;">
                    ${cat.label}
                </span>
            </div>
        `;
    });
    
    html += '</div>';
    
    legend.innerHTML = html;
    treeContainer.appendChild(legend);
}




// Add this function after showFreshnessLegend
window.filterByFreshness = function(categoryId) {
    if (!g || !freshnessViewEnabled) return;
    
    // If clicking the same filter, clear it
    if (activeFreshnessFilter === categoryId) {
        clearFreshnessFilter();
        return;
    }
    
    activeFreshnessFilter = categoryId;
    
   // Update legend item styles
document.querySelectorAll('.freshness-legend-item').forEach(item => {
    if (item.dataset.freshnessId === categoryId) {
        item.style.background = 'rgba(0,0,0,0.1)';
        item.style.fontWeight = 'bold';
    } else {
        item.style.background = 'transparent';
        item.style.fontWeight = 'normal';
    }
});
    // Define filter function based on category
    let filterFunction;
    const now = new Date();
    
    switch(categoryId) {
        case 'new':
            filterFunction = (d) => {
                if (!d.data || !d.data.lastModified) return false;
                const daysSince = Math.floor((now - new Date(d.data.lastModified)) / (1000 * 60 * 60 * 24));
                return daysSince < 30;
            };
            break;
        case 'fresh':
            filterFunction = (d) => {
                if (!d.data || !d.data.lastModified) return false;
                const daysSince = Math.floor((now - new Date(d.data.lastModified)) / (1000 * 60 * 60 * 24));
                return daysSince >= 30 && daysSince < 90;
            };
            break;
        case 'recent':
            filterFunction = (d) => {
                if (!d.data || !d.data.lastModified) return false;
                const daysSince = Math.floor((now - new Date(d.data.lastModified)) / (1000 * 60 * 60 * 24));
                return daysSince >= 90 && daysSince < 180;
            };
            break;
        case 'aging':
            filterFunction = (d) => {
                if (!d.data || !d.data.lastModified) return false;
                const daysSince = Math.floor((now - new Date(d.data.lastModified)) / (1000 * 60 * 60 * 24));
                return daysSince >= 180 && daysSince < 365;
            };
            break;
        case 'old':
            filterFunction = (d) => {
                if (!d.data || !d.data.lastModified) return false;
                const daysSince = Math.floor((now - new Date(d.data.lastModified)) / (1000 * 60 * 60 * 24));
                return daysSince >= 365 && daysSince < 730;
            };
            break;
        case 'stale':
            filterFunction = (d) => {
                if (!d.data || !d.data.lastModified) return false;
                const daysSince = Math.floor((now - new Date(d.data.lastModified)) / (1000 * 60 * 60 * 24));
                return daysSince >= 730;
            };
            break;
        case 'nodate':
            filterFunction = (d) => !d.data || !d.data.lastModified;
            break;
    }
    
    // Apply filter
    g.selectAll('g.node')
        .classed('freshness-fade', true)
        .classed('freshness-highlight', false);
    
    g.selectAll('g.node')
        .filter(filterFunction)
        .classed('freshness-highlight', true)
        .classed('freshness-fade', false);
    
    // Fade links too
    g.selectAll('path.link')
        .style('opacity', 0.2);
}

function clearFreshnessFilter() {
    activeFreshnessFilter = null;
    
    // Reset legend items
    document.querySelectorAll('.freshness-legend-item').forEach(item => {
        item.style.background = 'transparent';
        item.style.fontWeight = 'normal';
    });
    
    // Reset node visibility
    if (g) {
        g.selectAll('g.node')
            .classed('freshness-highlight', false)
            .classed('freshness-fade', false);
        
        g.selectAll('path.link')
            .style('opacity', null);
    }
}

        // Search Implementation
        function initializeSearch() {
            // Prevent multiple initializations
            if (searchInitialized) return;
            
            // Get the original input and its container
            const oldInput = document.getElementById('searchInput');
            if (!oldInput) return;
            
            const container = oldInput.parentNode;
            const clearBtn = document.getElementById('searchClearBtn');
            
            // Create a completely fresh input element
            const freshInput = document.createElement('input');
            freshInput.type = 'text';
            freshInput.id = 'searchInput';
            freshInput.className = 'search-input';
            freshInput.placeholder = 'Search pages...';
            freshInput.autocomplete = 'off';
            
            // Apply explicit styles to ensure it works
            freshInput.style.cssText = `
                width: 100%;
                padding: 0.75rem 3rem 0.75rem 1rem;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                outline: none;
                font-size: 1rem;
                background: white;
                color: #333;
                position: relative !important;
                z-index: 10 !important;
                pointer-events: auto !important;
                user-select: text !important;
                -webkit-user-select: text !important;
            `;
            
            // Replace the old input with the fresh one
            container.replaceChild(freshInput, oldInput);
            
            // Now add event listeners to the fresh input
            let searchTimeout = null;
freshInput.addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase().trim();
        
        if (clearBtn) {
            clearBtn.classList.toggle('active', query.length > 0);
        }
        
        // Clear previous timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
    
    if (query.length < 2) {
    searchResults = [];
    currentResultIndex = -1;
    clearHighlights();
    hideSuggestions();
    updateSearchUI();
    return;
}

// Show loading in suggestions
const suggestionsDiv = document.getElementById('searchSuggestions');
if (suggestionsDiv) {
    suggestionsDiv.innerHTML = '<div class="search-suggestion">Searching...</div>';
    suggestionsDiv.style.display = 'block';
}

// Debounce search by 300ms
searchTimeout = setTimeout(() => {
    performSearch(query);
}, 300);
}); 
            
            freshInput.addEventListener('keydown', function(e) {
    const suggestions = document.querySelectorAll('.search-suggestion');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        // Navigate down through suggestions
        if (suggestions.length > 0) {
            const active = document.querySelector('.search-suggestion.active');
            if (!active) {
                suggestions[0].classList.add('active');
            } else {
                const index = Array.from(suggestions).indexOf(active);
                active.classList.remove('active');
                if (index < suggestions.length - 1) {
                    suggestions[index + 1].classList.add('active');
                }
            }
        }
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        // Navigate up through suggestions
        if (suggestions.length > 0) {
            const active = document.querySelector('.search-suggestion.active');
            if (active) {
                const index = Array.from(suggestions).indexOf(active);
                active.classList.remove('active');
                if (index > 0) {
                    suggestions[index - 1].classList.add('active');
                }
            }
        }
    } else if (e.key === 'Enter') {
        const active = document.querySelector('.search-suggestion.active');
        if (active) {
            active.click();
        } else if (searchResults.length > 0) {
            e.preventDefault();
            if (e.shiftKey) {
                navigateToPreviousResult();
            } else {
                navigateToNextResult();
            }
        }
    } else if (e.key === 'Escape') {
        e.preventDefault();
        clearSearch();
        freshInput.blur();
    }
});
            
            // Add the document click listener for closing suggestions
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-wrapper')) {
                    hideSuggestions();
                }
            });
            
            // Mark as initialized
            searchInitialized = true;
            
            // Focus the fresh input
            freshInput.focus();
            
            console.log('Search initialized successfully');
        }

        function performSearch(query) {
            if (!allNodes || allNodes.length === 0) {
                if (root && root.descendants) {
                    allNodes = root.descendants();
                } else {
                    return;
                }
            }
            
            searchResults = allNodes.filter(node => {
                if (!node || !node.data) return false;
                
                const nameMatch = node.data.name && node.data.name.toLowerCase().includes(query);
                const urlMatch = node.data.url && node.data.url.toLowerCase().includes(query);
                return nameMatch || urlMatch;
            });
            
            searchResults.sort((a, b) => {
    const aIsLeaf = !a.children && !a._children;
    const bIsLeaf = !b.children && !b._children;
    const aName = a.data.name.toLowerCase();
    const bName = b.data.name.toLowerCase();
    
    // 1. Exact matches first
    const aExact = aName === query;
    const bExact = bName === query;
    if (aExact && !bExact) return -1;
    if (!aExact && bExact) return 1;
    
    // 2. Leaf nodes that start with query
    const aStartsWith = aName.startsWith(query);
    const bStartsWith = bName.startsWith(query);
    if (aIsLeaf && aStartsWith && !(bIsLeaf && bStartsWith)) return -1;
    if (bIsLeaf && bStartsWith && !(aIsLeaf && aStartsWith)) return 1;
    
    // 3. Any leaf nodes before categories
    if (aIsLeaf && !bIsLeaf) return -1;
    if (!aIsLeaf && bIsLeaf) return 1;
    
    // 4. For same type, prefer matches at start of string
    if (aStartsWith && !bStartsWith) return -1;
    if (!aStartsWith && bStartsWith) return 1;
    
    // 5. Finally, sort by depth (shallower first)
    return a.depth - b.depth;
});
            
            updateSearchUI();
            showSuggestions(searchResults.slice(0, 80));
            highlightSearchResults();
            
            if (searchResults.length > 0) {
                currentResultIndex = 0;
                navigateToResult(0);
            }
        }

        function highlightSearchResults() {
            clearHighlights();
            
            if (searchResults.length === 0) return;
            
            g.selectAll('g.node')
                .classed('search-result', d => searchResults.includes(d))
                .classed('search-path', false)
                .classed('search-current', false);
            
            searchResults.forEach(resultNode => {
                let current = resultNode;
                const pathNodes = [];
                
                while (current) {
                    pathNodes.push(current);
                    current = current.parent;
                }
                
                g.selectAll('g.node')
                    .filter(d => pathNodes.includes(d) && !searchResults.includes(d))
                    .classed('search-path', true);
                
                g.selectAll('path.link')
                    .classed('search-path', d => {
                        return pathNodes.includes(d) && pathNodes.includes(d.parent);
                    });
            });
            
            if (currentResultIndex >= 0 && currentResultIndex < searchResults.length) {
                g.selectAll('g.node')
                    .filter(d => d === searchResults[currentResultIndex])
                    .classed('search-current', true);
            }
        }

        function navigateToResult(index) {
            if (index < 0 || index >= searchResults.length) return;
            
            currentResultIndex = index;
            const targetNode = searchResults[index];
            
            expandPathToNode(targetNode);
            update(root);
            
            setTimeout(() => {
                panToNode(targetNode);
                highlightSearchResults();
                updateBreadcrumb(targetNode);
                updateSearchUI();
            }, 800);
        }

        function expandPathToNode(targetNode) {
    const path = [];
    let current = targetNode;
    
    while (current) {
        path.unshift(current);
        current = current.parent;
    }
    
    path.forEach(node => {
        // For "What's New" node, we keep it collapsed but still process it
        if (node.data && node.data.name && node.data.name.toLowerCase() === 'whats new') {
            // Don't expand it, but don't skip processing entirely
            // This maintains the tree structure
        } else if (node._children) {
            // Expand all other nodes normally
            node.children = node._children;
            node._children = null;
        }
    });
}

        function navigateToNextResult() {
            if (searchResults.length === 0) return;
            
            const nextIndex = (currentResultIndex + 1) % searchResults.length;
            navigateToResult(nextIndex);
        }

        function navigateToPreviousResult() {
            if (searchResults.length === 0) return;
            
            const prevIndex = currentResultIndex - 1 < 0 ? searchResults.length - 1 : currentResultIndex - 1;
            navigateToResult(prevIndex);
        }

        function updateSearchUI() {
            const resultsInfo = document.getElementById('searchResultsInfo');
            const searchNav = document.getElementById('searchNavigation');
            const prevBtn = document.getElementById('searchPrevBtn');
            const nextBtn = document.getElementById('searchNextBtn');
            
            if (!resultsInfo || !searchNav) return;
            
            if (searchResults.length > 0) {
                resultsInfo.style.display = 'block';
                resultsInfo.textContent = `${currentResultIndex + 1}/${searchResults.length}`;
                
                if (searchResults.length > 1) {
                    searchNav.classList.add('show');
                    if (prevBtn) prevBtn.disabled = false;
                    if (nextBtn) nextBtn.disabled = false;
                } else {
                    searchNav.classList.remove('show');
                }
            } else {
                resultsInfo.style.display = 'none';
                searchNav.classList.remove('show');
            }
        }
        
        
        

        function showSuggestions(results) {
    const suggestionsDiv = document.getElementById('searchSuggestions');
    if (!suggestionsDiv) return;
    
    if (results.length === 0) {
        suggestionsDiv.innerHTML = '<div class="search-suggestion">No results found</div>';
        suggestionsDiv.style.display = 'block';
        return;
    }
    
    let html = '';
    const now = new Date(); // ← ADD THIS LINE HERE!
    // In showSuggestions, modify the HTML generation:
results.slice(0, 10).forEach((node, index) => {
        const path = getNodePath(node);
        const isLeaf = !node.children && !node._children;
        const icon = isLeaf ? '📄' : '📁';
        
        // Calculate freshness
        // Calculate freshness (matching the rest of the app)
let freshnessIndicator = '';
if (node.data.lastModified) {
    const lastMod = new Date(node.data.lastModified);
    const daysSince = Math.floor((now - lastMod) / (1000 * 60 * 60 * 24));
    
    let color;
    let timeText = '';
    
    // Match the exact thresholds from getNodeColour
    if (daysSince < 30) {
        color = '#2e7d32'; // Dark green - New
    } else if (daysSince < 90) {
        color = '#43a047'; // Medium green - Fresh
    } else if (daysSince < 180) {
        color = '#fdd835'; // Bright yellow - Recent
    } else if (daysSince < 365) {
        color = '#fb8c00'; // Bright orange - Aging
    } else if (daysSince < 730) {
        color = '#e53935'; // Bright red - Old
    } else {
        color = '#b71c1c'; // Dark red - Stale
    }
    
    // Format the time text
    if (daysSince === 0) {
        timeText = 'today';
    } else if (daysSince === 1) {
        timeText = 'yesterday';
    } else if (daysSince < 7) {
        timeText = `${daysSince}d ago`;
    } else if (daysSince < 30) {
        timeText = `${Math.floor(daysSince / 7)}w ago`;
    } else if (daysSince < 365) {
        timeText = `${Math.floor(daysSince / 30)}mo ago`;
    } else {
        timeText = `${Math.floor(daysSince / 365)}y ago`;
    }
    
    freshnessIndicator = `<span style="color: ${color}; font-size: 0.75rem;">• ${timeText}</span>`;
}
        
        html += `
    <div class="search-suggestion" onclick="selectSuggestion(${index})">
        <div class="search-suggestion-name">
            <span style="margin-right: 0px;">${icon}</span>
            ${node.data.name}
        </div>
        ${freshnessIndicator ? `<div style="margin-left: 28px; margin-top: 4px;">${freshnessIndicator}</div>` : ''}
        <div class="search-suggestion-path">${path}</div>
    </div>
`;
    });
    
    suggestionsDiv.innerHTML = html;
    suggestionsDiv.style.display = 'block';
    
    // Make sure it's visible and positioned correctly
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        const inputRect = searchInput.getBoundingClientRect();
        const containerRect = searchInput.closest('.search-wrapper').getBoundingClientRect();
        
        // Position suggestions relative to the search wrapper
        suggestionsDiv.style.position = 'absolute';
        suggestionsDiv.style.top = (inputRect.bottom - containerRect.top) + 'px';
        suggestionsDiv.style.left = '0';
        suggestionsDiv.style.right = '0';
    }
}

        function hideSuggestions() {
            const suggestionsDiv = document.getElementById('searchSuggestions');
            if (suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }
        }

        function selectSuggestion(index) {
            if (index >= 0 && index < searchResults.length) {
                currentResultIndex = index;
                navigateToResult(index);
                hideSuggestions();
                
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.value = searchResults[index].data.name;
                }
            }
        }

        function getNodePath(node) {
            const path = [];
            let current = node.parent;
            
            while (current && current.parent) {
                path.unshift(current.data.name);
                current = current.parent;
            }
            
            return path.join(' › ');
        }

        function clearHighlights() {
            if (!g) return;
            
            g.selectAll('g.node')
                .classed('search-result', false)
                .classed('search-path', false)
                .classed('search-current', false);
            
            g.selectAll('path.link')
                .classed('search-path', false);
        }

        function clearSearchResults() {
            searchResults = [];
            currentResultIndex = -1;
            
            clearHighlights();
            hideSuggestions();
            updateSearchUI();
            
            const searchNav = document.getElementById('searchNavigation');
            if (searchNav) {
                searchNav.classList.remove('show');
            }
        }

        window.clearSearch = function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
                // Make sure the input remains functional
                searchInput.focus();
            }
            
            clearSearchResults();
            
            const clearBtn = document.getElementById('searchClearBtn');
            if (clearBtn) {
                clearBtn.classList.remove('active');
            }
        }

        // Global functions for button onclick
        window.navigateToNextResult = navigateToNextResult;
        window.navigateToPreviousResult = navigateToPreviousResult;
        window.selectSuggestion = selectSuggestion;

        // Manual search reinitialization (for debugging)
        window.reinitializeSearch = function() {
            searchInitialized = false;
            initializeSearch();
        }

        // Breadcrumb Navigation Functions
        function updateBreadcrumb(node) {
            const breadcrumbContainer = document.getElementById('breadcrumbContainer');
            const breadcrumb = document.getElementById('breadcrumb');
            
            if (!breadcrumbContainer || !breadcrumb) return;
            
            const path = [];
            let current = node;
            while (current) {
                path.unshift(current);
                current = current.parent;
            }
            
            breadcrumb.innerHTML = '';
            breadcrumbContainer.style.display = 'block';
            
            path.forEach((item, index) => {
                const breadcrumbItem = document.createElement('div');
                breadcrumbItem.className = 'breadcrumb-item';
                
                const crumb = document.createElement('span');
                crumb.className = 'breadcrumb-crumb';
                if (index === path.length - 1) {
                    crumb.classList.add('current');
                }
                
                const displayName = item.data.name; // Just use the full name
crumb.textContent = displayName;
crumb.title = item.data.name;
                
                if (index < path.length - 1) {
                    crumb.style.cursor = 'pointer';
                    crumb.onclick = function() {
                        navigateToNode(item);
                    };
                }
                
                breadcrumbItem.appendChild(crumb);
                
                if (index < path.length - 1) {
                    const separator = document.createElement('span');
                    separator.className = 'breadcrumb-separator';
                    separator.textContent = '›';
                    breadcrumbItem.appendChild(separator);
                }
                
                breadcrumb.appendChild(breadcrumbItem);
            });
        }

        function navigateToNode(targetNode) {
            let current = targetNode;
            const nodesToExpand = [];
            
            while (current.parent) {
                nodesToExpand.unshift(current.parent);
                current = current.parent;
            }
            
            nodesToExpand.forEach(node => {
                if (node._children) {
                    node.children = node._children;
                    node._children = null;
                }
            });
            
            update(targetNode);
            
            setTimeout(() => {
                panToNode(targetNode);
                highlightNode(targetNode);
                updateBreadcrumb(targetNode);
            }, 800);
        }

        function panToNode(node) {
            if (!svg || !node) return;
            
            const transform = d3.zoomTransform(svg.node());
            
            const x = -node.y + width / 2;
            const y = -node.x + height / 2;
            
            svg.transition()
                .duration(750)
                .call(
                    d3.zoom().transform,
                    d3.zoomIdentity
                        .translate(x, y)
                        .scale(transform.k)
                );
        }

        function highlightNode(node) {
            g.selectAll('g.node circle')
                .style('stroke', '#fff')
                .style('stroke-width', '2px');
            
            g.selectAll('g.node')
                .filter(d => d === node)
                .select('circle')
                .style('stroke', '#ff4d4f')
                .style('stroke-width', '4px')
                .transition()
                .duration(2000)
                .style('stroke', '#fff')
                .style('stroke-width', '2px');
        }

        function clearBreadcrumb() {
            const breadcrumbContainer = document.getElementById('breadcrumbContainer');
            if (breadcrumbContainer) {
                breadcrumbContainer.style.display = 'none';
            }
        }

        // Export functions
        window.exportSVG = function() {
    const svgElement = document.querySelector('#treeContainer > svg');
    if (!svgElement) {
        alert('No visualization found. Please upload a sitemap first.');
        return;
    }
    
    const svgClone = svgElement.cloneNode(true);
    
    svgClone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    svgClone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
    
    // Check if dark mode is active
    const isDark = document.body.classList.contains('dark-theme');
    
    const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    bg.setAttribute('width', svgElement.getAttribute('width'));
    bg.setAttribute('height', svgElement.getAttribute('height'));
    bg.setAttribute('fill', isDark ? '#111827' : 'white'); // Dark gray for dark mode
    svgClone.insertBefore(bg, svgClone.firstChild);
    
    const styles = `
        .node circle { stroke: ${isDark ? '#374151' : '#fff'}; stroke-width: 2px; }
        .node text { 
            font-family: 'Segoe UI', sans-serif; 
            font-size: 12px; 
            fill: ${isDark ? '#ffffff' : '#333333'}; 
        }
        .link { 
            fill: none; 
            stroke: ${isDark ? '#4b5563' : '#999'}; 
            stroke-opacity: 0.6; 
            stroke-width: 2px; 
        }
    `;
    const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style');
    styleElement.textContent = styles;
    svgClone.insertBefore(styleElement, svgClone.firstChild);
    
    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(svgClone);
    
    const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = 'sitemap-tree-' + new Date().toISOString().split('T')[0] + '.svg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setTimeout(() => URL.revokeObjectURL(url), 100);
}
        
        window.exportPNG = function() {
    const svgElement = document.querySelector('#treeContainer > svg');
    if (!svgElement) {
        alert('No visualization found. Please upload a sitemap first.');
        return;
    }
    
    const svgWidth = parseInt(svgElement.getAttribute('width')) || 800;
    const svgHeight = parseInt(svgElement.getAttribute('height')) || 600;
    
    const svgClone = svgElement.cloneNode(true);
    svgClone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    svgClone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
    
    // Check if dark mode is active
    const isDark = document.body.classList.contains('dark-theme');
    
    const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    bg.setAttribute('width', svgWidth);
    bg.setAttribute('height', svgHeight);
    bg.setAttribute('fill', isDark ? '#111827' : 'white');
    svgClone.insertBefore(bg, svgClone.firstChild);
    
    const styles = `
        .node circle { stroke: ${isDark ? '#374151' : '#fff'}; stroke-width: 2px; }
        .node text { 
            font-family: 'Segoe UI', sans-serif; 
            font-size: 12px; 
            fill: ${isDark ? '#ffffff' : '#333333'}; 
        }
        .link { 
            fill: none; 
            stroke: ${isDark ? '#4b5563' : '#999'}; 
            stroke-opacity: 0.6; 
            stroke-width: 2px; 
        }
    `;
    const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style');
    styleElement.textContent = styles;
    svgClone.insertBefore(styleElement, svgClone.firstChild);
    
    const canvas = document.createElement('canvas');
    const scale = 2;
    canvas.width = svgWidth * scale;
    canvas.height = svgHeight * scale;
    const ctx = canvas.getContext('2d');
    
    // Fill canvas with appropriate background color
    ctx.fillStyle = isDark ? '#111827' : 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(svgClone);
    const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
    const svgUrl = URL.createObjectURL(svgBlob);
    
    const img = new Image();
    img.onload = function() {
        ctx.scale(scale, scale);
        ctx.drawImage(img, 0, 0, svgWidth, svgHeight);
        
        URL.revokeObjectURL(svgUrl);
        
        canvas.toBlob(function(blob) {
            if (!blob) {
                alert('Error creating PNG. Please try again.');
                return;
            }
            
            const pngUrl = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = pngUrl;
            link.download = 'sitemap-tree-' + new Date().toISOString().split('T')[0] + '.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            setTimeout(() => URL.revokeObjectURL(pngUrl), 100);
        }, 'image/png', 1.0);
    };
    
    img.onerror = function() {
        console.error('Error loading SVG for PNG conversion');
        alert('Error converting to PNG. This might be due to browser security restrictions. Please try the SVG export instead.');
        URL.revokeObjectURL(svgUrl);
    };
    
    img.src = svgUrl;
}

        // View switching
        // Update your switchView function with this approach:
window.switchView = function(viewType) {
    console.log('Switching from', currentView, 'to', viewType);
    
    // CRITICAL: Clean up 3D view FIRST if it's active
    if (is3DViewActive) {
        console.log('Cleaning up 3D view...');
        is3DViewActive = false;
        
        // Clean up 3D labels specifically
        if (window.cleanup3DLabels) {
            window.cleanup3DLabels();
        }
        
        // Stop all animations
        if (autoRotateInterval) {
            clearInterval(autoRotateInterval);
            autoRotateInterval = null;
        }
        
        if (flyThroughTimeout) {
            clearTimeout(flyThroughTimeout);
            flyThroughTimeout = null;
        }
        
        // Destroy 3D graph
        if (Graph3D) {
            try {
                Graph3D._destructor();
            } catch (e) {
                console.error('Error destroying Graph3D:', e);
            }
            Graph3D = null;
        }
        
        // Clear data
        graphData = null;
        if (currentHighlightedNodes) currentHighlightedNodes.clear();
        
        // CRITICAL: Clear and hide the 3D container
        const container3D = document.getElementById('3d-graph-container');
        if (container3D) {
            container3D.innerHTML = ''; // Clear all content
            container3D.style.display = 'none';
        }
    }
    
    // Clean up any existing 2D visualization
    cleanupVisualization();
    
    // Update current view AFTER cleanup
    currentView = viewType;
    document.body.setAttribute('data-view', viewType);
    
    // Clear breadcrumb
    clearBreadcrumb();
    
    // Update navigation buttons
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    
    // Get common container references
    const treeContainer = document.getElementById('treeContainer');
    const stats = document.getElementById('stats');
    const legend = document.getElementById('colourLegend');
    const container3D = document.getElementById('3d-graph-container');
    
    // Handle each view type
    if (viewType === 'tree') {
        console.log('Setting up tree view');
        
        // Activate tree button
        const treeBtn = document.getElementById('treeViewBtn');
        if (treeBtn) treeBtn.classList.add('active');
        
        // Show tree container
        if (treeContainer) {
            treeContainer.style.display = 'block';
            treeContainer.style.visibility = 'visible';
            treeContainer.style.opacity = '1';
            treeContainer.innerHTML = ''; // Clear it first
        }
        
        // Show tree UI elements
        if (stats && treeData) {
            stats.style.display = 'flex';
            stats.style.height = '';
            stats.style.margin = '';
            stats.style.padding = '';
        }
        
        if (legend && treeData) {
            legend.style.display = 'flex';
            legend.style.height = '';
            legend.style.margin = '';
            legend.style.padding = '';
        }
        
        // Hide 3D container
        if (container3D) container3D.style.display = 'none';
        
        // Create tree visualization if we have data
        if (treeData) {
            setTimeout(() => {
                createVisualization();
                
                // IMPORTANT: Reapply theme after creating visualization
                setTimeout(() => {
                    reapplyThemeStyles();
                    
                    // Initialize search
                    searchInitialized = false;
                    initializeSearch();
                }, 100);
            }, 50);
        } else {
            showViewPreview('tree');
        }
        
    } else if (viewType === 'dashboard') {
        console.log('Setting up dashboard view');
        
        // Activate dashboard button
        const dashBtn = document.getElementById('dashboardViewBtn');
        if (dashBtn) dashBtn.classList.add('active');
        
        // Hide other elements
        if (stats) stats.style.display = 'none';
        if (legend) legend.style.display = 'none';
        if (container3D) container3D.style.display = 'none';
        
        // IMPORTANT: Ensure tree container is visible BEFORE creating dashboard
        if (treeContainer) {
            treeContainer.style.display = 'block';
            treeContainer.style.visibility = 'visible';
            treeContainer.style.opacity = '1';
            treeContainer.innerHTML = ''; // Clear content
            
            if (treeData) {
                // Small delay to ensure DOM updates
                setTimeout(() => {
                    createDashboardVisualisation();
                    
                    // Apply theme to dashboard elements
                    setTimeout(() => {
                        reapplyThemeStyles();
                    }, 100);
                }, 50);
            } else {
                showViewPreview('dashboard');
            }
        } else {
            console.error('No tree container found for dashboard!');
        }
        
    } else if (viewType === '3d') {
        console.log('Setting up 3D view');
        
        // Activate 3D button
        const threeDBtn = document.getElementById('3dViewBtn');
        if (threeDBtn) threeDBtn.classList.add('active');
        
        // Hide other containers
        if (treeContainer) treeContainer.style.display = 'none';
        if (stats) stats.style.display = 'none';
        if (legend) legend.style.display = 'none';
        
        // Show 3D view
        if (treeData) {
            show3DView();
        } else {
            alert('Please load a sitemap first');
        }
    }
    
    // Update mobile menu buttons
    const mobileTreeBtn = document.getElementById('mobileTreeBtn');
    const mobileDashBtn = document.getElementById('mobileDashboardBtn');
    if (mobileTreeBtn) mobileTreeBtn.classList.toggle('active', viewType === 'tree');
    if (mobileDashBtn) mobileDashBtn.classList.toggle('active', viewType === 'dashboard');
}
        
        
        

        function showViewPreview(viewType) {
    d3.select("#treeContainer").selectAll("*").remove();
    
    const container = d3.select("#treeContainer");
    const isDark = document.body.classList.contains('dark-theme');
    
    if (viewType === 'dashboard') {
        container.append("div")
            .attr("class", "dashboard-placeholder")
            .style("width", "100%")
            .style("height", "400px")
            .style("background", isDark ? 
                "linear-gradient(135deg, #374151 0%, #1f2937 100%)" : 
                "linear-gradient(135deg, #667eea 0%, #764ba2 100%)")
            .style("display", "flex")
            .style("flex-direction", "column")
            .style("align-items", "center")
            .style("justify-content", "center")
            .style("color", "white")
            .style("font-size", "24px")
            .style("font-weight", "bold")
            .style("border-radius", "15px")
            .style("margin", "20px")
            .each(function() {
                d3.select(this).append("div")
                    .attr("class", "placeholder-icon")
                    .style("font-size", "4rem")
                    .style("margin-bottom", "20px")
                    .text("📊");
                
                d3.select(this).append("div")
                    .attr("class", "placeholder-title")
                    .text("Analytics Dashboard");
                
                d3.select(this).append("div")
                    .attr("class", "placeholder-subtitle")
                    .style("font-size", "16px")
                    .style("margin-top", "10px")
                    .style("opacity", "0.9")
                    .text("Upload sitemap to see comprehensive analytics");
            });
    } else {
        container.append("div")
            .attr("class", "tree-placeholder")
            .style("height", "400px")
            .style("background", isDark ? "var(--gray-800)" : "#f8f9ff")
            .style("border", isDark ? "2px solid var(--gray-700)" : "2px solid #4a90e2")
            .style("display", "flex")
            .style("flex-direction", "column")
            .style("align-items", "center")
            .style("justify-content", "center")
            .style("color", isDark ? "var(--gray-100)" : "#1f4788")
            .style("font-size", "24px")
            .style("font-weight", "bold")
            .style("border-radius", "15px")
            .style("margin", "20px")
            .each(function() {
                d3.select(this).append("div")
                    .attr("class", "placeholder-icon")
                    .style("font-size", "4rem")
                    .style("margin-bottom", "20px")
                    .text("🌳");
                
                d3.select(this).append("div")
                    .attr("class", "placeholder-title")
                    .text("Tree Visualisation");
                
                d3.select(this).append("div")
                    .attr("class", "placeholder-subtitle")
                    .style("font-size", "16px")
                    .style("margin-top", "10px")
                    .style("opacity", isDark ? "0.7" : "0.8")
                    .style("color", isDark ? "var(--gray-400)" : "#666")
                    .text("Upload sitemap to see interactive tree");
            });
    }
}
        
        
        
        
        
        
        
        

       function createDashboardVisualisation() {
    console.log('Creating dashboard visualization');
    
    // Get the container and ensure it's visible
    const treeContainer = document.getElementById('treeContainer');
    if (!treeContainer) {
        console.error('No tree container found!');
        return;
    }
    
    // IMPORTANT: Make sure container is visible
    treeContainer.style.display = 'block';
    treeContainer.style.visibility = 'visible';
    treeContainer.style.opacity = '1';
    
    // Clear previous content
    d3.select("#treeContainer").selectAll("*").remove();
    
    const isDark = document.body.classList.contains('dark-theme');
    
    // Reset container styles
    treeContainer.style.marginTop = '0';
    treeContainer.style.paddingTop = '0';
    treeContainer.style.background = isDark ? 'var(--gray-900)' : 'var(--gray-50)';
    
    const container = d3.select("#treeContainer")
        .append("div")
        .attr("class", "dashboard")
        .style("margin-top", "20px")  // FIX: Add 'px' units
        .style("padding-top", "20px"); // FIX: Add 'px' units
    
    // Add a test element to verify rendering
    console.log('Dashboard container created:', !!container.node());
    
    // Dashboard header
    const header = container.append("div")
        .attr("class", "dashboard-header");
    
    header.append("h2")
        .text("📊 Site Analytics Dashboard");
    
    header.append("div")
        .attr("class", "dashboard-subtitle")
        .text(`Comprehensive analysis of ${siteStats.totalPages.toLocaleString()} pages across ${siteStats.categoryCount} categories`);
    
            // Key metrics
            createMetricsSection(container);
            
            // Charts section
            createChartsSection(container);
            
            // Insights and recommendations
            createInsightsSection(container);
        }

        function createMetricsSection(container) {
    // First, add the responsive styles to the dashboard
    const styleElement = container.append("style")
        .text(`
            .dashboard-metrics-grid {
                display: grid !important;
                grid-template-columns: repeat(6, 1fr) !important;
                gap: 20px !important;
                margin-bottom: 30px !important;
            }
            
            @media (max-width: 1400px) {
                .dashboard-metrics-grid {
                    grid-template-columns: repeat(3, 1fr) !important;
                }
            }
            
            @media (max-width: 768px) {
                .dashboard-metrics-grid {
                    grid-template-columns: repeat(2, 1fr) !important;
                    gap: 15px !important;
                }
            }
            
            @media (max-width: 480px) {
                .dashboard-metrics-grid {
                    grid-template-columns: repeat(1, 1fr) !important;
                }
            }
        `);
    
    const metricsSection = container.append("div")
        .attr("class", "dashboard-metrics-grid");
    
    const metrics = [
        {
            value: siteStats.totalPages.toLocaleString(),
            label: "Total Pages",
            change: "Indexed Content",
            changeType: "neutral"
        },
        {
            value: siteStats.categoryCount,
            label: "Main Categories",
            change: "Content Sections",
            changeType: "neutral"
        },
        {
            value: siteStats.maxDepth,
            label: "Maximum Depth",
            change: siteStats.maxDepth <= 4 ? "Optimal" : "Review Needed",
            changeType: siteStats.maxDepth <= 4 ? "positive" : "neutral"
        },
        {
            value: siteStats.avgDepth,
            label: "Average Depth",
            change: "Navigation Level",
            changeType: "neutral"
        },
        {
            value: siteAnalysis.score + "/100",
            label: "Structure Score",
            change: siteAnalysis.score >= 80 ? "Excellent" : siteAnalysis.score >= 60 ? "Good" : "Needs Work",
            changeType: siteAnalysis.score >= 80 ? "positive" : "neutral"
        },
        {
            value: siteStats.largestCategory.percentage + "%",
            label: "Largest Category",
            change: siteStats.largestCategory.name,
            changeType: "neutral"
        }
    ];
    
    metrics.forEach(metric => {
        const card = metricsSection.append("div")
            .attr("class", "metric-card");
        
        card.append("div")
            .attr("class", "metric-value")
            .text(metric.value);
        
        card.append("div")
            .attr("class", "metric-label")
            .text(metric.label);
        
        card.append("div")
            .attr("class", `metric-change ${metric.changeType}`)
            .text(metric.change);
    });
}

        function createChartsSection(container) {
            const chartsSection = container.append("div")
                .attr("class", "charts-section");
            
            // Language comparison section
            if (siteStats.languageStats && siteStats.languageStats.length > 1) {
                const langSection = chartsSection.append("div")
                    .style("margin-bottom", "30px");
                
                langSection.append("h3")
                    .style("color", "#1f4788")
                    .style("text-align", "center")
                    .style("margin-bottom", "20px")
                    .text("🌐 Language Distribution");
                
                const langGrid = langSection.append("div")
                    .style("display", "grid")
                    .style("grid-template-columns", "repeat(auto-fit, minmax(300px, 1fr))")
                    .style("gap", "20px");
                
                siteStats.languageStats.forEach(lang => {
                    const langCard = langGrid.append("div")
                        .attr("class", "chart-card")
                        .style("border-left", `4px solid ${lang.name === 'en' ? '#4a90e2' : '#7fb069'}`);
                    
                    langCard.append("h4")
                        .style("color", "#1f4788")
                        .style("margin-bottom", "15px")
                        .style("display", "flex")
                        .style("align-items", "center")
                        .style("justify-content", "space-between")
                        .html(`${lang.name.toUpperCase()} (${lang.name === 'en' ? 'English' : 'Irish'}) 
                               <span style="font-size: 1.5rem; font-weight: bold; color: ${lang.name === 'en' ? '#4a90e2' : '#7fb069'};">
                                   ${lang.pages.toLocaleString()}
                               </span>`);
                    
                    langCard.append("div")
                        .style("font-size", "0.9rem")
                        .style("color", "#666")
                        .style("margin-bottom", "10px")
                        .text(`${lang.percentage}% of total content • ${lang.categories} categories • Max depth: ${lang.maxDepth}`);
                    
                    // Progress bar for language
                    const langProgress = langCard.append("div")
                        .attr("class", "progress-bar-container")
                        .style("margin-bottom", "15px");
                    
                    langProgress.append("div")
                        .attr("class", "progress-bar-fill")
                        .style("background", lang.name === 'en' ? '#4a90e2' : '#7fb069')
                        .transition().duration(1000)
                        .style("width", `${lang.percentage}%`);
                    
                    // All categories with bar chart style
                    const allCats = Object.values(lang.children)
                        .sort((a, b) => b.pages - a.pages);
                    
                    langCard.append("div")
                        .style("font-size", "0.85rem")
                        .style("font-weight", "bold")
                        .style("color", "#1f4788")
                        .style("margin-bottom", "10px")
                        .text(`Content Categories (${lang.categories}):`);
                    
                    // Create scrollable container for categories
                    const catContainer = langCard.append("div")
                        .style("max-height", "400px")
                        .style("overflow-y", "auto")
                        .style("padding-right", "5px");
                    
                    const maxPages = Math.max(...allCats.map(c => c.pages));
                    
                    allCats.forEach((cat, i) => {
                        const item = catContainer.append("div")
                            .style("margin-bottom", "10px");
                        
                        const header = item.append("div")
                            .style("display", "flex")
                            .style("justify-content", "space-between")
                            .style("align-items", "center")
                            .style("margin-bottom", "4px");
                        
                        header.append("span")
                            .style("font-size", "11px")
                            .style("color", "#1f4788")
                            .style("font-weight", "500")
                            .style("flex", "1")
                            .style("overflow", "hidden")
                            .style("text-overflow", "ellipsis")
                            .style("white-space", "nowrap")
                            .style("margin-right", "8px")
                            .attr("title", cat.name)
                            .text(cat.name);
                        
                        header.append("span")
                            .style("font-size", "11px")
                            .style("color", "#666")
                            .style("white-space", "nowrap")
                            .text(`${cat.pages} pages (${cat.langPercentage}%)`);
                        
                        const progressContainer = item.append("div")
                            .attr("class", "progress-bar-container")
                            .style("height", "6px");
                        
                        progressContainer.append("div")
                            .attr("class", "progress-bar-fill")
                            .style("background", lang.name === 'en' ? 
                                `hsl(${200 + (i % 20) * 10}, 70%, 60%)` : 
                                `hsl(${120 + (i % 20) * 10}, 50%, 55%)`)
                            .transition()
                            .duration(800)
                            .delay(i * 20)
                            .style("width", `${(cat.pages / maxPages) * 100}%`);
                    });
                });
            }
            
            const chartsGrid = chartsSection.append("div")
                .attr("class", "charts-grid")
                .style("grid-template-columns", "1fr")  // Single column since we removed one chart
                .style("max-width", "600px")
                .style("margin", "0 auto 20px");
            
            // Depth distribution chart
            const depthChart = chartsGrid.append("div")
                .attr("class", "chart-card");
            
            depthChart.append("div")
                .attr("class", "chart-title")
                .text("📈 Pages by Depth Level");
            
            createDepthChart(depthChart);
        }

        function createEnglishCategoryChart(container) {
            // Filter for English categories only
            const englishCategories = siteStats.categoryStats
                .filter(cat => cat.language === 'en')
                .slice(0, 8); // Show top 8 English categories
            
            if (englishCategories.length === 0) {
                container.append("div")
                    .style("text-align", "center")
                    .style("color", "#666")
                    .style("padding", "20px")
                    .text("No English categories found");
                return;
            }
            
            const maxPages = Math.max(...englishCategories.map(c => c.pages));
            
            englishCategories.forEach((cat, i) => {
                const item = container.append("div")
                    .style("margin-bottom", "10px");
                
                const header = item.append("div")
                    .style("display", "flex")
                    .style("justify-content", "space-between")
                    .style("align-items", "center")
                    .style("margin-bottom", "4px");
                
                header.append("span")
                    .style("font-size", "11px")
                    .style("color", "#1f4788")
                    .style("font-weight", "500")
                    .text(cat.name.length > 25 ? cat.name.substring(0, 25) + '...' : cat.name);
                
                header.append("span")
                    .style("font-size", "11px")
                    .style("color", "#666")
                    .text(`${cat.pages} pages`);
                
                const progressContainer = item.append("div")
                    .attr("class", "progress-bar-container")
                    .style("height", "6px");
                
                progressContainer.append("div")
                    .attr("class", "progress-bar-fill")
                    .style("background", `hsl(${200 + i * 15}, 70%, 60%)`)
                    .transition().duration(800)
                    .style("width", `${(cat.pages / maxPages) * 100}%`);
            });
        }

        // In createDepthChart function
function createDepthChart(container) {
    const isDark = document.body.classList.contains('dark-theme');
    const data = siteStats.depthDistribution.slice(0, 8);
    const maxCount = Math.max(...data.map(d => d.count));
    
    data.forEach((d, i) => {
        const bar = container.append("div")
            .style("display", "flex")
            .style("align-items", "center")
            .style("margin-bottom", "8px");
        
        bar.append("div")
            .style("width", "60px")
            .style("font-size", "12px")
            .style("color", isDark ? "#9ca3af" : "#666")
            .text(`Level ${d.depth}`);
        
        const barContainer = bar.append("div")
            .style("flex", "1")
            .style("background", isDark ? "#374151" : "#f0f0f0")
            .style("height", "20px")
            .style("border-radius", "10px")
            .style("margin", "0 10px")
            .style("overflow", "hidden");
        
        barContainer.append("div")
            .style("height", "100%")
            .style("background", isDark ? 
                `hsl(${120 + i * 10}, 50%, 45%)` :  // Darker, more muted colors
                `hsl(${220 + i * 10}, 70%, 60%)`)
            .style("width", "0%")
            .style("border-radius", "10px")
            .transition().duration(1000)
            .style("width", `${(d.count / maxCount) * 100}%`);
        
        bar.append("div")
            .style("width", "50px")
            .style("font-size", "12px")
            .style("font-weight", "bold")
            .style("color", isDark ? "#72A300" : "#1f4788")
            .style("text-align", "right")
            .text(d.count);
    });
}

        function createCategoryChart(container) {
            const topCategories = siteStats.categoryBreakdown.slice(0, 6);
            const maxPages = Math.max(...topCategories.map(c => c.pages));
            
            topCategories.forEach((cat, i) => {
                const item = container.append("div")
                    .style("margin-bottom", "12px");
                
                const header = item.append("div")
                    .style("display", "flex")
                    .style("justify-content", "space-between")
                    .style("align-items", "center")
                    .style("margin-bottom", "4px");
                
                header.append("span")
                    .style("font-size", "12px")
                    .style("color", "#1f4788")
                    .style("font-weight", "500")
                    .text(cat.name);
                
                header.append("span")
                    .style("font-size", "12px")
                    .style("color", "#666")
                    .text(`${cat.pages} pages (${cat.percentage}%)`);
                
                const progressContainer = item.append("div")
                    .attr("class", "progress-bar-container");
                
                progressContainer.append("div")
                    .attr("class", "progress-bar-fill")
                    .style("background", `hsl(${200 + i * 20}, 70%, 60%)`)
                    .transition().duration(800)
                    .style("width", `${(cat.pages / maxPages) * 100}%`);
            });
        }

        function createInsightsSection(container) {
            const insightsSection = container.append("div")
                .attr("class", "insights-section");
            
            const insightsGrid = insightsSection.append("div")
                .attr("class", "insights-grid");
            
            // Performance overview
            const performanceCard = insightsGrid.append("div")
                .attr("class", "insight-card");
            
            const perfHeader = performanceCard.append("div")
                .attr("class", "insight-header");
            
            perfHeader.append("div")
                .attr("class", "insight-icon")
                .text("🎯");
            
            perfHeader.append("div")
                .attr("class", "insight-title")
                .text("Site Structure Score");
            
            const perfContent = performanceCard.append("div")
                .attr("class", "insight-content");
            
            const gauge = perfContent.append("div")
                .attr("class", "performance-gauge");
            
            gauge.append("div")
                .attr("class", "gauge-container")
                .append("div")
                .attr("class", "gauge-score")
                .style("color", siteAnalysis.score >= 80 ? "#4caf50" : siteAnalysis.score >= 60 ? "#ff9800" : "#f44336")
                .text(siteAnalysis.score);
            
            gauge.append("div")
                .style("color", "#666")
                .style("margin-top", "10px")
                .text(siteAnalysis.score >= 80 ? "Excellent structure!" : 
                      siteAnalysis.score >= 60 ? "Good structure with room for improvement" : 
                      "Structure needs optimization");
            
            // Issues and recommendations
            if (siteAnalysis.issues.length > 0) {
                const issuesCard = insightsGrid.append("div")
                    .attr("class", "insight-card");
                
                const issuesHeader = issuesCard.append("div")
                    .attr("class", "insight-header");
                
                issuesHeader.append("div")
                    .attr("class", "insight-icon")
                    .text("⚠️");
                
                issuesHeader.append("div")
                    .attr("class", "insight-title")
                    .text(`Issues Found (${siteAnalysis.issues.length})`);
                
                const issuesList = issuesCard.append("ul")
                    .attr("class", "issues-list");
                
                siteAnalysis.issues.forEach(issue => {
                    const li = issuesList.append("li")
                        .attr("class", `issue-${issue.type}`);
                    
                    li.append("div")
                        .attr("class", "issue-icon")
                        .text(issue.type === 'critical' ? '🚨' : '⚠️');
                    
                    const content = li.append("div");
                    
                    content.append("div")
                        .style("font-weight", "bold")
                        .style("margin-bottom", "4px")
                        .text(issue.title);
                    
                    content.append("div")
                        .style("font-size", "0.9rem")
                        .style("color", "#666")
                        .text(issue.description);
                });
            }
            
            // Recommendations
            if (siteAnalysis.recommendations.length > 0) {
                const recCard = insightsGrid.append("div")
                    .attr("class", "insight-card");
                
                const recHeader = recCard.append("div")
                    .attr("class", "insight-header");
                
                recHeader.append("div")
                    .attr("class", "insight-icon")
                    .text("💡");
                
                recHeader.append("div")
                    .attr("class", "insight-title")
                    .text("Recommendations");
                
                const recList = recCard.append("ul")
                    .attr("class", "recommendation-list");
                
                siteAnalysis.recommendations.forEach(rec => {
                    const li = recList.append("li");
                    
                    li.append("div")
                        .attr("class", "recommendation-icon")
                        .text("💡");
                    
                    const content = li.append("div");
                    
                    content.append("div")
                        .style("font-weight", "bold")
                        .style("margin-bottom", "4px")
                        .text(rec.title);
                    
                    content.append("div")
                        .style("font-size", "0.9rem")
                        .style("color", "#666")
                        .text(rec.description);
                });
            }
            
            // Site strengths
            if (siteAnalysis.strengths.length > 0) {
                const strengthsCard = insightsGrid.append("div")
                    .attr("class", "insight-card");
                
                const strengthsHeader = strengthsCard.append("div")
                    .attr("class", "insight-header");
                
                strengthsHeader.append("div")
                    .attr("class", "insight-icon")
                    .text("✅");
                
                strengthsHeader.append("div")
                    .attr("class", "insight-title")
                    .text("Site Strengths");
                
                const strengthsList = strengthsCard.append("ul")
                    .style("list-style", "none")
                    .style("padding", "0");
                
                siteAnalysis.strengths.forEach(strength => {
                    const li = strengthsList.append("li")
                        .style("padding", "8px 0")
                        .style("display", "flex")
                        .style("align-items", "flex-start");
                    
                    li.append("div")
                        .style("margin-right", "10px")
                        .style("margin-top", "2px")
                        .text("✅");
                    
                    li.append("div")
                        .style("color", "#444")
                        .text(strength);
                });
            }
        }

        
        
        
        

        // Global utility functions for modals
        window.closeModal = function() {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) modal.remove();
        }

        window.toggleCategoryDetails = function(categoryId) {
            const categoryElement = document.getElementById(categoryId);
            if (categoryElement) {
                categoryElement.style.display = categoryElement.style.display === 'none' ? 'block' : 'none';
            }
        }

        window.showContentStrategy = function() {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) {
                const content = modal.querySelector('div[style*="background: white"]');
                if (content) {
                    content.innerHTML = generateContentStrategyGuide();
                }
            }
        }

       
        // Content Freshness Analysis
        window.showContentFreshnessAnalysis = function() {
    if (!siteStats || !treeData) {
        alert('Please load a sitemap first');
        return;
    }
    
    const analysis = generateFreshnessAnalysis();
    
    // Create modal overlay
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
        align-items: center; justify-content: center; padding: 20px;
    `;
    
    modal.onclick = () => modal.remove();
    
    const content = document.createElement('div');
    content.style.cssText = `
        background: white; padding: 30px; border-radius: 15px; 
        max-width: 1200px; max-height: 85vh; overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    `;
    content.onclick = e => e.stopPropagation();
    
    content.innerHTML = analysis;
    
    
    // Then create and append the X button
const closeBtn = document.createElement('button');
closeBtn.innerHTML = '×';
closeBtn.style.cssText = `
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 48px;
    color: #666;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
    z-index: 1000;
`;
closeBtn.onmouseover = () => {
    closeBtn.style.background = '#f0f0f0';
    closeBtn.style.color = '#333';
};
closeBtn.onmouseout = () => {
    closeBtn.style.background = 'none';
    closeBtn.style.color = '#666';
};
closeBtn.onclick = () => modal.remove();

// Append the button AFTER setting innerHTML
content.appendChild(closeBtn);
    
    
    
    
    
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    // NOW initialize pagination after modal is in DOM
    if (window.allPagesData) {
        window.updateAllPagesPagination(1, Math.ceil((window.filteredAllPagesData || window.allPagesData).length / 25));
    }
    
    // Set up pagination data after modal is created
    if (window.freshnessPageDetails && window.freshnessPageDetails.oldest) {
        window.oldestPagesData = window.freshnessPageDetails.oldest;
        window.oldestPagesCurrentPage = 1;
        console.log('Pagination setup complete. Total pages:', window.oldestPagesData.length);
    }
}

        function generateFreshnessAnalysis() {
    // Collect all lastmod dates from the tree
    const allDates = [];
    const categoryFreshness = {};
    const pageDetails = {
        newest: [],
        oldest: []
    };
    
    function collectDates(node, categoryName = '') {
        // Only collect dates from leaf nodes (nodes without children)
        const isLeafNode = !node.children || node.children.length === 0;
        
        if (isLeafNode && node.lastModDates && Array.isArray(node.lastModDates)) {
            node.lastModDates.forEach(date => {
                if (date) {
                    allDates.push({
                        date: new Date(date),
                        dateString: date,
                        category: categoryName || node.name,
                        url: node.url || '',
                        name: node.name || 'Unknown page'
                    });
                }
            });
        }
        
        // Continue traversing to find leaf nodes
        if (node.children && Array.isArray(node.children)) {
            node.children.forEach(child => {
                const childCatName = categoryName || (node.depth <= 2 ? node.name : categoryName);
                collectDates(child, childCatName);
            });
        }
    }
    
    // Collect from parsed tree data
    if (treeData && treeData.children) {
        treeData.children.forEach(lang => {
            if (lang.children) {
                lang.children.forEach(category => {
                    collectDates(category, category.name);
                });
            } else {
                collectDates(lang, lang.name);
            }
        });
    }
    
    if (allDates.length === 0) {
        // No lastmod data found - return the original message
        return `
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: #1f4788;">📅 Content Freshness Analysis</h2>
                <p style="color: #666;">No lastmod data found in this sitemap</p>
            </div>
            
            <div style="background: #fff3cd; border-left: 4px solid #ff9800; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="color: #e65100; margin-bottom: 15px;">⚠️ Missing LastMod Data</h4>
                <p style="color: #444; margin-bottom: 15px;">Your sitemap doesn't include lastmod (last modified) dates. This is valuable data for:</p>
                <ul style="color: #444; margin-left: 20px; margin-bottom: 15px;">
                    <li><strong>Content maintenance tracking</strong> - Know which pages are outdated</li>
                    <li><strong>SEO optimization</strong> - Help search engines understand content freshness</li>
                    <li><strong>Editorial planning</strong> - Prioritize content updates based on age</li>
                    <li><strong>Compliance</strong> - Ensure critical information stays current</li>
                </ul>
            </div>
            
            <button onclick="closeModal()" 
                    style="width: 100%; padding: 12px 20px; background: #1f4788; 
                           color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                Close
            </button>
        `;
    }
    
    // Sort dates and analyze
    allDates.sort((a, b) => b.date - a.date);
    
    // Define date variables FIRST (before they're used anywhere)
    const now = new Date();
    const oneMonthAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
    const threeMonthsAgo = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000));
    const sixMonthsAgo = new Date(now.getTime() - (180 * 24 * 60 * 60 * 1000));
    const oneYearAgo = new Date(now.getTime() - (365 * 24 * 60 * 60 * 1000));
    const twoYearsAgo = new Date(now.getTime() - (730 * 24 * 60 * 60 * 1000));
    
    const freshness = {
        new: allDates.filter(d => d.date >= oneMonthAgo).length,
        fresh: allDates.filter(d => d.date >= threeMonthsAgo && d.date < oneMonthAgo).length,
        recent: allDates.filter(d => d.date >= sixMonthsAgo && d.date < threeMonthsAgo).length,
        aging: allDates.filter(d => d.date >= oneYearAgo && d.date < sixMonthsAgo).length,
        old: allDates.filter(d => d.date >= twoYearsAgo && d.date < oneYearAgo).length,
        stale: allDates.filter(d => d.date < twoYearsAgo).length
    };
    
    const totalWithDates = allDates.length;
    const freshnessScore = Math.round(((freshness.new * 1.0 + freshness.fresh * 0.8 + freshness.recent * 0.6 + freshness.aging * 0.4 + freshness.old * 0.2) / totalWithDates) * 100);
    
    // Extract newest and oldest pages with URLs
    const pagesWithUrls = allDates.filter(item => item.url);
    
    // Get 10 newest pages
    pageDetails.newest = pagesWithUrls.slice(0, 10);
    
    // Get all oldest pages (for pagination)
    pageDetails.oldest = [...pagesWithUrls].sort((a, b) => a.date - b.date);
    
    // Store in global variable for pagination
    window.freshnessPageDetails = pageDetails;
    
    // Also set up critical pages data
const criticalPagesForFilters = pageDetails.oldest.filter(p => {
    const daysSinceUpdate = Math.floor((now - p.date) / (1000 * 60 * 60 * 24));
    return daysSinceUpdate > 730; // Only 2+ years old
});
window.criticalPagesData = criticalPagesForFilters;
window.criticalFilteredPages = criticalPagesForFilters;
window.criticalCurrentPage = 1;
    
    // Analyze by category
    const categoryStats = {};
    allDates.forEach(item => {
        if (!categoryStats[item.category]) {
            categoryStats[item.category] = {
                name: item.category,
                total: 0,
                new: 0,
                fresh: 0,
                recent: 0,
                aging: 0,
                old: 0,
                stale: 0,
                latestUpdate: null,
                oldestUpdate: null,
                newestPages: [],
                oldestPages: []
            };
        }
        
        const cat = categoryStats[item.category];
        cat.total++;
        
        if (!cat.latestUpdate || item.date > cat.latestUpdate) {
            cat.latestUpdate = item.date;
        }
        if (!cat.oldestUpdate || item.date < cat.oldestUpdate) {
            cat.oldestUpdate = item.date;
        }
        
        // Track newest and oldest pages per category
        if (item.url) {
            // Keep track of newest pages
            if (cat.newestPages.length < 3) {
                cat.newestPages.push(item);
                cat.newestPages.sort((a, b) => b.date - a.date);
            } else if (item.date > cat.newestPages[2].date) {
                cat.newestPages.pop();
                cat.newestPages.push(item);
                cat.newestPages.sort((a, b) => b.date - a.date);
            }
            
            // Keep track of oldest pages
            if (cat.oldestPages.length < 3) {
                cat.oldestPages.push(item);
                cat.oldestPages.sort((a, b) => a.date - b.date);
            } else if (item.date < cat.oldestPages[2].date) {
                cat.oldestPages.pop();
                cat.oldestPages.push(item);
                cat.oldestPages.sort((a, b) => a.date - b.date);
            }
        }
        
        if (item.date >= oneMonthAgo) cat.new++;
        else if (item.date >= threeMonthsAgo) cat.fresh++;
        else if (item.date >= sixMonthsAgo) cat.recent++;
        else if (item.date >= oneYearAgo) cat.aging++;
        else if (item.date >= twoYearsAgo) cat.old++;
        else cat.stale++;
    });
    
    const categoryArray = Object.values(categoryStats).sort((a, b) => b.total - a.total);
    
    let html = `
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: #1f4788; margin-bottom: 10px;">📅 Content Freshness Analysis</h2>
            <p style="color: #666;">Content update patterns and maintenance insights</p>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="text-align: center; padding: 20px; background: ${freshnessScore >= 80 ? '#e8f5e8' : freshnessScore >= 60 ? '#fff3cd' : '#ffebee'}; border-radius: 10px;">
    <div style="font-size: 2rem; font-weight: bold; color: ${freshnessScore >= 80 ? '#4caf50' : freshnessScore >= 60 ? '#ff9800' : '#f44336'};">${freshnessScore}%</div>
    <div style="color: #666; margin-top: 5px;">Freshness Score</div>
</div>
            <div style="text-align: center; padding: 20px; background: #f8f9ff; border-radius: 10px;">
                <div style="font-size: 2rem; font-weight: bold; color: #4a90e2;">${totalWithDates.toLocaleString()}</div>
                <div style="color: #666; margin-top: 5px;">Pages with Dates</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #f8f9ff; border-radius: 10px;">
                <div style="font-size: 2rem; font-weight: bold; color: #4a90e2;">${allDates[0] ? formatDate(allDates[0].date) : 'N/A'}</div>
                <div style="color: #666; margin-top: 5px;">Latest Update</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #f8f9ff; border-radius: 10px;">
                <div style="font-size: 2rem; font-weight: bold; color: #4a90e2;">${allDates[allDates.length-1] ? formatDate(allDates[allDates.length-1].date) : 'N/A'}</div>
                <div style="color: #666; margin-top: 5px;">Oldest Update</div>
            </div>
        </div>
        
        
        
        
        
        
        
        
        <!-- Content Age Distribution -->
        <div style="margin-bottom: 30px;">
            <h3 style="color: #1f4788; margin-bottom: 20px;">📊 Content Age Distribution</h3>
            <div style="background: #f8f9ff; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
    <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 12px; height: 12px; background: #2e7d32; border-radius: 2px;"></div>
        <span style="font-size: 0.85rem; color: #666;">New (&lt;1mo)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 12px; height: 12px; background: #43a047; border-radius: 2px;"></div>
        <span style="font-size: 0.85rem; color: #666;">Fresh (1-3mo)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 12px; height: 12px; background: #fdd835; border-radius: 2px;"></div>
        <span style="font-size: 0.85rem; color: #666;">Recent (3-6mo)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 12px; height: 12px; background: #fb8c00; border-radius: 2px;"></div>
        <span style="font-size: 0.85rem; color: #666;">Aging (6-12mo)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 12px; height: 12px; background: #e53935; border-radius: 2px;"></div>
        <span style="font-size: 0.85rem; color: #666;">Old (1-2yr)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 12px; height: 12px; background: #b71c1c; border-radius: 2px;"></div>
        <span style="font-size: 0.85rem; color: #666;">Stale (&gt;2yr)</span>
    </div>
</div>
            </div>
            <style>
                @media (min-width: 1201px) {
                    .age-distribution-grid {
                        grid-template-columns: repeat(6, 1fr) !important;
                    }
                }
                @media (min-width: 769px) and (max-width: 1200px) {
                    .age-distribution-grid {
                        grid-template-columns: repeat(3, 1fr) !important;
                    }
                }
                @media (min-width: 481px) and (max-width: 768px) {
                    .age-distribution-grid {
                        grid-template-columns: repeat(2, 1fr) !important;
                    }
                }
                @media (max-width: 480px) {
                    .age-distribution-grid {
                        grid-template-columns: repeat(1, 1fr) !important;
                    }
                }
            </style>
            <div class="age-distribution-grid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; width: 100%;">
    `;
    
    const ageCategories = [
    { label: 'New (< 1 month)', count: freshness.new, color: '#2e7d32', desc: 'Just updated' },
    { label: 'Fresh (1-3 months)', count: freshness.fresh, color: '#43a047', desc: 'Recently updated' },
    { label: 'Recent (3-6 months)', count: freshness.recent, color: '#fdd835', desc: 'Still current' },
    { label: 'Aging (6-12 months)', count: freshness.aging, color: '#fb8c00', desc: 'May need review' },
    { label: 'Old (1-2 years)', count: freshness.old, color: '#e53935', desc: 'Needs attention' },
    { label: 'Stale (> 2 years)', count: freshness.stale, color: '#b71c1c', desc: 'Urgent review needed' }
];
        
    ageCategories.forEach(cat => {
        const percentage = Math.round((cat.count / totalWithDates) * 100);
        html += `
            <div style="background: white; border-left: 4px solid ${cat.color}; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 500; color: #333;">${cat.label}</span>
                    <span style="font-size: 1.2rem; font-weight: bold; color: ${cat.color};">${cat.count}</span>
                </div>
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">${cat.desc}</div>
                <div style="background: #f0f0f0; height: 6px; border-radius: 3px; overflow: hidden;">
                    <div style="background: ${cat.color}; height: 100%; width: ${percentage}%; border-radius: 3px; transition: width 0.8s ease;"></div>
                </div>
                <div style="font-size: 0.8rem; color: #666; margin-top: 4px; text-align: right;">${percentage}%</div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
        
        <style>
            @media (max-width: 1200px) {
                #ageDistributionGrid {
                    grid-template-columns: repeat(3, 1fr) !important;
                }
            }
            @media (max-width: 768px) {
                #ageDistributionGrid {
                    grid-template-columns: repeat(2, 1fr) !important;
                }
            }
            @media (max-width: 480px) {
                #ageDistributionGrid {
                    grid-template-columns: repeat(1, 1fr) !important;
                }
            }
        </style>  
        
       
        
        
        
        
        
        
        
<!-- All Pages Browser -->
        <div style="margin-bottom: 30px;">
            <h3 style="color: #1f4788; margin-bottom: 20px;">📋 All Pages Browser</h3>
            
            <!-- Filter Controls -->
            <!-- Filter Controls -->
<div style="background: #f0f6ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div style="display: flex; flex-direction: column; gap: 5px;">
            <label style="font-weight: 500; color: #1f4788; font-size: 0.875rem;">Freshness:</label>
            <select id="allPagesFreshnessFilter" onchange="window.applyAllPagesFilters()" 
                    style="width: 100%; padding: 8px 12px; border: 2px solid #4a90e2; border-radius: 6px; 
                           background: white; color: #333; font-size: 14px; cursor: pointer;">
                <option value="">All Freshness Levels</option>
                <option value="new" style="color: #2e7d32;">● New (< 1 month)</option>
                <option value="fresh" style="color: #43a047;">● Fresh (1-3 months)</option>
                <option value="recent" style="color: #fdd835;">● Recent (3-6 months)</option>
                <option value="aging" style="color: #fb8c00;">● Aging (6-12 months)</option>
                <option value="old" style="color: #e53935;">● Old (1-2 years)</option>
                <option value="stale" style="color: #b71c1c;">● Stale (> 2 years)</option>
            </select>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 5px;">
            <label style="font-weight: 500; color: #1f4788; font-size: 0.875rem;">Language:</label>
            <select id="allPagesLanguageFilter" onchange="window.applyAllPagesFilters()" 
                    style="width: 100%; padding: 8px 12px; border: 2px solid #4a90e2; border-radius: 6px; 
                           background: white; color: #333; font-size: 14px; cursor: pointer;">
                <option value="">All Languages</option>
                <option value="en">English</option>
                <option value="ga">Irish</option>
                <option value="other">Other</option>
            </select>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 5px;">
            <label style="font-weight: 500; color: #1f4788; font-size: 0.875rem;">Category:</label>
            <select id="allPagesCategoryFilter" onchange="window.applyAllPagesFilters()" 
                    style="width: 100%; padding: 8px 12px; border: 2px solid #4a90e2; border-radius: 6px; 
                           background: white; color: #333; font-size: 14px; cursor: pointer;">
                <option value="">All Categories</option>
`;

    // Add categories to the dropdown
    const uniqueCategoriesForAllPages = [...new Set(pagesWithUrls.map(page => page.category))].sort();
    uniqueCategoriesForAllPages.forEach(category => {
        const displayName = category.length > 30 ? category.substring(0, 30) + '...' : category;
        html += `<option value="${category}" title="${category}">${displayName}</option>`;
    });

    html += `
            </select>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 5px;">
            <label style="font-weight: 500; color: #1f4788; font-size: 0.875rem;">Sort by:</label>
            <select id="allPagesSortBy" onchange="window.applyAllPagesFilters()" 
                    style="width: 100%; padding: 8px 12px; border: 2px solid #4a90e2; border-radius: 6px; 
                           background: white; color: #333; font-size: 14px; cursor: pointer;">
                <option value="date-desc">Newest First</option>
                <option value="date-asc">Oldest First</option>
                <option value="name-asc">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
                <option value="category">Category</option>
            </select>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 5px;">
            <label style="font-weight: 500; color: #1f4788; font-size: 0.875rem;">&nbsp;</label>
            <button onclick="window.clearAllPagesFilters()" 
                    style="width: 100%; padding: 8px 16px; background: #666; color: white; border: none; 
                           border-radius: 6px; cursor: pointer; font-size: 14px; height: 40px;">
                Clear Filters
            </button>
        </div>
    </div>
    
    <div style="margin-top: 10px;">
        <span style="color: #666; font-size: 0.9rem;" id="allPagesFilterSummary">Showing all ${pagesWithUrls.length} pages</span>
    </div>
</div>
            
            <div style="background: white; border-radius: 10px; border: 1px solid #e0e0e0; overflow: hidden;">
                <div style="background: #1f4788; color: white; padding: 15px; font-weight: bold;">
                    <div style="display: grid; grid-template-columns: 40px 3fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
                        <div style="text-align: center;">Status</div>
                        <div>Page</div>
                        <div style="text-align: center;">Category</div>
                        <div style="text-align: center;">Last Updated</div>
                        <div style="text-align: center;">Age</div>
                    </div>
                </div>
                <div id="allPagesList">
    `;

    // Store all pages data for filtering
    window.allPagesData = pagesWithUrls.map(page => {
        const daysSinceUpdate = Math.floor((now - page.date) / (1000 * 60 * 60 * 24));
        let freshnessLevel = '';
        let freshnessColor = '';
        
       if (page.date >= oneMonthAgo) {
    freshnessLevel = 'new';
    freshnessColor = '#2e7d32';
} else if (page.date >= threeMonthsAgo) {
    freshnessLevel = 'fresh';
    freshnessColor = '#43a047';
} else if (page.date >= sixMonthsAgo) {
    freshnessLevel = 'recent';
    freshnessColor = '#fdd835';
} else if (page.date >= oneYearAgo) {
    freshnessLevel = 'aging';
    freshnessColor = '#fb8c00';
} else if (page.date >= twoYearsAgo) {
    freshnessLevel = 'old';
    freshnessColor = '#e53935';
} else {
    freshnessLevel = 'stale';
    freshnessColor = '#b71c1c';
}
        
        return {
            ...page,
            daysSinceUpdate,
            freshnessLevel,
            freshnessColor
        };
    });

    // Display first page of results
    const allPagesPerPage = 25;
    window.allPagesData.slice(0, allPagesPerPage).forEach((page, index) => {
        const bgColor = index % 2 === 0 ? '#f9f9f9' : 'white';
        
        html += `
            <div style="padding: 12px 15px; background: ${bgColor}; border-bottom: 1px solid #f0f0f0;">
                <div style="display: grid; grid-template-columns: 40px 3fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
                    <div style="text-align: center;">
                        <span style="color: ${page.freshnessColor}; font-size: 1.5rem;" title="${page.freshnessLevel}">●</span>
                    </div>
                    <div style="font-weight: 500; color: #2d5aa0;">
                        <a href="${page.url}" target="_blank" style="text-decoration: none; color: #2d5aa0;" title="${page.name}">${page.name}</a>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 4px; word-break: break-all;" title="${page.url}">${page.url}</div>
                    </div>
                    <div style="text-align: center; font-size: 0.9rem; color: #666;">${page.category}</div>
                    <div style="text-align: center; font-size: 0.9rem; color: #666;">${formatDate(page.date)}</div>
                    <div style="text-align: center; font-size: 0.9rem; color: ${page.freshnessColor};">
                        ${page.daysSinceUpdate} days
                    </div>
                </div>
            </div>
        `;
    });

    html += `
                </div>
                
                <!-- Pagination controls -->
                <div style="padding: 15px; background: #f8f9ff; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                    <div style="color: #666; font-size: 0.9rem;" id="allPagesPaginationInfo">
                        Showing 1-${Math.min(allPagesPerPage, pagesWithUrls.length)} of ${pagesWithUrls.length} pages
                    </div>
                    <div style="display: flex; gap: 5px; align-items: center;" id="allPagesPaginationControls">
                        <!-- Pagination buttons will be added by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        
        
        
        
        
        
        
        
        
        
        
         <!-- Most Recently Updated Pages -->
        <div style="margin-bottom: 30px;">
            <h3 style="color: #1f4788; margin-bottom: 20px;">🆕 Most Recently Updated Pages</h3>
            <div style="background: white; border-radius: 10px; border: 1px solid #e0e0e0; overflow: hidden;">
                <div style="background: #1f4788; color: white; padding: 15px; font-weight: bold;">
                    <div style="display: grid; grid-template-columns: 3fr 1fr 1fr; gap: 15px; align-items: center;">
                        <div>Page</div>
                        <div style="text-align: center;">Category</div>
                        <div style="text-align: right;">Updated</div>
                    </div>
                </div>
    `;
    
    // Add newest pages
    // Add newest pages
pageDetails.newest.forEach((page, index) => {
    const bgColor = index % 2 === 0 ? '#f9f9f9' : 'white';
    
    html += `
        <div style="padding: 12px 15px; background: ${bgColor}; border-bottom: 1px solid #f0f0f0;">
            <div style="display: grid; grid-template-columns: 3fr 1fr 1fr; gap: 15px; align-items: center;">
                <div style="font-weight: 500; color: #2d5aa0;">
                    <a href="${page.url}" target="_blank" style="text-decoration: none; color: #2d5aa0;" title="${page.name}">${page.name}</a>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 4px; word-break: break-all;" title="${page.url}">${page.url}</div>
                </div>
                <div style="text-align: center; font-size: 0.9rem; color: #666;">${page.category}</div>
                <div style="text-align: right; font-size: 0.9rem; color: #4caf50; font-weight: 500;">${formatDate(page.date)}</div>
            </div>
        </div>
    `;
});
    
    html += `
            </div>
        </div>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
<!-- Pages Requiring Immediate Attention -->
<div style="margin-bottom: 30px;">
    <h3 style="color: #1f4788; margin-bottom: 20px;">🚨 Action Required - Review for possible content updates</h3>
    
    <!-- Get critical pages (2+ years old) -->
`;

const criticalPages = pageDetails.oldest.filter(p => {
    const daysSinceUpdate = Math.floor((now - p.date) / (1000 * 60 * 60 * 24));
    return daysSinceUpdate > 730; // Only 2+ years old
});

html += `
    <!-- Summary Stats -->
    <div style="background: #fff3cd; border-left: 4px solid #b71c1c; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
            <div>
                <span style="font-size: 2.5rem; font-weight: bold; color: #f44336;">${criticalPages.length}</span>
                <span style="font-size: 1.2rem; color: #856404; margin-left: 10px;">pages are over 2 years old and may require attention</span>
            </div>
            <div style="color: #856404; font-size: 0.95rem;">
                <strong>Priority:</strong> These pages might contain outdated information and should be reviewed
            </div>
        </div>
    </div>
    
    <!-- Filter Controls -->
    <div style="background: #f0f6ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <label style="font-weight: 500; color: #1f4788;">Language:</label>
                <select id="criticalLanguageFilter" onchange="window.applyCriticalFilters()" 
                        style="padding: 8px 12px; border: 2px solid #4a90e2; border-radius: 6px; 
                               background: white; color: #333; font-size: 14px; cursor: pointer;">
                    <option value="">All Languages</option>
`;

// Extract languages from critical pages only
const criticalLanguageMap = new Map();
criticalPages.forEach(page => {
    const urlMatch = page.url.match(/\/(en|ga)\//);
    const lang = urlMatch ? urlMatch[1] : 'other';
    if (!criticalLanguageMap.has(lang)) {
        criticalLanguageMap.set(lang, 0);
    }
    criticalLanguageMap.set(lang, criticalLanguageMap.get(lang) + 1);
});

// Add language options
if (criticalLanguageMap.has('en')) {
    html += `<option value="en">English (${criticalLanguageMap.get('en')} pages)</option>`;
}
if (criticalLanguageMap.has('ga')) {
    html += `<option value="ga">Irish (${criticalLanguageMap.get('ga')} pages)</option>`;
}
if (criticalLanguageMap.has('other')) {
    html += `<option value="other">Other (${criticalLanguageMap.get('other')} pages)</option>`;
}

html += `
                </select>
            </div>
            
            <div style="display: flex; align-items: center; gap: 10px;">
                <label style="font-weight: 500; color: #1f4788;">Category:</label>
                <select id="criticalCategoryFilter" onchange="window.applyCriticalFilters()" 
                        style="padding: 8px 12px; border: 2px solid #4a90e2; border-radius: 6px; 
                               background: white; color: #333; font-size: 14px; cursor: pointer; max-width: 300px;">
                    <option value="">All Categories</option>
`;

// Get unique categories from critical pages and sort them
const criticalCategories = [...new Set(criticalPages.map(page => page.category))].sort();
criticalCategories.forEach(category => {
    const count = criticalPages.filter(p => p.category === category).length;
    const displayName = category.length > 30 ? category.substring(0, 30) + '...' : category;
    html += `<option value="${category}" title="${category}">${displayName} (${count})</option>`;
});

html += `
                </select>
            </div>
            
            <button onclick="window.clearCriticalFilters()" 
                    style="padding: 8px 16px; background: #666; color: white; border: none; 
                           border-radius: 6px; cursor: pointer; font-size: 14px;">
                Clear Filters
            </button>
        </div>
        
        <div style="margin-top: 10px;">
            <span style="color: #666; font-size: 0.9rem;" id="criticalFilterSummary">Showing all critical pages</span>
        </div>
    </div>
    
    <div style="background: #b71c1c; padding: 15px; font-weight: bold;">
    <div style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
        <div style="color: #ffffff !important; font-weight: bold;">Page</div>
        <div style="text-align: center; color: #ffffff !important; font-weight: bold;">Category</div>
        <div style="text-align: center; color: #ffffff !important; font-weight: bold;">Last Updated</div>
        <div style="text-align: center; color: #ffffff !important; font-weight: bold;">Age</div>
    </div>
</div>
        <div id="criticalPagesList">
`;

// Calculate pagination
const criticalItemsPerPage = 20;
const criticalTotalPages = Math.ceil(criticalPages.length / criticalItemsPerPage);
const criticalCurrentPage = 1;
const criticalStartIndex = 0;
const criticalEndIndex = Math.min(criticalItemsPerPage, criticalPages.length);

// Add critical pages for current page
criticalPages.slice(criticalStartIndex, criticalEndIndex).forEach((page, index) => {
    const actualIndex = criticalStartIndex + index;
    const bgColor = actualIndex % 2 === 0 ? '#ffebee' : '#fff5f5';
    const daysSinceUpdate = Math.floor((now - page.date) / (1000 * 60 * 60 * 24));
    const years = Math.floor(daysSinceUpdate / 365);
    const months = Math.floor((daysSinceUpdate % 365) / 30);
    
    html += `
        <div style="padding: 12px 15px; background: ${bgColor}; border-bottom: 1px solid #f0f0f0;">
            <div style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
                <div style="font-weight: 500;">
                    <span style="color: #999; font-size: 0.8rem; margin-right: 8px;">#${actualIndex + 1}</span>
                    <a href="${page.url}" target="_blank" style="text-decoration: none; color: #c62828;" title="${page.name}">${page.name}</a>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 4px; word-break: break-all;" title="${page.url}">${page.url}</div>
                </div>
                <div style="text-align: center; font-size: 0.9rem; color: #666;">${page.category}</div>
                <div style="text-align: center; font-size: 0.9rem;">
                    ${formatDate(page.date)}
                </div>
                <div style="text-align: center;">
                    <span style="background: #f44336; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">
                        ${years}y ${months}m
                    </span>
                </div>
            </div>
        </div>
    `;
});

if (criticalPages.length === 0) {
    html += `
        <div style="padding: 40px; text-align: center; color: #4caf50;">
            <div style="font-size: 3rem; margin-bottom: 10px;">✅</div>
            <div style="font-size: 1.2rem; font-weight: bold;">Excellent!</div>
            <div style="color: #666; margin-top: 10px;">No pages are critically outdated (over 2 years old)</div>
        </div>
    `;
}

html += `
        </div>
    </div>
</div>











    
   
        
  
        
        
        
        
        
        
        
        
        
        
        
        
        
        <!-- Category Freshness Analysis -->
        <div style="margin-bottom: 30px;">
            <h3 style="color: #1f4788; margin-bottom: 20px;">📂 Category Freshness Analysis</h3>
            <div style="background: white; border-radius: 10px; border: 1px solid #e0e0e0; overflow: hidden;">
                <div style="background: #1f4788; color: white; padding: 15px; font-weight: bold;">
                    <div style="display: grid; grid-template-columns: 2.5fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr 1fr 1.2fr; gap: 10px; align-items: center; font-size: 0.9rem;">
                        <div>Category</div>
                        <div style="text-align: center;">Total</div>
                        <div style="text-align: center;">New<br/>(&lt;1mo)</div>
                        <div style="text-align: center;">Fresh<br/>(1-3mo)</div>
                        <div style="text-align: center;">Recent<br/>(3-6mo)</div>
                        <div style="text-align: center;">Aging<br/>(6-12mo)</div>
                        <div style="text-align: center;">Old<br/>(1-2yr)</div>
                        <div style="text-align: center;">Stale<br/>(&gt;2yr)</div>
                        <div style="text-align: center;">Latest Update</div>
                    </div>
                </div>
    `;
    
    categoryArray.slice(0, 15).forEach((cat, index) => {
        const bgColor = index % 2 === 0 ? '#f9f9f9' : 'white';
        const newPercentage = Math.round((cat.new / cat.total) * 100);
        const freshPercentage = Math.round((cat.fresh / cat.total) * 100);
        const recentPercentage = Math.round((cat.recent / cat.total) * 100);
        const agingPercentage = Math.round((cat.aging / cat.total) * 100);
        const oldPercentage = Math.round((cat.old / cat.total) * 100);
        const stalePercentage = Math.round((cat.stale / cat.total) * 100);
        
        // Calculate overall freshness color based on weighted score
        const freshnessScore = (cat.new * 1.0 + cat.fresh * 0.8 + cat.recent * 0.6 + cat.aging * 0.4 + cat.old * 0.2) / cat.total;
        const overallFreshnessColor = freshnessScore >= 0.7 ? '#2e7d32' : freshnessScore >= 0.4 ? '#fb8c00' : '#b71c1c';
        
        html += `
            <div style="padding: 12px 15px; background: ${bgColor}; border-bottom: 1px solid #f0f0f0;">
                <div style="display: grid; grid-template-columns: 2.5fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr 1fr 1.2fr; gap: 10px; align-items: center;">
                    <div style="font-weight: 500; color: #2d5aa0; cursor: pointer; display: flex; align-items: center;" 
                         onclick="window.toggleCategoryDetails('freshness-category-${index}')"
                         title="Click to see page details">
                        <span style="color: ${overallFreshnessColor}; margin-right: 8px;">●</span>
                        ${cat.name} 
                        <span style="font-size: 0.8rem; color: #666; margin-left: 5px;">▼</span>
                    </div>
                    <div style="text-align: center; font-weight: bold; font-size: 0.9rem;">${cat.total}</div>
                    <div style="text-align: center; color: #2e7d32; font-size: 0.85rem;">
    ${cat.new}
    <div style="font-size: 0.7rem; color: #888;">${newPercentage}%</div>
</div>
<div style="text-align: center; color: #43a047; font-size: 0.85rem;">
    ${cat.fresh}
    <div style="font-size: 0.7rem; color: #888;">${freshPercentage}%</div>
</div>
<div style="text-align: center; color: #fdd835; font-size: 0.85rem;">
    ${cat.recent}
    <div style="font-size: 0.7rem; color: #888;">${recentPercentage}%</div>
</div>
<div style="text-align: center; color: #fb8c00; font-size: 0.85rem;">
    ${cat.aging}
    <div style="font-size: 0.7rem; color: #888;">${agingPercentage}%</div>
</div>
<div style="text-align: center; color: #e53935; font-size: 0.85rem;">
    ${cat.old}
    <div style="font-size: 0.7rem; color: #888;">${oldPercentage}%</div>
</div>
<div style="text-align: center; color: #b71c1c; font-size: 0.85rem;">
    ${cat.stale}
    <div style="font-size: 0.7rem; color: #888;">${stalePercentage}%</div>
</div>
                    <div style="text-align: center; font-size: 0.9rem; color: #666;">${formatDate(cat.lastUpdated)}</div>
                </div>
                
                <!-- Freshness bar visualization -->
                <div style="margin-top: 8px; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden; display: flex;">
                    ${cat.new > 0 ? `<div style="width: ${newPercentage}%; background: #2e7d32; height: 100%;"></div>` : ''}
${cat.fresh > 0 ? `<div style="width: ${freshPercentage}%; background: #43a047; height: 100%;"></div>` : ''}
${cat.recent > 0 ? `<div style="width: ${recentPercentage}%; background: #fdd835; height: 100%;"></div>` : ''}
${cat.aging > 0 ? `<div style="width: ${agingPercentage}%; background: #fb8c00; height: 100%;"></div>` : ''}
${cat.old > 0 ? `<div style="width: ${oldPercentage}%; background: #e53935; height: 100%;"></div>` : ''}
${cat.stale > 0 ? `<div style="width: ${stalePercentage}%; background: #b71c1c; height: 100%;"></div>` : ''}
                </div>
                
                <!-- Expandable details section for this category -->
                <div id="freshness-category-${index}" style="display: none; padding: 15px; background: #f8f9ff; border-top: 1px dashed #e0e0e0; margin-top: 10px;">
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: 500; color: #1f4788; margin-bottom: 8px;">📅 Most Recent Updates:</div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
        `;
        
        // Add newest pages for this category
        if (cat.newestPages && cat.newestPages.length > 0) {
            cat.newestPages.forEach(page => {
                html += `
                    <div style="background: white; padding: 10px; border-radius: 6px; border-left: 3px solid #4caf50; display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1; margin-right: 10px;">
                            <div style="font-weight: 500; font-size: 0.9rem;">
                                <a href="${page.url}" target="_blank" style="text-decoration: none; color: #2d5aa0;" title="${page.name}">${page.name}</a>
                            </div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 4px; word-break: break-all;">${page.url}</div>
                        </div>
                        <div style="font-size: 0.8rem; color: #4caf50; white-space: nowrap;">${formatDate(page.date)}</div>
                    </div>
                `;
            });
        } else {
            html += `<div style="color: #666; font-style: italic;">No recent updates found</div>`;
        }
        
        html += `
                        </div>
                    </div>
                    
                    <div>
                        <div style="font-weight: 500; color: #1f4788; margin-bottom: 8px;">⚠️ May Need Attention:</div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
        `;
        
        // Add oldest pages for this category
        if (cat.oldestPages && cat.oldestPages.length > 0) {
            cat.oldestPages.forEach(page => {
                const daysSinceUpdate = Math.floor((now - page.date) / (1000 * 60 * 60 * 24));
                
                html += `
                    <div style="background: white; padding: 10px; border-radius: 6px; border-left: 3px solid #ff9800; display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1; margin-right: 10px;">
                            <div style="font-weight: 500; font-size: 0.9rem;">
                                <a href="${page.url}" target="_blank" style="text-decoration: none; color: #2d5aa0;" title="${page.name}">${page.name}</a>
                            </div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 4px; word-break: break-all;">${page.url}</div>
                        </div>
                        <div style="font-size: 0.8rem; color: ${daysSinceUpdate > 730 ? '#f44336' : '#ff9800'}; white-space: nowrap;">
                            ${formatDate(page.date)}
                            <div style="font-size: 0.7rem;">${daysSinceUpdate} days</div>
                        </div>
                    </div>
                `;
            });
        } else {
            html += `<div style="color: #666; font-style: italic;">No pages needing attention</div>`;
        }
        
        html += `
                        </div>
                    </div>
                </div>
            </div>
        `;
    }); // Close the forEach loop
    
    html += `
            </div>
        </div>`;
    
    
    
    
    
    
    // Recommendations
    html += `
        <div style="background: #e8f2ff; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
            <h4 style="color: #1f4788; margin-bottom: 15px;">💡 Content Maintenance Recommendations</h4>
            <ul style="color: #444; line-height: 1.6; margin-left: 20px;">
    `;
    
    if (freshness.stale > totalWithDates * 0.2) {
        html += `<li><strong>Urgent:</strong> ${freshness.stale} pages haven't been updated in over 2 years. Prioritize review and updates.</li>`;
    }
    
    if (freshness.old > totalWithDates * 0.15) {
        html += `<li><strong>Schedule Review:</strong> ${freshness.old} pages are 1-2 years old. Plan content audits.</li>`;
    }
    
    const stalestCategories = categoryArray.filter(cat => ((cat.old + cat.stale) / cat.total) > 0.4).slice(0, 3);
    if (stalestCategories.length > 0) {
        html += `<li><strong>Focus Areas:</strong> Categories needing attention: ${stalestCategories.map(c => c.name).join(', ')}</li>`;
    }
    
    if (freshnessScore >= 80) {
        html += `<li><strong>Excellent:</strong> Your content freshness is outstanding! Maintain current update schedule.</li>`;
    } else if (freshnessScore >= 60) {
        html += `<li><strong>Good:</strong> Overall freshness is healthy. Focus on aging content in key categories.</li>`;
    } else {
        html += `<li><strong>Action Needed:</strong> Content freshness needs improvement. Consider a comprehensive content audit.</li>`;
    }
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    html += `
            </ul>
        </div>
        
        <!-- Export and Close buttons -->
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="window.exportFreshnessAnalysis()" 
                    style="padding: 12px 24px; background: #4a90e2; color: white; 
                           border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                📥 Export Freshness Report
            </button>
            <button onclick="window.closeFreshnessModal()" 
                    style="padding: 12px 24px; background: #666; color: white; 
                           border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                Close
            </button>
        </div>
    `;
    
    // Initialize data for the "Pages Needing Updates" section
    window.oldestPagesData = pageDetails.oldest;
    window.oldestPagesCurrentPage = 1;
    
    // Add all the JavaScript functions for filters and pagination
    window.applyAllPagesFilters = function() {
        const freshnessFilter = document.getElementById('allPagesFreshnessFilter').value;
        const languageFilter = document.getElementById('allPagesLanguageFilter').value;
        const categoryFilter = document.getElementById('allPagesCategoryFilter').value;
        const sortBy = document.getElementById('allPagesSortBy').value;
        
        // Filter the data
        let filteredData = window.allPagesData.filter(page => {
            // Freshness filter
            if (freshnessFilter && page.freshnessLevel !== freshnessFilter) return false;
            
            // Language filter
            if (languageFilter) {
                const urlMatch = page.url.match(/\/(en|ga)\//);
                const pageLang = urlMatch ? urlMatch[1] : 'other';
                if (pageLang !== languageFilter) return false;
            }
            
            // Category filter
            if (categoryFilter && page.category !== categoryFilter) return false;
            
            return true;
        });
        
        // Sort the data
        switch(sortBy) {
            case 'date-desc':
                filteredData.sort((a, b) => b.date - a.date);
                break;
            case 'date-asc':
                filteredData.sort((a, b) => a.date - b.date);
                break;
            case 'name-asc':
                filteredData.sort((a, b) => a.name.localeCompare(b.name));
                break;
            case 'name-desc':
                filteredData.sort((a, b) => b.name.localeCompare(a.name));
                break;
            case 'category':
                filteredData.sort((a, b) => a.category.localeCompare(b.category));
                break;
        }
        
        // Update the display
        window.filteredAllPagesData = filteredData;
        window.updateAllPagesDisplay(1);
        
        // Update summary
        const summary = document.getElementById('allPagesFilterSummary');
        let summaryText = `Showing ${filteredData.length} pages`;
        const filters = [];
        if (freshnessFilter) filters.push(`freshness: ${freshnessFilter}`);
        if (languageFilter) filters.push(`language: ${languageFilter}`);
        if (categoryFilter) filters.push(`category: ${categoryFilter.substring(0, 20)}...`);
        if (filters.length > 0) {
            summaryText += ` (filtered by ${filters.join(', ')})`;
        }
        summary.textContent = summaryText;
    };

    window.updateAllPagesDisplay = function(page) {
        const data = window.filteredAllPagesData || window.allPagesData;
        const perPage = 25;
        const startIndex = (page - 1) * perPage;
        const endIndex = Math.min(startIndex + perPage, data.length);
        const totalPages = Math.ceil(data.length / perPage);
        
        // Update the list
        const listContainer = document.getElementById('allPagesList');
        let html = '';
        
        data.slice(startIndex, endIndex).forEach((page, index) => {
            const actualIndex = startIndex + index;
            const bgColor = actualIndex % 2 === 0 ? '#f9f9f9' : 'white';
            
            html += `
                <div style="padding: 12px 15px; background: ${bgColor}; border-bottom: 1px solid #f0f0f0;">
                    <div style="display: grid; grid-template-columns: 40px 3fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
                        <div style="text-align: center;">
                            <span style="color: ${page.freshnessColor}; font-size: 1.5rem;" title="${page.freshnessLevel}">●</span>
                        </div>
                        <div style="font-weight: 500; color: #2d5aa0;">
                            <a href="${page.url}" target="_blank" style="text-decoration: none; color: #2d5aa0;" title="${page.name}">${page.name}</a>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 4px; word-break: break-all;" title="${page.url}">${page.url}</div>
                        </div>
                        <div style="text-align: center; font-size: 0.9rem; color: #666;">${page.category}</div>
                        <div style="text-align: center; font-size: 0.9rem; color: #666;">${formatDate(page.date)}</div>
                        <div style="text-align: center; font-size: 0.9rem; color: ${page.freshnessColor};">
                            ${page.daysSinceUpdate} days
                        </div>
                    </div>
                </div>
            `;
        });
        
        listContainer.innerHTML = html;
        
        // Update pagination info
        document.getElementById('allPagesPaginationInfo').textContent = 
            `Showing ${startIndex + 1}-${endIndex} of ${data.length} pages`;
        
        // Update pagination controls
        window.updateAllPagesPagination(page, totalPages);
    };

    window.updateAllPagesPagination = function(currentPage, totalPages) {
        const container = document.getElementById('allPagesPaginationControls');
        let html = '';
        
        if (totalPages > 1) {
            // Previous button
            html += `
                <button onclick="window.updateAllPagesDisplay(${currentPage - 1})" 
                        style="padding: 6px 12px; border: 1px solid #ddd; background: white; 
                               color: #666; border-radius: 5px; cursor: pointer; font-size: 0.85rem;
                               ${currentPage <= 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
                        ${currentPage <= 1 ? 'disabled' : ''}>
                    ← Previous
                </button>
            `;
            
            // Page numbers (show max 5)
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            if (startPage > 1) {
                html += `
                    <button onclick="window.updateAllPagesDisplay(1)" 
                            style="padding: 6px 12px; border: 1px solid #ddd; 
                                   background: white; color: #666; 
                                   border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                        1
                    </button>
                `;
                if (startPage > 2) {
                    html += `<span style="color: #999;">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <button onclick="window.updateAllPagesDisplay(${i})" 
                            style="padding: 6px 12px; border: 1px solid ${i === currentPage ? '#1f4788' : '#ddd'}; 
                                   background: ${i === currentPage ? '#1f4788' : 'white'}; 
                                   color: ${i === currentPage ? 'white' : '#666'}; 
                                   border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                        ${i}
                    </button>
                `;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span style="color: #999;">...</span>`;
                }
                html += `
                    <button onclick="window.updateAllPagesDisplay(${totalPages})" 
                            style="padding: 6px 12px; border: 1px solid #ddd; 
                                   background: white; color: #666; 
                                   border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                        ${totalPages}
                    </button>
                `;
            }
            
            // Next button
            html += `
                <button onclick="window.updateAllPagesDisplay(${currentPage + 1})" 
                        style="padding: 6px 12px; border: 1px solid #ddd; background: white; 
                               color: #666; border-radius: 5px; cursor: pointer; font-size: 0.85rem;
                               ${currentPage >= totalPages ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
                        ${currentPage >= totalPages ? 'disabled' : ''}>
                    Next →
                </button>
            `;
        }
        
        container.innerHTML = html;
    };
    window.clearAllPagesFilters = function() {
        document.getElementById('allPagesFreshnessFilter').value = '';
        document.getElementById('allPagesLanguageFilter').value = '';
        document.getElementById('allPagesCategoryFilter').value = '';
        document.getElementById('allPagesSortBy').value = 'date-desc';
        window.applyAllPagesFilters();
    };
    
    
   
    return html;
}

        
        
        
   // Close Freshness Modal
window.closeFreshnessModal = function() {
    const modals = document.querySelectorAll('div[style*="position: fixed"][style*="z-index: 10000"]');
    modals.forEach(modal => modal.remove());
}

// Export Freshness Analysis
window.exportFreshnessAnalysis = function() {
    if (!window.freshnessPageDetails) return;
    
    let csv = 'Page Name,URL,Category,Last Updated,Days Since Update,Freshness Status\n';
    
    // Combine all pages with their freshness data
    const allPages = window.freshnessPageDetails.oldest || [];
    const now = new Date();
    
    allPages.forEach(page => {
        const daysSinceUpdate = Math.floor((now - page.date) / (1000 * 60 * 60 * 24));
        let freshnessStatus = '';
        
        if (daysSinceUpdate < 30) freshnessStatus = 'New';
        else if (daysSinceUpdate < 90) freshnessStatus = 'Fresh';
        else if (daysSinceUpdate < 180) freshnessStatus = 'Recent';
        else if (daysSinceUpdate < 365) freshnessStatus = 'Aging';
        else if (daysSinceUpdate < 730) freshnessStatus = 'Old';
        else freshnessStatus = 'Stale';
        
        // Escape quotes in strings for CSV
        const escapedName = `"${page.name.replace(/"/g, '""')}"`;
        const escapedUrl = `"${page.url.replace(/"/g, '""')}"`;
        const escapedCategory = `"${page.category.replace(/"/g, '""')}"`;
        
        csv += `${escapedName},${escapedUrl},${escapedCategory},"${formatDate(page.date)}",${daysSinceUpdate},${freshnessStatus}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'content-freshness-analysis-' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}     
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        // Category breakdown function
        window.showCategoryBreakdown = function() {
            if (!siteStats || !siteStats.languageStats) {
                alert('Please load a sitemap first');
                return;
            }
            
            const analysis = generateCategoryBreakdown();
            
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            modal.onclick = () => modal.remove();
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                max-width: 1000px; max-height: 80vh; overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;
            content.onclick = e => e.stopPropagation();
            
            content.innerHTML = analysis;
            
            // Then create and append the X button
const closeBtn = document.createElement('button');
closeBtn.innerHTML = '×';
closeBtn.style.cssText = `
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 48px;
    color: #666;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
    z-index: 1000;
`;
closeBtn.onmouseover = () => {
    closeBtn.style.background = '#f0f0f0';
    closeBtn.style.color = '#333';
};
closeBtn.onmouseout = () => {
    closeBtn.style.background = 'none';
    closeBtn.style.color = '#666';
};
closeBtn.onclick = () => modal.remove();

// Append the button AFTER setting innerHTML
content.appendChild(closeBtn);
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function generateCategoryBreakdown() {
            const englishLang = siteStats.languageStats.find(l => l.name === 'en');
            const irishLang = siteStats.languageStats.find(l => l.name === 'ga');
            
            let html = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #1f4788; margin-bottom: 10px;">📋 Detailed Category Breakdown</h2>
                    <p style="color: #666;">Complete analysis of your site's content structure</p>
                </div>
            `;
            
            if (englishLang) {
                const englishCategories = Object.values(englishLang.children).sort((a, b) => b.pages - a.pages);
                
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #1f4788; margin-bottom: 20px; display: flex; align-items: center;">
                            🇬🇧 English Content (${englishLang.pages.toLocaleString()} pages - ${englishLang.percentage}% of site)
                        </h3>
                        
                        <div style="background: #f8f9ff; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #4a90e2;">${englishCategories.length}</div>
                                    <div style="color: #666; font-size: 0.9rem;">Categories</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #4a90e2;">${englishLang.maxDepth}</div>
                                    <div style="color: #666; font-size: 0.9rem;">Max Depth</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #4a90e2;">${Math.round(englishLang.pages / englishCategories.length)}</div>
                                    <div style="color: #666; font-size: 0.9rem;">Avg Pages/Category</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: white; border-radius: 10px; border: 1px solid #e0e0e0; overflow: hidden;">
                            <div style="background: #1f4788; color: white; padding: 15px; font-weight: bold;">
                                <div style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
                                    <div>Category Name</div>
                                    <div style="text-align: center;">Pages</div>
                                    <div style="text-align: center;">% of EN</div>
                                    <div style="text-align: center;">Subcategories</div>
                                    <div style="text-align: center;">Max Depth</div>
                                </div>
                            </div>
                `;
                
                englishCategories.forEach((cat, index) => {
                    const bgColor = index % 2 === 0 ? '#f9f9f9' : 'white';
                    const barWidth = (cat.pages / englishCategories[0].pages) * 100;
                    
                    html += `
    <div style="padding: 12px 15px; background: ${bgColor}; border-bottom: 1px solid #f0f0f0;">
        <div style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; margin-bottom: 8px;">
            <div style="font-weight: 500; color: #2d5aa0;">${cat.name}</div>
            <div style="text-align: center; font-weight: bold; color: #333;">${cat.pages.toLocaleString()}</div>
            <div style="text-align: center; color: #333;">${cat.langPercentage}%</div>
            <div style="text-align: center; color: #333;">${cat.subcategories}</div>
            <div style="text-align: center; color: #333;">${cat.maxDepth}</div>
        </div>
        <div style="background: #d0d0d0; height: 4px; border-radius: 2px; overflow: hidden;">
            <div style="background: #4a90e2; height: 100%; width: ${barWidth}%; border-radius: 2px;"></div>
        </div>
    </div>
`;
                });
                
                html += `</div></div>`;
            }
            
            if (irishLang && irishLang.pages > 0) {
                const irishCategories = Object.values(irishLang.children).sort((a, b) => b.pages - a.pages);
                
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #1f4788; margin-bottom: 20px; display: flex; align-items: center;">
                            🇮🇪 Irish Content (${irishLang.pages.toLocaleString()} pages - ${irishLang.percentage}% of site)
                        </h3>
                        
                        <div style="background: #f0f8f0; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #7fb069;">${irishCategories.length}</div>
                                    <div style="color: #666; font-size: 0.9rem;">Categories</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #7fb069;">${irishLang.maxDepth}</div>
                                    <div style="color: #666; font-size: 0.9rem;">Max Depth</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #7fb069;">${Math.round(irishLang.pages / irishCategories.length)}</div>
                                    <div style="color: #666; font-size: 0.9rem;">Avg Pages/Category</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: white; border-radius: 10px; border: 1px solid #e0e0e0; overflow: hidden;">
                            <div style="background: #52734d; color: white; padding: 15px; font-weight: bold;">
                                <div style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
                                    <div>Category Name</div>
                                    <div style="text-align: center;">Pages</div>
                                    <div style="text-align: center;">% of GA</div>
                                    <div style="text-align: center;">Subcategories</div>
                                    <div style="text-align: center;">Max Depth</div>
                                </div>
                            </div>
                `;
                
                irishCategories.forEach((cat, index) => {
                    const bgColor = index % 2 === 0 ? '#f9f9f9' : 'white';
                    const barWidth = (cat.pages / irishCategories[0].pages) * 100;
                    
                    html += `
                        <div style="padding: 12px 15px; background: ${bgColor}; border-bottom: 1px solid #f0f0f0;">
                            <div style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: 500; color: #52734d;">${cat.name}</div>
                                <div style="text-align: center; font-weight: bold;">${cat.pages.toLocaleString()}</div>
                                <div style="text-align: center;">${cat.langPercentage}%</div>
                                <div style="text-align: center;">${cat.subcategories}</div>
                                <div style="text-align: center;">${cat.maxDepth}</div>
                            </div>
                            <div style="background: #e8f5e8; height: 4px; border-radius: 2px; overflow: hidden;">
                                <div style="background: #7fb069; height: 100%; width: ${barWidth}%; border-radius: 2px;"></div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            // Recommendations section
            html += `
                <div style="background: #e8f2ff; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #1f4788; margin-bottom: 15px;">💡 Category Optimization Recommendations</h4>
                    <ul style="color: #444; line-height: 1.6; margin-left: 20px;">
            `;
            
            if (englishLang) {
                const topCategory = Object.values(englishLang.children).sort((a, b) => b.pages - a.pages)[0];
                if (topCategory.langPercentage > 30) {
                    html += `<li><strong>Balance Content:</strong> "${topCategory.name}" dominates with ${topCategory.langPercentage}% of English content. Consider redistributing or breaking into subcategories.</li>`;
                }
                
                const smallCategories = Object.values(englishLang.children).filter(cat => cat.pages < 10);
                if (smallCategories.length > 0) {
                    html += `<li><strong>Consolidate Small Sections:</strong> ${smallCategories.length} categories have fewer than 10 pages. Consider merging related topics.</li>`;
                }
                
                const deepCategories = Object.values(englishLang.children).filter(cat => cat.maxDepth > 4);
                if (deepCategories.length > 0) {
                    html += `<li><strong>Flatten Deep Sections:</strong> ${deepCategories.length} categories exceed 4 levels depth. Simplify navigation structure.</li>`;
                }
            }
            
            html += `
                        <li><strong>Internal Linking:</strong> Ensure cross-category linking to improve user navigation and SEO.</li>
                        <li><strong>Content Gaps:</strong> Identify underrepresented topics that could benefit from expansion.</li>
                    </ul>
                </div>
                
                <!-- Export and Close buttons -->
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="window.exportCategoryBreakdown()" 
                            style="padding: 12px 24px; background: #4a90e2; color: white; 
                                   border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        📥 Export Category Report
                    </button>
                    <button onclick="window.closeCategoryModal()" 
                            style="padding: 12px 24px; background: #666; color: white; 
                                   border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Close
                    </button>
                </div>
            `;
            
            return html;
        }
        
        
        
        // Close Category Modal
window.closeCategoryModal = function() {
    const modals = document.querySelectorAll('div[style*="position: fixed"][style*="z-index: 10000"]');
    modals.forEach(modal => modal.remove());
}

// Export Category Breakdown
window.exportCategoryBreakdown = function() {
    if (!siteStats || !siteStats.languageStats) return;
    
    let csv = 'Language,Category,Pages,Percentage of Language,Subcategories,Max Depth,Average Depth\n';
    
    // Export English categories
    const englishLang = siteStats.languageStats.find(l => l.name === 'en');
    if (englishLang) {
        const englishCategories = Object.values(englishLang.children).sort((a, b) => b.pages - a.pages);
        englishCategories.forEach(cat => {
            csv += `"English","${cat.name.replace(/"/g, '""')}",${cat.pages},${cat.langPercentage}%,${cat.subcategories},${cat.maxDepth},${cat.avgDepth}\n`;
        });
    }
    
    // Export Irish categories
    const irishLang = siteStats.languageStats.find(l => l.name === 'ga');
    if (irishLang && irishLang.pages > 0) {
        const irishCategories = Object.values(irishLang.children).sort((a, b) => b.pages - a.pages);
        irishCategories.forEach(cat => {
            csv += `"Irish","${cat.name.replace(/"/g, '""')}",${cat.pages},${cat.langPercentage}%,${cat.subcategories},${cat.maxDepth},${cat.avgDepth}\n`;
        });
    }
    
    // Add summary section
    csv += '\n\nSummary Statistics\n';
    csv += 'Metric,Value\n';
    csv += `Total Pages,${siteStats.totalPages}\n`;
    csv += `Total Categories,${siteStats.categoryCount}\n`;
    csv += `Maximum Depth,${siteStats.maxDepth}\n`;
    csv += `Average Depth,${siteStats.avgDepth}\n`;
    
    if (englishLang) {
        csv += `English Pages,${englishLang.pages} (${englishLang.percentage}%)\n`;
        csv += `English Categories,${englishLang.categories}\n`;
    }
    
    if (irishLang && irishLang.pages > 0) {
        csv += `Irish Pages,${irishLang.pages} (${irishLang.percentage}%)\n`;
        csv += `Irish Categories,${irishLang.categories}\n`;
    }
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'category-breakdown-' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}


        // URL Pattern Analysis Implementation
window.showURLPatternAnalysis = function() {
    if (!siteStats || !treeData) {
        alert('Please load a sitemap first');
        return;
    }
    
    const analysis = analyzeURLPatterns();
    
    // Create modal overlay
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
        align-items: center; justify-content: center; padding: 20px;
    `;
    
    modal.onclick = () => modal.remove();
    
    const content = document.createElement('div');
    content.style.cssText = `
        background: white; padding: 30px; border-radius: 15px; 
        max-width: 1200px; max-height: 85vh; overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    `;
    content.onclick = e => e.stopPropagation();
    
    content.innerHTML = generateURLPatternHTML(analysis);
    
    
    // Then create and append the X button
const closeBtn = document.createElement('button');
closeBtn.innerHTML = '×';
closeBtn.style.cssText = `
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 28px;
    color: #666;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
    z-index: 1000;
`;
closeBtn.onmouseover = () => {
    closeBtn.style.background = '#f0f0f0';
    closeBtn.style.color = '#333';
};
closeBtn.onmouseout = () => {
    closeBtn.style.background = 'none';
    closeBtn.style.color = '#666';
};
closeBtn.onclick = () => modal.remove();

// Append the button AFTER setting innerHTML
content.appendChild(closeBtn);



    modal.appendChild(content);
    document.body.appendChild(modal);
}

function analyzeURLPatterns() {
    const allURLs = [];
    const now = new Date();
    
    // Collect all URLs from the tree
    function collectURLs(node, depth = 0) {
        if (node.url) {
            allURLs.push({
                url: node.url,
                name: node.name,
                depth: depth,
                lastModified: node.lastModified
            });
        }
        if (node.children) {
            node.children.forEach(child => collectURLs(child, depth + 1));
        }
    }
    
    collectURLs(treeData);
    
    const analysis = {
        totalURLs: allURLs.length,
        healthScore: 100,
        issues: {
            critical: [],
            warning: [],
            info: []
        },
        patterns: {},
        patternExamples: {},
        stats: {
            avgLength: 0,
            maxLength: 0,
            minLength: Infinity,
            withFileExt: 0,
            withUppercase: 0,
            withSpecialChars: 0,
            withNumbers: 0,
            withMultipleHyphens: 0,
            withTrailingSlash: 0,
            withParameters: 0,
            nonDescriptive: 0
        },
        depthDistribution: {},
        fileExtensions: {},
        recommendations: []
    };
    
    let totalLength = 0;
    
    // Analyze each URL
    allURLs.forEach(item => {
        const url = item.url;
        const path = url.replace(/^https?:\/\/[^\/]+/, '');
        
        // URL Length
        totalLength += url.length;
        if (url.length > analysis.stats.maxLength) {
            analysis.stats.maxLength = url.length;
        }
        if (url.length < analysis.stats.minLength) {
            analysis.stats.minLength = url.length;
        }
        
        if (url.length > 115) {
            analysis.issues.critical.push({
                url: url,
                issue: 'URL too long (' + url.length + ' characters)',
                recommendation: 'Shorten URL to under 115 characters for better SEO',
                type: 'length'
            });
            analysis.healthScore -= 2;
        } else if (url.length > 90) {
            analysis.issues.warning.push({
                url: url,
                issue: 'URL quite long (' + url.length + ' characters)',
                recommendation: 'Consider shortening URL to under 90 characters',
                type: 'length'
            });
            analysis.healthScore -= 1;
        }
        
        // Uppercase check
        if (path !== path.toLowerCase()) {
            analysis.stats.withUppercase++;
            analysis.issues.critical.push({
                url: url,
                issue: 'Contains uppercase letters',
                recommendation: 'Use lowercase URLs for consistency and SEO',
                type: 'uppercase'
            });
            analysis.healthScore -= 2;
        }
        
        // Special characters check (excluding normal URL chars)
        const specialChars = /[^a-zA-Z0-9\-._~:/?#[\]@!$&'()*+,;=]/;
        if (specialChars.test(path)) {
            analysis.stats.withSpecialChars++;
            analysis.issues.warning.push({
                url: url,
                issue: 'Contains special characters',
                recommendation: 'Replace special characters with hyphens',
                type: 'special-chars'
            });
            analysis.healthScore -= 1;
        }
        
        // Multiple consecutive hyphens or underscores
        if (/--+|__+/.test(path)) {
            analysis.stats.withMultipleHyphens++;
            analysis.issues.warning.push({
                url: url,
                issue: 'Contains multiple consecutive hyphens/underscores',
                recommendation: 'Use single hyphens as word separators',
                type: 'multiple-hyphens'
            });
            analysis.healthScore -= 0.5;
        }
        
        // Non-descriptive URLs
        const nonDescriptivePatterns = /\/(page\d+|item\d+|untitled|default|test|temp|new\d*|[a-f0-9]{8,})\b/i;
        if (nonDescriptivePatterns.test(path)) {
            analysis.stats.nonDescriptive++;
            analysis.issues.warning.push({
                url: url,
                issue: 'Non-descriptive URL',
                recommendation: 'Use descriptive, keyword-rich URLs',
                type: 'non-descriptive'
            });
            analysis.healthScore -= 1.5;
        }
        
        // File extension analysis
        const extMatch = path.match(/\.([a-zA-Z0-9]+)$/);
        if (extMatch) {
            const ext = extMatch[1].toLowerCase();
            analysis.fileExtensions[ext] = (analysis.fileExtensions[ext] || 0) + 1;
            analysis.stats.withFileExt++;
            
            if (['html', 'htm', 'php', 'asp', 'aspx', 'jsp'].includes(ext)) {
                analysis.issues.info.push({
                    url: url,
                    issue: 'Uses file extension (.' + ext + ')',
                    recommendation: 'Consider removing file extensions for cleaner URLs',
                    type: 'file-extension'
                });
                analysis.healthScore -= 0.2;
            }
        }
        
        // Query parameters
        if (url.includes('?')) {
            analysis.stats.withParameters++;
            analysis.issues.info.push({
                url: url,
                issue: 'Contains query parameters',
                recommendation: 'Consider using clean URLs without parameters',
                type: 'parameters'
            });
            analysis.healthScore -= 0.5;
        }
        
        // Trailing slash check (excluding root)
        if (path !== '/' && path.endsWith('/')) {
            analysis.stats.withTrailingSlash++;
        }
        
        // Pattern extraction (simplified)
        let pattern = path
            .replace(/\/[0-9]+/g, '/{id}')
            .replace(/\/[a-f0-9]{8,}/g, '/{hash}')
            .replace(/\/\d{4}\/\d{2}\/\d{2}/g, '/{date}')
            .replace(/\/[^\/]+\.(html|htm|php|asp|aspx|jsp)$/g, '/{page}')
            .replace(/\/[^\/]+$/g, '/{slug}');
        
        if (!analysis.patterns[pattern]) {
            analysis.patterns[pattern] = 0;
            analysis.patternExamples[pattern] = [];
        }
        analysis.patterns[pattern]++;
        if (analysis.patternExamples[pattern].length < 3) {
            analysis.patternExamples[pattern].push(url);
        }
        
        // Depth distribution
        analysis.depthDistribution[item.depth] = (analysis.depthDistribution[item.depth] || 0) + 1;
    });
    
    analysis.stats.avgLength = Math.round(totalLength / allURLs.length);
    
    // Generate recommendations
    if (analysis.stats.withUppercase > 0) {
        analysis.recommendations.push({
            priority: 'high',
            title: 'Standardize URL Case',
            description: `${analysis.stats.withUppercase} URLs contain uppercase letters. Convert all URLs to lowercase for consistency and better SEO.`,
            impact: 'Improves URL consistency and prevents duplicate content issues'
        });
    }
    
    if (analysis.stats.nonDescriptive > 0) {
        analysis.recommendations.push({
            priority: 'high',
            title: 'Improve URL Descriptiveness',
            description: `${analysis.stats.nonDescriptive} URLs are non-descriptive. Replace with keyword-rich, meaningful URLs.`,
            impact: 'Better SEO rankings and user experience'
        });
    }
    
    if (analysis.stats.avgLength > 75) {
        analysis.recommendations.push({
            priority: 'medium',
            title: 'Shorten Long URLs',
            description: `Average URL length is ${analysis.stats.avgLength} characters. Aim for under 75 characters.`,
            impact: 'Improved user experience and social media sharing'
        });
    }
    
    if (Object.keys(analysis.patterns).length > 20) {
        analysis.recommendations.push({
            priority: 'medium',
            title: 'Standardize URL Patterns',
            description: `Found ${Object.keys(analysis.patterns).length} different URL patterns. Consider consolidating similar patterns.`,
            impact: 'Easier maintenance and better site structure'
        });
    }
    
    if (analysis.stats.withFileExt > allURLs.length * 0.5) {
        analysis.recommendations.push({
            priority: 'low',
            title: 'Remove File Extensions',
            description: `${Math.round(analysis.stats.withFileExt / allURLs.length * 100)}% of URLs use file extensions. Consider removing them for cleaner URLs.`,
            impact: 'Modern, cleaner URLs that are platform-agnostic'
        });
    }
    
    // Ensure health score doesn't go below 0
    analysis.healthScore = Math.max(0, Math.round(analysis.healthScore));
    
    return analysis;
}

function generateURLPatternHTML(analysis) {
    const scoreColor = analysis.healthScore >= 80 ? '#4caf50' : 
                     analysis.healthScore >= 60 ? '#ff9800' : '#f44336';
    
    const scoreLabel = analysis.healthScore >= 80 ? 'Excellent' : 
                      analysis.healthScore >= 60 ? 'Good' : 'Needs Improvement';
    
    let html = `
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: #1f4788; margin-bottom: 10px;">🔍 URL Pattern Analysis</h2>
            <p style="color: #666;">Comprehensive analysis of your URL structure and health</p>
        </div>
        
        <!-- Health Score -->
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="display: inline-block; position: relative;">
                <svg width="200" height="200" viewBox="0 0 200 200">
                    <circle cx="100" cy="100" r="90" fill="none" stroke="#f0f0f0" stroke-width="20"/>
                    <circle cx="100" cy="100" r="90" fill="none" stroke="${scoreColor}" stroke-width="20"
                            stroke-dasharray="${analysis.healthScore * 5.65} 565"
                            stroke-dashoffset="0"
                            transform="rotate(-90 100 100)"
                            style="transition: stroke-dasharray 1s ease;"/>
                </svg>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div style="font-size: 3rem; font-weight: bold; color: ${scoreColor};">${analysis.healthScore}%</div>
                    <div style="color: #666; font-size: 1rem;">${scoreLabel}</div>
                </div>
            </div>
        </div>
        
        <!-- Key Metrics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
            <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: #4a90e2;">${analysis.totalURLs}</div>
                <div style="color: #666; margin-top: 5px;">Total URLs</div>
            </div>
            <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: #4a90e2;">${analysis.stats.avgLength}</div>
                <div style="color: #666; margin-top: 5px;">Avg Length</div>
            </div>
            <div style="background: ${analysis.issues.critical.length > 0 ? '#ffebee' : '#e8f5e8'}; padding: 20px; border-radius: 10px; text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: ${analysis.issues.critical.length > 0 ? '#f44336' : '#4caf50'};">
                    ${analysis.issues.critical.length}
                </div>
                <div style="color: #666; margin-top: 5px;">Critical Issues</div>
            </div>
            <div style="background: ${analysis.issues.warning.length > 0 ? '#fff8e1' : '#e8f5e8'}; padding: 20px; border-radius: 10px; text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: ${analysis.issues.warning.length > 0 ? '#ff9800' : '#4caf50'};">
                    ${analysis.issues.warning.length}
                </div>
                <div style="color: #666; margin-top: 5px;">Warnings</div>
            </div>
        </div>
        
        <!-- URL Statistics -->
        <div style="margin-bottom: 30px;">
            <h3 style="color: #1f4788; margin-bottom: 20px;">📊 URL Characteristics</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
    `;
    
    const characteristics = [
        {
            label: 'URLs with uppercase letters',
            count: analysis.stats.withUppercase,
            percentage: Math.round(analysis.stats.withUppercase / analysis.totalURLs * 100),
            color: analysis.stats.withUppercase > 0 ? '#f44336' : '#4caf50',
            icon: '⚠️'
        },
        {
            label: 'Non-descriptive URLs',
            count: analysis.stats.nonDescriptive,
            percentage: Math.round(analysis.stats.nonDescriptive / analysis.totalURLs * 100),
            color: analysis.stats.nonDescriptive > 0 ? '#ff9800' : '#4caf50',
            icon: '📝'
        },
        {
            label: 'URLs with file extensions',
            count: analysis.stats.withFileExt,
            percentage: Math.round(analysis.stats.withFileExt / analysis.totalURLs * 100),
            color: '#2196f3',
            icon: '📄'
        },
        {
            label: 'URLs with special characters',
            count: analysis.stats.withSpecialChars,
            percentage: Math.round(analysis.stats.withSpecialChars / analysis.totalURLs * 100),
            color: analysis.stats.withSpecialChars > 0 ? '#ff9800' : '#4caf50',
            icon: '⚡'
        },
        {
            label: 'URLs with parameters',
            count: analysis.stats.withParameters,
            percentage: Math.round(analysis.stats.withParameters / analysis.totalURLs * 100),
            color: analysis.stats.withParameters > 0 ? '#ff9800' : '#4caf50',
            icon: '❓'
        },
        {
            label: 'Max URL depth',
            count: Math.max(...Object.keys(analysis.depthDistribution).map(Number)),
            percentage: '',
            color: Math.max(...Object.keys(analysis.depthDistribution).map(Number)) > 4 ? '#ff9800' : '#4caf50',
            icon: '📏'
        }
    ];
    
    characteristics.forEach(char => {
        html += `
            <div style="background: white; border-left: 4px solid ${char.color}; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="color: #666; font-size: 0.9rem;">${char.label}</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${char.color}; margin-top: 5px;">
                            ${char.count} ${char.percentage !== '' ? `(${char.percentage}%)` : ''}
                        </div>
                    </div>
                    <div style="font-size: 2rem;">${char.icon}</div>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
        
        <!-- Common URL Patterns -->
        <div style="margin-bottom: 30px;">
            <h3 style="color: #1f4788; margin-bottom: 20px;">🔗 Most Common URL Patterns</h3>
            <div style="background: white; border-radius: 10px; border: 1px solid #e0e0e0; overflow: hidden;">
    `;
    
    const sortedPatterns = Object.entries(analysis.patterns)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    
    sortedPatterns.forEach((pattern, index) => {
        const percentage = Math.round(pattern[1] / analysis.totalURLs * 100);
        html += `
            <div style="padding: 15px; background: ${index % 2 === 0 ? '#f9f9f9' : 'white'}; border-bottom: 1px solid #f0f0f0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-family: monospace; color: #2d5aa0; font-size: 0.9rem;">${pattern[0]}</div>
                    <div style="font-weight: bold; color: #4a90e2;">${pattern[1]} URLs (${percentage}%)</div>
                </div>
                <div style="background: #e3f2fd; height: 6px; border-radius: 3px; overflow: hidden;">
                    <div style="background: #4a90e2; height: 100%; width: ${percentage}%; border-radius: 3px;"></div>
                </div>
                <div style="font-size: 0.8rem; color: #666; margin-top: 8px;">
                    Examples: ${analysis.patternExamples[pattern[0]].slice(0, 2).map(url => 
                        `<a href="${url}" target="_blank" style="color: #4a90e2; text-decoration: none;">${url.replace(/^https?:\/\/[^\/]+/, '')}</a>`
                    ).join(', ')}
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
        
        <!-- Recommendations -->
        ${analysis.recommendations.length > 0 ? `
        <div style="margin-bottom: 30px;">
            <h3 style="color: #1f4788; margin-bottom: 20px;">💡 Recommendations</h3>
            <div style="display: grid; gap: 15px;">
                ${analysis.recommendations.map(rec => `
                    <div style="background: ${rec.priority === 'high' ? '#ffebee' : rec.priority === 'medium' ? '#fff8e1' : '#e8f2ff'}; 
                                border-left: 4px solid ${rec.priority === 'high' ? '#f44336' : rec.priority === 'medium' ? '#ff9800' : '#2196f3'}; 
                                padding: 20px; border-radius: 8px;">
                        <div style="display: flex; align-items: start; gap: 15px;">
                            <div style="font-size: 1.5rem;">${rec.priority === 'high' ? '🚨' : rec.priority === 'medium' ? '⚠️' : 'ℹ️'}</div>
                            <div style="flex: 1;">
                                <h4 style="color: #1f4788; margin-bottom: 8px;">${rec.title}</h4>
                                <p style="color: #666; margin-bottom: 8px;">${rec.description}</p>
                                <div style="font-size: 0.85rem; color: #888;">
                                    <strong>Impact:</strong> ${rec.impact}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
        
        <!-- Issues List -->
        ${analysis.issues.critical.length > 0 || analysis.issues.warning.length > 0 ? `
        <div style="margin-bottom: 30px;">
            <h3 style="color: #1f4788; margin-bottom: 20px;">🔧 Detailed Issues</h3>
            
            <!-- Filters -->
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 250px;">
                    <input type="text" id="issueSearchInput" placeholder="🔍 Search by URL..." 
                           onkeyup="window.filterIssues()"
                           style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; 
                                  border-radius: 8px; font-size: 14px; outline: none;
                                  transition: all 0.3s ease;"
                           onfocus="this.style.borderColor='#4a90e2'; this.style.boxShadow='0 0 0 3px rgba(74,144,226,0.1)'"
                           onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                </div>
                <div style="min-width: 200px;">
                    <select id="issueTypeFilter" onchange="window.filterIssues()"
                            style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; 
                                   border-radius: 8px; font-size: 14px; outline: none; cursor: pointer;
                                   background: white; transition: all 0.3s ease;"
                            onfocus="this.style.borderColor='#4a90e2'; this.style.boxShadow='0 0 0 3px rgba(74,144,226,0.1)'"
                            onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                        <option value="">All Issue Types</option>
                        <option value="length">URL Length Issues</option>
                        <option value="uppercase">Uppercase Letters</option>
                        <option value="special-chars">Special Characters</option>
                        <option value="multiple-hyphens">Multiple Hyphens</option>
                        <option value="non-descriptive">Non-descriptive URLs</option>
                        <option value="file-extension">File Extensions</option>
                        <option value="parameters">Query Parameters</option>
                    </select>
                </div>
                <button onclick="window.clearFilters()" 
                        style="padding: 10px 20px; background: #f0f0f0; border: none; 
                               border-radius: 8px; cursor: pointer; font-size: 14px;
                               transition: all 0.3s ease;"
                        onmouseover="this.style.background='#e0e0e0'"
                        onmouseout="this.style.background='#f0f0f0'">
                    Clear Filters
                </button>
            </div>
            
            <!-- Tabs for issue types -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                <button onclick="window.showIssueTab('critical')" id="criticalTab" 
                        style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid #f44336; 
                               color: #f44336; font-weight: bold; cursor: pointer;">
                    Critical (<span id="criticalCount">${analysis.issues.critical.length}</span>)
                </button>
                <button onclick="window.showIssueTab('warning')" id="warningTab"
                        style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; 
                               color: #666; cursor: pointer;">
                    Warnings (<span id="warningCount">${analysis.issues.warning.length}</span>)
                </button>
                <button onclick="window.showIssueTab('info')" id="infoTab"
                        style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; 
                               color: #666; cursor: pointer;">
                    Info (<span id="infoCount">${analysis.issues.info.length}</span>)
                </button>
            </div>
            
            <!-- Issues container -->
            <div id="issuesContainer">
                ${generateIssuesList(analysis.issues.critical, 'critical')}
            </div>
        </div>
        ` : ''}
        
        <!-- Export Options -->
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="window.exportURLAnalysis()" 
                    style="padding: 12px 24px; background: #4a90e2; color: white; 
                           border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                📥 Export Analysis Report
            </button>
            <button onclick="window.closeURLModal()" 
                    style="padding: 12px 24px; background: #666; color: white; 
                           border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                Close
            </button>
        </div>
    `;
    
    // Store issues data for tab switching
    window.urlAnalysisIssues = analysis.issues;
    window.currentIssueTab = 'critical';
    
    return html;
}

function generateIssuesList(issues, type, searchTerm = '', issueTypeFilter = '') {
    // Apply filters
    let filteredIssues = issues;
    
    if (searchTerm) {
        filteredIssues = filteredIssues.filter(issue => 
            issue.url.toLowerCase().includes(searchTerm.toLowerCase())
        );
    }
    
    if (issueTypeFilter) {
        filteredIssues = filteredIssues.filter(issue => 
            issue.type === issueTypeFilter
        );
    }
    
    if (filteredIssues.length === 0) {
        return '<p style="text-align: center; color: #666; padding: 20px;">No issues found matching your filters.</p>';
    }
    
    const bgColor = type === 'critical' ? '#ffebee' : type === 'warning' ? '#fff8e1' : '#e8f2ff';
    const borderColor = type === 'critical' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196f3';
    
    let html = `<div style="display: grid; gap: 10px; max-height: 400px; overflow-y: auto;">
        <div style="color: #666; font-size: 0.85rem; padding: 10px;">
            Showing ${filteredIssues.length} of ${issues.length} issues
        </div>`;
    
    filteredIssues.forEach((issue, index) => {
        html += `
            <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; 
                        padding: 15px; border-radius: 8px;">
                <div style="font-weight: 500; color: #333; margin-bottom: 5px;">
                    ${issue.issue}
                </div>
                <div style="font-size: 0.85rem; color: #666; margin-bottom: 8px; word-break: break-all;">
                    <a href="${issue.url}" target="_blank" style="color: #4a90e2; text-decoration: none;">
                        ${issue.url}
                    </a>
                </div>
                <div style="font-size: 0.85rem; color: #888;">
                    💡 ${issue.recommendation}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

window.showIssueTab = function(tabType) {
    window.currentIssueTab = tabType;
    
    // Update tab styles
    ['critical', 'warning', 'info'].forEach(type => {
        const tab = document.getElementById(type + 'Tab');
        if (tab) {
            if (type === tabType) {
                tab.style.borderBottom = '3px solid ' + 
                    (type === 'critical' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196f3');
                tab.style.color = type === 'critical' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196f3';
                tab.style.fontWeight = 'bold';
            } else {
                tab.style.borderBottom = '3px solid transparent';
                tab.style.color = '#666';
                tab.style.fontWeight = 'normal';
            }
        }
    });
    
    // Apply current filters
    window.filterIssues();
}

window.filterIssues = function() {
    const searchTerm = document.getElementById('issueSearchInput')?.value || '';
    const issueTypeFilter = document.getElementById('issueTypeFilter')?.value || '';
    const container = document.getElementById('issuesContainer');
    
    if (container && window.urlAnalysisIssues && window.currentIssueTab) {
        const issues = window.urlAnalysisIssues[window.currentIssueTab];
        container.innerHTML = generateIssuesList(issues, window.currentIssueTab, searchTerm, issueTypeFilter);
        
        // Update counts
        ['critical', 'warning', 'info'].forEach(type => {
            const countEl = document.getElementById(type + 'Count');
            if (countEl) {
                const typeIssues = window.urlAnalysisIssues[type];
                let filteredCount = typeIssues.length;
                
                if (searchTerm || issueTypeFilter) {
                    filteredCount = typeIssues.filter(issue => {
                        const matchesSearch = !searchTerm || issue.url.toLowerCase().includes(searchTerm.toLowerCase());
                        const matchesType = !issueTypeFilter || issue.type === issueTypeFilter;
                        return matchesSearch && matchesType;
                    }).length;
                }
                
                countEl.textContent = filteredCount;
            }
        });
    }
}

window.clearFilters = function() {
    const searchInput = document.getElementById('issueSearchInput');
    const typeFilter = document.getElementById('issueTypeFilter');
    
    if (searchInput) searchInput.value = '';
    if (typeFilter) typeFilter.value = '';
    
    window.filterIssues();
}

window.closeURLModal = function() {
    const modals = document.querySelectorAll('div[style*="position: fixed"][style*="z-index: 10000"]');
    modals.forEach(modal => modal.remove());
}

window.exportURLAnalysis = function() {
    if (!window.urlAnalysisIssues) return;
    
    let csv = 'Type,Issue,URL,Recommendation\n';
    
    ['critical', 'warning', 'info'].forEach(type => {
        window.urlAnalysisIssues[type].forEach(issue => {
            csv += `"${type}","${issue.issue}","${issue.url}","${issue.recommendation}"\n`;
        });
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'url-pattern-analysis-' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}
        
        
        
        
        
        

        // Initialize
        updateDimensions();

        // Event listeners
        window.addEventListener('resize', optimizedResize);
        
        
        // Event listeners
window.addEventListener('resize', optimizedResize);

// Handle orientation changes
// Handle orientation changes
window.addEventListener('orientationchange', function() {
    if (is3DViewActive) {
        setTimeout(() => {
            // Readjust camera
            const distance = calculateOptimalDistance();
            Graph3D.cameraPosition(
                { x: 0, y: distance * 0.7, z: distance * 0.3 },
                { x: 0, y: 0, z: 0 },
                1000
            );
        }, 100);
    }
});	
        
        
        

        

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        if (uploadArea && fileInput) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
        
        // Also clear the file input when dropping files
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.value = '';
        }
    }
});

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }
        
        
        
        // Stats toggle functionality
function toggleStats() {
    const stats = document.getElementById('stats');
    const legend = document.getElementById('colourLegend');
    
    if (stats) {
        stats.classList.toggle('collapsed');
        
        // Update button text
        const toggleBtn = stats.querySelector('.stats-toggle');
        if (toggleBtn) {
            toggleBtn.innerHTML = stats.classList.contains('collapsed') ? '+' : '−';
        }
        
        // Optionally collapse legend too
        if (legend) {
            legend.classList.toggle('collapsed');
        }
        
        // Save state
        localStorage.setItem('statsCollapsed', stats.classList.contains('collapsed'));
    }
}
        

        // Initialize on DOM load
document.addEventListener('DOMContentLoaded', function() {
    showViewPreview('tree');
    
    // Initialize enhanced tooltip
    enhancedTooltip = createEnhancedTooltip();
    
    // Initialize nav bar visibility
    const navBar = document.getElementById('navBar');
    if (navBar) {
        navBar.style.display = 'flex';
        
        // Initially disable view/report buttons until sitemap loads
        const buttons = ['treeViewBtn', 'dashboardViewBtn', 'reportsDropdown'];
        buttons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.style.opacity = '0.5';
                btn.style.pointerEvents = 'none';
            }
        });
    }
    
    // Initialize theme icon
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) {
        themeIcon.textContent = isDarkTheme ? '☀️' : '🌙';
    }
    
    // Initialize upload section (your existing function)
    initializeUploadSection();
    
    // Connect nav search to main search functionality
    const navSearchInput = document.getElementById('navSearchInput');
    if (navSearchInput) {
        navSearchInput.addEventListener('input', function(e) {
            // Sync with main search input
            const mainSearchInput = document.getElementById('searchInput');
            if (mainSearchInput) {
                mainSearchInput.value = e.target.value;
                mainSearchInput.dispatchEvent(new Event('input'));
            }
        });
    }
    
    // Restore stats collapsed state
    const statsCollapsed = localStorage.getItem('statsCollapsed') === 'true';
    if (statsCollapsed) {
        const stats = document.getElementById('stats');
        const legend = document.getElementById('colourLegend');
        if (stats) stats.classList.add('collapsed');
        if (legend) legend.classList.add('collapsed');
    }
    
    // ========== NEW: Mobile-specific improvements ==========
    if (checkIfMobile()) {
        // Add mobile class to body
        document.body.classList.add('mobile-device');
        
        // Set up touch handling
        setup3DTouchHandling();
        
        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    }
});



// Enhanced Tooltip Helper Functions
window.focusOnNode = function(nodeId) {
    const targetNode = allNodes.find(n => 
        (n.id && n.id == nodeId) || 
        (n.data && n.data.name === nodeId)
    );
    
    if (targetNode) {
        // Expand path to node
        expandPathToNode(targetNode);
        update(root);
        
        setTimeout(() => {
            panToNode(targetNode);
            highlightNode(targetNode);
        }, 800);
    }
}

window.toggleNode = function(nodeId) {
    const targetNode = allNodes.find(n => 
        (n.id && n.id == nodeId) || 
        (n.data && n.data.name === nodeId)
    );
    
    if (targetNode) {
        click(null, targetNode);
    }
}

window.expandBranch = function(nodeId) {
    const targetNode = allNodes.find(n => 
        (n.id && n.id == nodeId) || 
        (n.data && n.data.name === nodeId)
    );
    
    if (targetNode) {
        function expandAll(node) {
            if (node._children) {
                node.children = node._children;
                node._children = null;
            }
            if (node.children) {
                node.children.forEach(expandAll);
            }
        }
        
        expandAll(targetNode);
        update(targetNode);
        
        setTimeout(() => {
            panToNode(targetNode);
        }, 800);
    }
}

function getDashboardColor(lightColor, darkColor) {
    return document.body.classList.contains('dark-theme') ? darkColor : lightColor;
}

// Add touch support for mobile
function handleNodeTouch(event, d) {
    event.preventDefault();
    
    if (isMobile) {
        // Show popup on touch
        showEnhancedTooltip(event.touches[0], d);
        
        // Hide after 5 seconds
        setTimeout(() => {
            if (enhancedTooltip) {
                enhancedTooltip
                    .transition()
                    .duration(200)
                    .style("opacity", 0);
            }
        }, 5000);
    }
}




// ========== ENHANCED 3D VISUALIZATION ==========

// Global 3D variables
let Graph3D = null;
let graphData = null;
let animationId = null;
let currentHighlightedNodes = new Set();

// Enhanced 3D view initialization
function show3DView() {
    if (!treeData) {
        alert('Please load a sitemap first');
        return;
    }
    
    is3DViewActive = true;
    currentView = '3d';
    
    // Update nav buttons
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    const threeDBtn = document.getElementById('3dViewBtn');
    if (threeDBtn) threeDBtn.classList.add('active');
    
    // Hide 2D elements
    cleanupVisualization();
    document.getElementById('treeContainer').style.display = 'none';
    document.getElementById('stats').style.display = 'none';
    document.getElementById('colourLegend').style.display = 'none';
    
    // Show 3D container with proper mobile setup
    const container = document.getElementById('3d-graph-container');
    container.style.display = 'block';
    container.style.height = checkIfMobile() ? '100vh' : '600px';
    container.style.overflow = 'visible'; // Critical fix
    container.innerHTML = '';
    
    const rect = container.getBoundingClientRect();
    graphData = convertToGraphData(treeData);
    
    const isLargeGraph = graphData.nodes.length > 500;
    const isMobileDevice = checkIfMobile();
    
    // Create 3D graph with mobile optimizations
    Graph3D = ForceGraph3D()(container)
        .graphData(graphData)
        .backgroundColor('rgba(0,0,0,0)')
        .showNavInfo(false)
        .width(rect.width)
        .height(rect.height || (isMobileDevice ? window.innerHeight : 600))
        .nodeLabel(node => {
            if (isMobileDevice) {
                // Simpler labels for mobile
                return `<div style="background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                    ${node.name}
                </div>`;
            }
            const style = node.depth <= 2 ? 'font-weight: bold; font-size: 14px;' : '';
            return `<div style="background: rgba(0,0,0,0.8); color: white; padding: 6px 10px; border-radius: 4px; ${style}">
                ${node.name}
                ${node.pageCount ? `<br><small>Pages: ${node.pageCount} | Depth: ${node.depth}</small>` : ''}
            </div>`;
        })
        .nodeAutoColorBy('group')
        .nodeColor(node => getNodeColor3D(node))
        .nodeOpacity(0.9)
        .nodeResolution(isLargeGraph ? (isMobileDevice ? 6 : 8) : (isMobileDevice ? 10 : 16))
        .nodeVal(node => {
            const baseSize = getNodeSize(node);
            if (node.depth === 0) return baseSize * 2;
            if (node.depth === 1) return baseSize * 1.5;
            return baseSize;
        })
        .linkColor(link => getLinkColor3D(link))
        .linkOpacity(isMobileDevice ? 0.2 : 0.3)
        .linkWidth(1)
        .linkDirectionalParticles(isMobileDevice ? 1 : 2)
        .linkDirectionalParticleSpeed(0.005)
        .onNodeClick(handleNodeClick3D)
        .onNodeHover(node => {
            container.style.cursor = node ? 'pointer' : 'default';
        })
        .warmupTicks(isMobileDevice ? 50 : 100)
        .cooldownTicks(isMobileDevice ? 200 : 300);
    
    // Add controls with mobile detection
    add3DControls();
    
    // Set initial camera position
    setTimeout(() => {
        const distance = calculateOptimalDistance();
        Graph3D.cameraPosition(
            { x: distance * 0.5, y: distance * 0.3, z: distance * 0.5 },
            { x: 0, y: 0, z: 0 },
            2000
        );
        
        // Show mobile hint if on mobile
        if (isMobileDevice) {
            showMobileHint();
        }
        
        // Initialize labels after graph is rendered
        setTimeout(() => {
            if (is3DViewActive && Graph3D) {
                addPersistentLabels();
            }
        }, 2500);
    }, 500);
    
    addStats3D();
    optimizeRendering();
}

// Add a control to toggle labels
function toggleLabels3D() {
    const labelsContainer = document.getElementById('labels3d');
    if (labelsContainer) {
        if (labelsContainer.style.display === 'none') {
            labelsContainer.style.display = 'block';
            if (!labels3DUpdateInterval) {
                addPersistentLabels();
            }
        } else {
            labelsContainer.style.display = 'none';
            if (labels3DUpdateInterval) {
                cancelAnimationFrame(labels3DUpdateInterval);
                labels3DUpdateInterval = null;
            }
        }
    } else {
        addPersistentLabels();
    }
}


// Add this function after show3DView
function add3DLabels() {
    const container = document.getElementById('3d-graph-container');
    const labelsDiv = document.createElement('div');
    labelsDiv.id = 'labels3d';
    labelsDiv.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
    `;
    container.appendChild(labelsDiv);
    
    // Update labels on render
    Graph3D.onEngineTick(() => {
        const camera = Graph3D.camera();
        const visibleNodes = graphData.nodes.filter(node => 
            node.depth <= 1 && node.__threeObj
        );
        
        labelsDiv.innerHTML = '';
        
        visibleNodes.forEach(node => {
            const pos = node.__threeObj.position.clone();
            pos.project(camera);
            
            const x = (pos.x + 1) * container.offsetWidth / 2;
            const y = (-pos.y + 1) * container.offsetHeight / 2;
            
            if (pos.z < 1) { // Only show if in front of camera
                const label = document.createElement('div');
                label.className = 'node-label-3d';
                label.style.cssText = `
                    position: absolute;
                    left: ${x}px;
                    top: ${y - 30}px;
                    transform: translate(-50%, -100%);
                    color: ${node.depth === 0 ? '#ff0000' : '#0066cc'};
                    font-weight: bold;
                    font-size: ${node.depth === 0 ? '14px' : '12px'};
                    text-shadow: 0 0 3px white, 0 0 5px white;
                `;
                label.textContent = node.name;
                labelsDiv.appendChild(label);
            }
        });
    });
}






// Add a simpler node label function for better performance
function createSimpleNodeLabel(node) {
    return `<div style="font-size: 12px;">${node.name}</div>`;
}





// Call this after creating Graph3D in show3DView



// Add this global variable
let selectedNode3D = null;

// Update handleNodeClick3D
function handleNodeClick3D(node, event) {
    const isMobile = checkIfMobile();
    
    // Set selected node
    selectedNode3D = node;
    
    // Reset visualization state
    if (Graph3D) {
        Graph3D.nodeVisibility(true);
        Graph3D.linkVisibility(true);
        Graph3D.nodeOpacity(0.9);
        
        Graph3D.nodeColor(n => {
            if (n === selectedNode3D) return '#ff6b6b';
            return getNodeColor3D(n);
        });
    }
    
    if (isMobile) {
        // Close mobile controls if open
        closeMobileControls();
        
        // Show node details
        showNodeDetails3D(node);
        
        // Focus on node
        focusOnNode3D(node, 1000);
        
        // Haptic feedback if available
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }
    } else {
        // Desktop behavior
        if (event && (event.ctrlKey || event.metaKey)) {
            if (node.url) {
                window.open(node.url, '_blank');
            }
        } else {
            focusOnNode3D(node);
            showNodeDetails3D(node);
        }
    }
}

// Update showNodeDetails3D to ensure it works
function showNodeDetails3D(node) {
    if (!is3DViewActive) return;
    
    // Remove existing details
    const existing = document.querySelector('.node-details-3d');
    if (existing) existing.remove();
    
    // Get the container to ensure proper positioning
    const container = document.getElementById('3d-graph-container');
    if (!container) return;
    
    const details = document.createElement('div');
    details.className = 'node-details-3d';
    
    const freshnessInfo = node.lastModified ? 
        getFreshnessInfo(node.lastModified) : null;
    
    details.innerHTML = `
        <button class="minimize-btn" onclick="this.parentElement.remove(); selectedNode3D = null;">×</button>
        
        <h3 style="margin: 0 0 15px 0; color: #1f4788;">${node.name}</h3>
        
        <div style="display: grid; gap: 10px;">
            <div style="display: flex; justify-content: space-between;">
                <span style="color: #666;">Depth Level:</span>
                <span style="font-weight: 600;">${node.depth}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between;">
                <span style="color: #666;">Total Pages:</span>
                <span style="font-weight: 600;">${node.pageCount || 0}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between;">
                <span style="color: #666;">Children:</span>
                <span style="font-weight: 600;">${node.children ? node.children.length : 0}</span>
            </div>
            
            ${freshnessInfo ? `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #666;">Freshness:</span>
                <span style="background: ${freshnessInfo.color}; 
                            color: white; 
                            padding: 2px 8px; 
                            border-radius: 12px; 
                            font-size: 12px;">
                    ${freshnessInfo.label}
                </span>
            </div>
            ` : ''}
            
            ${node.url ? `
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                <a href="${node.url}" 
                   target="_blank" 
                   style="display: block; 
                          text-align: center; 
                          padding: 8px 16px; 
                          background: #007cb6; 
                          color: white; 
                          text-decoration: none; 
                          border-radius: 6px;">
                    🔗 Visit Page
                </a>
            </div>
            ` : ''}
        </div>
    `;
    
    // Append to container, not body
    container.appendChild(details);
}

// Show mobile interaction hint
function showMobileHint() {
    const hint = document.createElement('div');
    hint.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 16px 24px;
        border-radius: 16px;
        font-size: 14px;
        z-index: 10002;
        text-align: center;
        max-width: 80%;
        box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    `;
    hint.innerHTML = `
        <div style="font-size: 16px; margin-bottom: 8px;">📱 Mobile Controls</div>
        <div>👆 Tap nodes to explore</div>
        <div>🤏 Pinch to zoom</div>
        <div>👉 Drag to rotate</div>
        <div>☰ Menu button for more options</div>
    `;
    
    document.body.appendChild(hint);
    
    // Animate in
    hint.style.opacity = '0';
    requestAnimationFrame(() => {
        hint.style.opacity = '1';
    });
    
    // Remove after 6 seconds
    setTimeout(() => {
        hint.style.transition = 'opacity 0.5s';
        hint.style.opacity = '0';
        setTimeout(() => hint.remove(), 500);
    }, 6000);
    
    // Allow tap to dismiss
    hint.addEventListener('touchend', function(e) {
        e.preventDefault();
        this.style.opacity = '0';
        setTimeout(() => this.remove(), 300);
    });
}



// Fix 8: Prevent default touch behaviors on 3D container
function setup3DTouchHandling() {
    const container = document.getElementById('3d-graph-container');
    if (!container) return;
    
    // Prevent default touch behaviors that might interfere
    container.addEventListener('touchstart', function(e) {
        // Allow normal graph interaction
    }, { passive: true });
    
    container.addEventListener('touchmove', function(e) {
        // Prevent scroll only if we're doing graph interaction
        if (e.touches.length > 1) {
            e.preventDefault(); // Prevent zoom on multi-touch
        }
    }, { passive: false });
    
    container.addEventListener('touchend', function(e) {
        // Allow normal behavior
    }, { passive: true });
}


// Convert tree to graph data with enhanced properties
function convertToGraphData(treeNode) {
    const nodes = [];
    const links = [];
    const nodeMap = new Map();
    let nodeId = 0;
    
    function processNode(node, parentId = null, depth = 0, path = []) {
        const id = nodeId++;
        const fullPath = [...path, node.name];
        
        const nodeData = {
            id: id,
            name: node.name,
            fullName: fullPath.join(' > '),
            url: node.url,
            depth: depth,
            group: depth,
            pageCount: node.pageCount || 1,
            lastModified: node.lastModified,
            val: Math.max(5, Math.sqrt(node.pageCount || 1) * 10),
            color: getNodeColor3D({ depth }),
            path: fullPath,
            children: [],
            isLeaf: !node.children || node.children.length === 0
        };
        
        nodes.push(nodeData);
        nodeMap.set(id, nodeData);
        
        if (parentId !== null) {
            links.push({
                source: parentId,
                target: id,
                value: node.pageCount || 1
            });
            
            const parent = nodeMap.get(parentId);
            if (parent) parent.children.push(id);
        }
        
        if (node.children) {
            node.children.forEach(child => {
                processNode(child, id, depth + 1, fullPath);
            });
        }
    }
    
    processNode(treeNode);
    
    return { nodes, links };
}

// Enhanced node coloring
function getNodeColor3D(node) {
    if (node.highlighted) return '#ff6b6b';
    if (node.selected) return '#4ecdc4';
    if (freshnessViewEnabled && node.lastModified) {
        return getFreshnessColor(node.lastModified);
    }
    
    // Use depth-based colors matching 2D view
    const colors = ['#1f4788', '#2d5aa0', '#4a90e2', '#7fb069', '#52734d'];
    return colors[node.depth] || '#52734d';
}

// Get node size based on importance
function getNodeSize(node) {
    const baseSize = 5;
    const depthFactor = Math.max(1, 5 - node.depth);
    const pageFactor = Math.log(node.pageCount || 1) + 1;
    return baseSize * depthFactor * pageFactor;
}

// Enhanced link coloring
function getLinkColor3D(link) {
    const sourceNode = typeof link.source === 'object' ? link.source : 
                      graphData.nodes.find(n => n.id === link.source);
    return sourceNode ? sourceNode.color : '#999999';
}

// Create rich node labels
function createNodeLabel(node) {
    const lastModStr = node.lastModified ? 
        `Last Modified: ${formatDate(new Date(node.lastModified))}` : '';
    
    return `
        <div style="background: rgba(31, 41, 55, 0.95); 
                    color: white; 
                    padding: 8px 12px; 
                    border-radius: 6px;
                    font-size: 12px;
                    max-width: 200px;">
            <div style="font-weight: bold; margin-bottom: 4px;">${node.name}</div>
            <div style="color: #9ca3af; font-size: 11px;">
                Depth: ${node.depth} | Pages: ${node.pageCount || 0}
                ${lastModStr ? `<br/>${lastModStr}` : ''}
            </div>
        </div>
    `;
}

// Handle node interactions
function handleNodeClick3D(node, event) {
    if (isMobile3D) {
        // On mobile, show details directly
        showNodeDetails3D(node);
        focusOnNode3D(node, 1000);
    } else {
        // Desktop behavior
        if (event.ctrlKey || event.metaKey) {
            if (node.url) {
                window.open(node.url, '_blank');
            }
        } else {
            focusOnNode3D(node);
            showNodeDetails3D(node);
        }
    }
}

function handleNodeRightClick3D(node, event) {
    event.preventDefault();
    showNodeContextMenu3D(node, event);
}

function handleNodeHover3D(node) {
    document.getElementById('3d-graph-container').style.cursor = node ? 'pointer' : 'default';
    
    if (node) {
        highlightConnectionsSubtle3D(node);
    } else {
        clearHighlights3D();
    }
}

// Add this new subtle highlight function
function highlightConnectionsSubtle3D(node) {
    if (!Graph3D) return;
    
    // Get connected nodes
    const connectedNodes = new Set([node.id]);
    
    // Find children
    if (node.children) {
        node.children.forEach(childId => connectedNodes.add(childId));
    }
    
    // Find parent
    const parent = graphData.links.find(link => {
        const targetId = typeof link.target === 'object' ? link.target.id : link.target;
        return targetId === node.id;
    });
    if (parent) {
        const sourceId = typeof parent.source === 'object' ? parent.source.id : parent.source;
        connectedNodes.add(sourceId);
    }
    
    // SUBTLE opacity changes - all nodes remain clearly visible
    Graph3D.nodeOpacity(n => connectedNodes.has(n.id) ? 1 : 0.85); // Very subtle fade
    
    // Optional: Change color instead of opacity
    Graph3D.nodeColor(n => {
        if (n === node) return '#ff6b6b'; // Highlight hovered node
        if (connectedNodes.has(n.id)) return '#4ecdc4'; // Highlight connected
        return getNodeColor3D(n);
    });
}

function handleLinkHover3D(link) {
    // Optional: highlight link on hover
}

// Add comprehensive 3D controls
function add3DControls() {
    const container = document.getElementById('3d-graph-container');
    
    // Check if mobile
    isMobile3D = checkIfMobile();
    
    // Main control panel
    const controlPanel = document.createElement('div');
    controlPanel.className = 'controls-3d';
    controlPanel.innerHTML = `
        <style>
            /* Desktop styles (RESTORED) */
            .controls-3d {
    position: absolute !important; /* Must be absolute, not fixed */
    top: 170px !important;
    left: 10px !important;
    background: rgba(255, 255, 255, 0.95) !important;
    border-radius: 8px !important;
    padding: 12px !important;
    box-shadow: 0 2px 10px rgba(0,0,0,0.15) !important;
    max-width: 250px !important;
    max-height: calc(100% - 20px) !important; /* Constrain to container height */
    overflow-y: auto !important;
    overflow-x: hidden !important;
    z-index: 50 !important;
    font-size: 12px !important;
}
            
            body.dark-theme .controls-3d {
                background: rgba(31, 41, 55, 0.95);
                color: #e5e7eb;
            }
            
            .control-section {
    margin-bottom: 10px !important; /* Reduced from 15px */
    padding-bottom: 10px !important; /* Reduced from 15px */
    border-bottom: 1px solid #e0e0e0;
}
            
            body.dark-theme .control-section {
                border-bottom-color: #4b5563;
            }
            
            .control-section:last-child {
                border-bottom: none;
                margin-bottom: 0;
                padding-bottom: 0;
            }
            
           .control-title {
    font-weight: 600;
    margin-bottom: 6px !important; /* Reduced from 10px */
    color: #1f4788;
    font-size: 12px !important; /* Reduced from 14px */
}
            
            body.dark-theme .control-title {
                color: #72A300;
            }
            
            .control-btn {
    width: 100%;
    padding: 6px 10px !important; /* Reduced from 8px 12px */
    margin-bottom: 4px !important; /* Reduced from 6px */
    background: #f0f0f0;
    border: none;
    border-radius: 4px !important; /* Reduced from 6px */
    cursor: pointer;
    font-size: 11px !important; /* Reduced from 13px */
    transition: all 0.2s;
}
            
            body.dark-theme .control-btn {
                background: #374151;
                color: #e5e7eb;
            }
            
            .control-btn:hover {
                background: #007cb6;
                color: white;
                transform: translateY(-1px);
            }
            
            body.dark-theme .control-btn:hover {
                background: #72A300;
            }
            
            .control-btn.active {
                background: #007cb6;
                color: white;
            }
            
            body.dark-theme .control-btn.active {
                background: #72A300;
            }
            
            .control-input {
                width: 100%;
                padding: 6px 10px;
                border: 1px solid #e0e0e0;
                border-radius: 6px;
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            
            body[data-view="3d"] #3d-graph-container {
    display: block !important;
}

body[data-view="3d"] #treeContainer {
    display: none !important;
}

/* Make sure the visualization wrapper doesn't interfere */
.visualization-wrapper {
    width: 100% !important;
    max-width: 100% !important;
}
            
            
            /* Ensure controls can scroll if needed */
.controls-3d::-webkit-scrollbar {
    width: 6px;
}

.controls-3d::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.controls-3d::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

.controls-3d::-webkit-scrollbar-thumb:hover {
    background: #555;
}
            
            body.dark-theme .control-input {
                background: #374151;
                border-color: #4b5563;
                color: #e5e7eb;
            }
            
            .control-slider {
                width: 100%;
                margin: 10px 0;
            }
            
            .control-label {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 6px;
                font-size: 13px;
            }
            
           .minimize-btn {
    position: absolute;
    top: 5px !important;
    right: 5px !important;
    background: none;
    border: none;
    font-size: 16px !important; /* Reduced from 20px */
    cursor: pointer;
    color: #666;
    padding: 0;
    width: 20px;
    height: 20px;
}

/* Ensure stats stay within container too */
body:not(.mobile) #3d-graph-container > div[style*="bottom"] {
    position: absolute !important; /* Not fixed on desktop */
}
            
            body.dark-theme .minimize-btn {
                color: #9ca3af;
            }
            
            .node-details-3d {
        position: fixed !important;
        bottom: 20px !important; /* Above the controls handle */
        left: 200px !important;
        right: 20px !important;
        width: auto !important;
        max-width: none !important;
        
        border-radius: 16px !important;
        padding: 16px !important;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3) !important;
        z-index: 10001 !important; /* Higher than mobile controls (9999) */
        max-height: 300px !important;
        overflow-y: auto !important;
        border: 2px solid #007cb6 !important;
        backdrop-filter: blur(10px) !important;
    }
	
	/* When mobile controls are expanded, move node details higher */
    body.controls-open .node-details-3d {
        bottom: 60vh !important; /* Move way up when controls are open */
        max-height: 30vh !important;
    }
	
	.mobile-toast {
        z-index: 10002 !important; /* Above everything */
        backdrop-filter: blur(10px) !important;
    }
            
            body.dark-theme .node-details-3d {
                background: rgba(31, 41, 55, 0.95);
                color: #e5e7eb;
            }
            
           /* Mobile 3D Controls - Complete Redesign */
@media (max-width: 768px) {
    .controls-3d {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        background: rgba(255, 255, 255, 0.95) !important;
        border-radius: 20px 20px 0 0 !important;
        padding: 0 !important;
       
        transform: translateY(calc(100% - 150px)) !important;
        transition: transform 0.3s ease !important;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.2) !important;
        overflow: hidden !important;
        z-index: 9999 !important;
    }
    
    .controls-3d.expanded {
        transform: translateY(0) !important;
    }
    
    .mobile-handle {
    display: block !important;
    width: 60px !important; /* CHANGE: increase from 40px */
    height: 6px !important; /* CHANGE: increase from 4px */
    background: #007cb6 !important; /* CHANGE: more visible color */
    border-radius: 3px !important;
    margin: 15px auto 15px !important;
    cursor: pointer !important;
}
    
    .mobile-control-header {
        padding: 0 20px 15px !important;
        border-bottom: 1px solid #eee !important;
        text-align: center !important;
    }
    
    .mobile-control-content {
        padding: 15px 20px !important;
        max-height: calc(70vh - 60px) !important;
        overflow-y: auto !important;
    }
    
    .control-section {
        margin-bottom: 16px !important;
        padding-bottom: 8px !important;
        border-bottom: 1px solid #f0f0f0 !important;
    }
    
    .control-section:last-child {
        border-bottom: none !important;
        margin-bottom: 0 !important;
    }
    
    .control-title {
        font-size: 16px !important;
        font-weight: 600 !important;
        margin-bottom: 8px !important;
        color: #1f4788 !important;
        text-align: center !important;
    }
    
    .mobile-control-grid {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 6px !important;
        margin-bottom: 10px !important;
    }
    
    .mobile-control-grid.three-col {
        grid-template-columns: repeat(3, 1fr) !important;
    }
    
    .control-btn {
        padding: 12px 8px !important;
        font-size: 13px !important;
        text-align: center !important;
        border-radius: 8px !important;
        margin-bottom: 0 !important;
        min-height: 35px !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 1px !important;
    }
    
    .control-btn-icon {
        font-size: 18px !important;
        line-height: 1 !important;
    }
    
    .control-btn-text {
        font-size: 11px !important;
        line-height: 1.2 !important;
    }
    
    .mobile-search-container {
        margin-bottom: 15px !important;
    }
    
    .control-input {
        padding: 12px 15px !important;
        font-size: 16px !important; /* Prevents zoom on iOS */
        border-radius: 8px !important;
        border: 2px solid #e0e0e0 !important;
        margin-bottom: 0 !important;
    }
    
    .mobile-fab {
        position: fixed !important;
        width: 56px !important;
        height: 56px !important;
        border-radius: 50% !important;
        background: #007cb6 !important;
        color: white !important;
        border: none !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 24px !important;
        z-index: 10000 !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
    }
    
    .mobile-fab:active {
        transform: scale(0.95) !important;
    }
    
    #mobileBackFab {
    bottom: max(220px, calc(env(safe-area-inset-bottom, 0px) + 220px)) !important;
    right: 20px !important;
    background: #666 !important;
    font-size: 20px !important;
}
   
    #mobileCameraFab {
    bottom: max(160px, calc(env(safe-area-inset-bottom, 0px) + 160px)) !important; /* CHANGE: safe area */
    right: 20px !important;
}
    
    #mobileMenuFab {
    bottom: max(100px, calc(env(safe-area-inset-bottom, 0px) + 100px)) !important; /* CHANGE: safe area */
    right: 20px !important;
    background: #4a90e2 !important;
}
    
    /* Dark theme mobile */
    body.dark-theme .controls-3d {
        background: rgba(31, 41, 55, 0.95) !important;
        color: #e5e7eb !important;
    }
    
    body.dark-theme .mobile-handle {
        background: #4b5563 !important;
    }
    
    body.dark-theme .mobile-control-header {
        border-bottom-color: #4b5563 !important;
    }
    
    body.dark-theme .control-section {
        border-bottom-color: #374151 !important;
    }
    
    body.dark-theme .control-title {
        color: #72A300 !important;
    }
    
    body.dark-theme .control-btn {
        background: #374151 !important;
        color: #e5e7eb !important;
        border-color: #4b5563 !important;
    }
    
    body.dark-theme .control-btn:hover {
        background: #72A300 !important;
    }
    
    body.dark-theme .control-input {
        background: #374151 !important;
        border-color: #4b5563 !important;
        color: #e5e7eb !important;
    }
    
    body.dark-theme .mobile-fab {
        background: #72A300 !important;
    }
    
    body.dark-theme #mobileBackFab {
        background: #4b5563 !important;
    }
}
        </style>
        
        ${isMobile3D ? '<div class="mobile-handle" onclick="toggleMobileControls()"></div>' : ''}
        ${!isMobile3D ? '<button class="minimize-btn" onclick="toggleControlPanel3D()">−</button>' : ''}
        
        <!-- Rest of the control panel HTML remains the same -->
        <div class="control-section">
            <div class="control-title">🎥 Camera Views</div>
            ${isMobile3D ? '<div class="control-grid">' : ''}
                <button class="control-btn" onclick="topView3D()">Top View</button>
                <button class="control-btn" onclick="frontView3D()">Front View</button>
                <button class="control-btn" onclick="sideView3D()">Side View</button>
                <button class="control-btn" onclick="isometricView3D()">Isometric View</button>
            ${isMobile3D ? '</div>' : ''}
        </div>
        
        <div class="control-section">
            <div class="control-title">🎬 Animation</div>
            <button class="control-btn" onclick="toggleAutoRotate3D()" id="autoRotateBtn">
                Auto Rotate: OFF
            </button>
            
            <button class="control-btn" onclick="flyThroughAnimation3D()">
    Fly Through Tour
</button>


        </div>
        
        <div class="control-section">
            <div class="control-title">🔍 Search & Filter</div>
            <input type="text" 
                   class="control-input" 
                   id="search3d" 
                   placeholder="Search nodes..."
                   onkeyup="search3D(this.value)">
            ${!isMobile3D ? `
            <button class="control-btn" onclick="showOnlyLeaves3D()">
                Show Only Pages
            </button>
            <button class="control-btn" onclick="showOnlyCategories3D()">
                Show Only Categories
            </button>
            ` : ''}
            <button class="control-btn" onclick="resetFilters3D()">
                Reset Filters
            </button>
        </div>
        
        ${!isMobile3D ? `
        <div class="control-section">
            <div class="control-title">🎨 Display Options</div>
            <label class="control-label">
                <input type="checkbox" 
                       checked 
                       onchange="toggleNodeLabels3D(this.checked)">
                Show Labels
            </label>
            <label class="control-label">
                <input type="checkbox" 
                       checked 
                       onchange="toggleLinks3D(this.checked)">
                Show Links
            </label>
            <label class="control-label">
                <input type="checkbox" 
                       onchange="toggleParticles3D(this.checked)">
                Show Particles
            </label>
            <label class="control-label">
    <input type="checkbox" 
           checked 
           onchange="toggleLabels3D()">
    Show Persistent Labels
</label>
            <label class="control-label">
                Node Size:
                <input type="range" 
                       class="control-slider"
                       min="0.5" 
                       max="2" 
                       step="0.1" 
                       value="1"
                       onchange="updateNodeSize3D(this.value)">
            </label>
        </div>
        ` : ''}
        
       
<!-- Layout -->
${isMobile3D ? `
<div class="control-section">
    <div class="control-title">📊 Layout Options</div>
    <div class="mobile-control-grid three-col">
        <button class="control-btn" onclick="switchLayout3D('tree'); closeMobileControls(); highlightLayoutButton(this);">
            <div class="control-btn-icon">🌳</div>
            <div class="control-btn-text">Tree</div>
        </button>
        <button class="control-btn" onclick="switchLayout3D('radial'); closeMobileControls(); highlightLayoutButton(this);">
            <div class="control-btn-icon">⭕</div>
            <div class="control-btn-text">Radial</div>
        </button>
        <button class="control-btn" onclick="switchLayout3D('force'); closeMobileControls(); highlightLayoutButton(this);">
            <div class="control-btn-icon">⚡</div>
            <div class="control-btn-text">Force</div>
        </button>
    </div>
    <div style="text-align: center; font-size: 11px; color: #666; margin-top: 8px;">
        Tap to change 3D arrangement
    </div>
</div>
` : `
<div class="control-section">
    <div class="control-title">📊 Layout Options</div>
    <button class="control-btn" onclick="switchLayout3D('tree')">Tree Layout</button>
    <button class="control-btn" onclick="switchLayout3D('radial')">Radial Layout</button>
    <button class="control-btn" onclick="switchLayout3D('force')">Force Layout</button>
</div>
`}
        
        ${!isMobile3D ? `
        <button class="control-btn" 
                style="background: #666; color: white; margin-top: 10px;"
                onclick="backTo2D()">
            ← Back to 2D View
        </button>
        ` : ''}
    `;
    
    container.appendChild(controlPanel);
    
    // Add mobile FABs
    if (isMobile3D) {
        addMobileFABs();
    }
    
    // Add minimap (desktop only)
    if (!isMobile3D) {
        addMinimap3D();
    }
    
    // Add stats display
    addStats3D();
}

// Add mobile floating action buttons
// Updated mobile FABs
function addMobileFABs() {
    const container = document.getElementById('3d-graph-container');
    if (!container) return;
    
    // Remove existing FABs to prevent duplicates
    container.querySelectorAll('.mobile-fab').forEach(fab => fab.remove());
    
    // Back button with better touch handling
    const backFab = document.createElement('button');
    backFab.id = 'mobileBackFab';
    backFab.className = 'mobile-fab';
    backFab.innerHTML = '←';
    backFab.setAttribute('aria-label', 'Back to 2D view');
    backFab.style.touchAction = 'manipulation';
    
    backFab.addEventListener('touchstart', function(e) {
        e.preventDefault();
        this.style.transform = 'scale(0.9)';
    });
    
    backFab.addEventListener('touchend', function(e) {
        e.preventDefault();
        this.style.transform = 'scale(1)';
        backTo2D();
    });
    
    backFab.onclick = backTo2D;
    container.appendChild(backFab);
    
    // Camera button with cycle functionality
    const cameraFab = document.createElement('button');
    cameraFab.id = 'mobileCameraFab';
    cameraFab.className = 'mobile-fab';
    cameraFab.innerHTML = '📷';
    cameraFab.setAttribute('aria-label', 'Change camera view');
    cameraFab.style.touchAction = 'manipulation';
    
    let cameraViewIndex = 0;
    const cameraViews = [
        { func: topView3D, name: 'Top View' },
        { func: frontView3D, name: 'Front View' },
        { func: sideView3D, name: 'Side View' },
        { func: isometricView3D, name: 'Isometric View' }
    ];
    
    cameraFab.addEventListener('touchstart', function(e) {
        e.preventDefault();
        this.style.transform = 'scale(0.9)';
    });
    
    cameraFab.addEventListener('touchend', function(e) {
        e.preventDefault();
        this.style.transform = 'scale(1)';
        
        // Cycle through camera views
        cameraViews[cameraViewIndex].func();
        
        // Show toast notification
        showMobileToast(cameraViews[cameraViewIndex].name);
        
        cameraViewIndex = (cameraViewIndex + 1) % cameraViews.length;
        
        // Haptic feedback
        if (navigator.vibrate) {
            navigator.vibrate(30);
        }
    });
    
    container.appendChild(cameraFab);
    
    // Menu button
    const menuFab = document.createElement('button');
    menuFab.id = 'mobileMenuFab';
    menuFab.className = 'mobile-fab';
    menuFab.innerHTML = '☰';
    menuFab.setAttribute('aria-label', 'Open controls menu');
    menuFab.style.touchAction = 'manipulation';
    
    menuFab.addEventListener('touchstart', function(e) {
        e.preventDefault();
        this.style.transform = 'scale(0.9)';
    });
    
    menuFab.addEventListener('touchend', function(e) {
        e.preventDefault();
        this.style.transform = 'scale(1)';
        toggleMobileControls();
    });
    
    container.appendChild(menuFab);
}



function showMobileToast(message, duration = 2000) {
    // Remove existing toasts
    document.querySelectorAll('.mobile-toast').forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = 'mobile-toast';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 14px;
        z-index: 10001;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    // Animate in
    requestAnimationFrame(() => {
        toast.style.opacity = '1';
    });
    
    // Remove after duration
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}






// Mobile camera menu
function showMobileCameraMenu() {
    const menu = document.createElement('div');
    menu.style.cssText = `
        position: fixed;
        bottom: 200px;
        right: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        padding: 10px;
        z-index: 1001;
    `;
    
    menu.innerHTML = `
        <button class="control-btn" style="margin: 5px; width: 100px;" onclick="topView3D(); this.parentElement.remove();">Top</button><br>
        <button class="control-btn" style="margin: 5px; width: 100px;" onclick="frontView3D(); this.parentElement.remove();">Front</button><br>
        <button class="control-btn" style="margin: 5px; width: 100px;" onclick="sideView3D(); this.parentElement.remove();">Side</button><br>
        <button class="control-btn" style="margin: 5px; width: 100px;" onclick="isometricView3D(); this.parentElement.remove();">3D View</button>
    `;
    
    document.getElementById('3d-graph-container').appendChild(menu);
    
    // Remove on outside click
    setTimeout(() => {
        document.addEventListener('click', () => menu.remove(), { once: true });
    }, 10);
}

// Toggle mobile controls
window.toggleMobileControls = function() {
    const panel = document.querySelector('.controls-3d');
    const isExpanded = panel.classList.contains('expanded');
    
    if (isExpanded) {
        // Close controls
        panel.classList.remove('expanded');
        document.body.classList.remove('controls-open');
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.style.width = '';
    } else {
        // Open controls
        panel.classList.add('expanded');
        document.body.classList.add('controls-open');
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
    }
}


window.closeMobileControls = function() {
    const panel = document.querySelector('.controls-3d');
    if (panel && panel.classList.contains('expanded')) {
        panel.classList.remove('expanded');
        document.body.classList.remove('controls-open');
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.style.width = '';
    }
}



// Camera view functions
function topView3D() {
    const distance = calculateOptimalDistance();
    Graph3D.cameraPosition(
        { x: 0, y: distance, z: 0 },
        { x: 0, y: 0, z: 0 },
        1500
    );
}

function frontView3D() {
    const distance = calculateOptimalDistance();
    Graph3D.cameraPosition(
        { x: 0, y: 0, z: distance },
        { x: 0, y: 0, z: 0 },
        1500
    );
}

function sideView3D() {
    const distance = calculateOptimalDistance();
    Graph3D.cameraPosition(
        { x: distance, y: 0, z: 0 },
        { x: 0, y: 0, z: 0 },
        1500
    );
}

function isometricView3D() {
    const distance = calculateOptimalDistance();
    const angle = Math.PI / 4;
    Graph3D.cameraPosition(
        { 
            x: distance * Math.sin(angle) * Math.cos(angle),
            y: distance * Math.sin(angle),
            z: distance * Math.cos(angle) * Math.cos(angle)
        },
        { x: 0, y: 0, z: 0 },
        1500
    );
}

function calculateOptimalDistance() {
    const nodeCount = graphData.nodes.length;
    return Math.max(200, Math.min(1000, nodeCount * 3));
}

// Animation functions
let autoRotateInterval = null;

function toggleAutoRotate3D() {
    const btn = document.getElementById('autoRotateBtn');
    
    if (autoRotateInterval) {
        clearInterval(autoRotateInterval);
        autoRotateInterval = null;
        btn.textContent = 'Auto Rotate: OFF';
        btn.classList.remove('active');
    } else {
        let angle = 0;
        const distance = calculateOptimalDistance();
        
        autoRotateInterval = setInterval(() => {
            angle += 0.005;
            Graph3D.cameraPosition({
                x: distance * Math.sin(angle),
                y: distance * 0.5,
                z: distance * Math.cos(angle)
            });
        }, 20);
        
        btn.textContent = 'Auto Rotate: ON';
        btn.classList.add('active');
    }
}

function flyThroughAnimation3D() {
    // Stop any existing animations
    if (autoRotateInterval) toggleAutoRotate3D();
    if (flyThroughTimeout) {
        clearTimeout(flyThroughTimeout);
        flyThroughTimeout = null;
    }
    
    const importantNodes = graphData.nodes
        .filter(n => n.depth <= 2 || n.isLeaf)
        .sort((a, b) => b.pageCount - a.pageCount)
        .slice(0, 10);
    
    let currentIndex = 0;
    
    function flyToNext() {
        // Check if 3D view is still active
        if (!is3DViewActive || !Graph3D) {
            flyThroughTimeout = null;
            return;
        }
        
        if (currentIndex >= importantNodes.length) {
            currentIndex = 0;
        }
        
        const node = importantNodes[currentIndex];
        focusOnNode3D(node, 2000);
        showNodeDetails3D(node);
        
        currentIndex++;
        flyThroughTimeout = setTimeout(flyToNext, 3000);
    }
    
    flyToNext();
}

// Search and filter functions
function search3D(query) {
    if (!query) {
        resetFilters3D();
        return;
    }
    
    query = query.toLowerCase();
    
    // Find matching nodes
    const matches = graphData.nodes.filter(node =>
        node.name.toLowerCase().includes(query) ||
        (node.fullName && node.fullName.toLowerCase().includes(query))
    );
    
    // Update node appearance WITHOUT hiding non-matches
    Graph3D.nodeColor(node => {
        if (matches.includes(node)) {
            node.highlighted = true;
            return '#ff6b6b';
        }
        node.highlighted = false;
        return getNodeColor3D(node);
    });
    
    // Make non-matches slightly transparent but still visible
    Graph3D.nodeOpacity(node => matches.includes(node) ? 1 : 0.5); // Changed from 0.2
    
    // Ensure all nodes remain visible
    Graph3D.nodeVisibility(true);
    
    // Focus on first match
    if (matches.length > 0) {
        focusOnNode3D(matches[0]);
        
        // Update search info
        const searchInfo = document.getElementById('search3dInfo');
        if (searchInfo) {
            searchInfo.textContent = `Found ${matches.length} matches`;
        }
    }
}

function showOnlyLeaves3D() {
    Graph3D.nodeVisibility(node => node.isLeaf);
    Graph3D.linkVisibility(link => {
        const target = typeof link.target === 'object' ? link.target : 
                      graphData.nodes.find(n => n.id === link.target);
        return target && target.isLeaf;
    });
}

function showOnlyCategories3D() {
    Graph3D.nodeVisibility(node => !node.isLeaf);
    Graph3D.linkVisibility(link => {
        const source = typeof link.source === 'object' ? link.source : 
                      graphData.nodes.find(n => n.id === link.source);
        const target = typeof link.target === 'object' ? link.target : 
                      graphData.nodes.find(n => n.id === link.target);
        return source && target && !source.isLeaf && !target.isLeaf;
    });
}

function resetFilters3D() {
    // Reset all nodes
    graphData.nodes.forEach(node => {
        node.highlighted = false;
        node.selected = false;
    });
    
    Graph3D.nodeVisibility(true);
    Graph3D.linkVisibility(true);
    Graph3D.nodeColor(node => getNodeColor3D(node));
    Graph3D.nodeOpacity(0.9);
    
    // Clear search
    const searchInput = document.getElementById('search3d');
    if (searchInput) searchInput.value = '';
}

// Display options
function toggleNodeLabels3D(show) {
    Graph3D.nodeLabel(show ? node => createNodeLabel(node) : null);
}

function toggleLinks3D(show) {
    Graph3D.linkVisibility(show);
}

function toggleParticles3D(show) {
    Graph3D.linkDirectionalParticles(show ? 2 : 0);
}

function updateNodeSize3D(scale) {
    Graph3D.nodeVal(node => getNodeSize(node) * parseFloat(scale));
}

// Layout switching
// Layout switching
// Update the switchLayout3D function to work better on mobile
function switchLayout3D(layoutType) {
    if (!Graph3D) return;
    
    console.log('Switching to layout:', layoutType);
    
    switch(layoutType) {
        case 'tree':
            Graph3D.dagMode('td')
                   .dagLevelDistance(isMobile3D ? 40 : 60)
                   .d3Force('charge', null)
                   .d3Force('center', null);
            
            // Add Z-axis variation for tree layout
            setTimeout(() => {
                graphData.nodes.forEach(node => {
                    node.z = (Math.random() - 0.5) * (isMobile3D ? 30 : 50) * (node.depth + 1);
                });
                Graph3D.refresh();
            }, 100);
            break;
            
        case 'radial':
            Graph3D.dagMode('radialout')
                   .dagLevelDistance(isMobile3D ? 30 : 50)
                   .d3Force('charge', null)
                   .d3Force('center', null);
            
            // Radial in 3D - spread nodes in a sphere
            setTimeout(() => {
                graphData.nodes.forEach(node => {
                    const angle1 = Math.random() * Math.PI * 2;
                    const angle2 = Math.random() * Math.PI;
                    const radius = node.depth * (isMobile3D ? 30 : 50) + Math.random() * 20;
                    node.fx = radius * Math.sin(angle2) * Math.cos(angle1);
                    node.fy = radius * Math.sin(angle2) * Math.sin(angle1);
                    node.fz = radius * Math.cos(angle2);
                });
                Graph3D.refresh();
                
                // Release fixed positions after a moment
                setTimeout(() => {
                    graphData.nodes.forEach(node => {
                        node.fx = undefined;
                        node.fy = undefined;
                        node.fz = undefined;
                    });
                }, 2000);
            }, 100);
            break;
            
        case 'force':
            Graph3D.dagMode(null)
                   .d3Force('charge', d3.forceManyBody().strength(isMobile3D ? -200 : -300))
                   .d3Force('center', d3.forceCenter())
                   .d3Force('link', d3.forceLink().distance(isMobile3D ? 60 : 100).strength(0.5))
                   .d3Force('collision', d3.forceCollide(node => getNodeSize(node) + 10));
            break;
    }
    
    Graph3D.refresh();
    
    // Mobile feedback
    if (isMobile3D) {
        // Show a toast notification
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 10000;
            pointer-events: none;
        `;
        toast.textContent = `Layout changed to ${layoutType.charAt(0).toUpperCase() + layoutType.slice(1)}`;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.transition = 'opacity 0.3s';
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 1500);
    }
}

function showNodeDetails3D(node) {
    if (!is3DViewActive) return;
    
    // Remove existing details
    const existing = document.querySelector('.node-details-3d');
    if (existing) existing.remove();
    
    // Get the container to ensure proper positioning
    const container = document.getElementById('3d-graph-container');
    if (!container) return;
    
    const details = document.createElement('div');
    details.className = 'node-details-3d';
    
    const freshnessInfo = node.lastModified ? 
        getFreshnessInfo(node.lastModified) : null;
    
    // Check if mobile
    const isMobile = checkIfMobile();
    
    if (isMobile) {
        // Compact mobile version
        details.innerHTML = `
            <button class="minimize-btn" onclick="this.parentElement.remove(); selectedNode3D = null;" 
                    style="position: absolute; top: 8px; right: 8px; background: none; border: none; 
                           font-size: 24px; color: #999; cursor: pointer; padding: 0; 
                           width: 24px; height: 24px; line-height: 1;">×</button>
            
            <h3 style="margin: 0 0 8px 0; color: #1f4788; font-size: 16px; padding-right: 30px;">${node.name}</h3>
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 8px;">
                <div style="font-size: 12px;">
                    <span style="color: #666;">Level:</span> 
                    <strong>${node.depth}</strong>
                </div>
                <div style="font-size: 12px;">
                    <span style="color: #666;">Pages:</span> 
                    <strong>${node.pageCount || 0}</strong>
                </div>
                ${freshnessInfo ? `
                <div style="font-size: 12px;">
                    <span style="background: ${freshnessInfo.color}; 
                                color: white; 
                                padding: 2px 6px; 
                                border-radius: 10px; 
                                font-size: 11px;">
                        ${freshnessInfo.label}
                    </span>
                </div>
                ` : ''}
            </div>
            
            ${node.url ? `
            <a href="${node.url}" 
               target="_blank" 
               style="display: inline-block; 
                      padding: 6px 12px; 
                      background: #007cb6; 
                      color: white; 
                      text-decoration: none; 
                      border-radius: 6px;
                      font-size: 12px;">
                Visit →
            </a>
            ` : ''}
        `;
    } else {
        // Full desktop version (existing code)
        details.innerHTML = `
            <button class="minimize-btn" onclick="this.parentElement.remove(); selectedNode3D = null;">×</button>
            
            <h3 style="margin: 0 0 15px 0; color: #1f4788;">${node.name}</h3>
            
            <div style="display: grid; gap: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: #666;">Depth Level:</span>
                    <span style="font-weight: 600;">${node.depth}</span>
                </div>
                
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: #666;">Total Pages:</span>
                    <span style="font-weight: 600;">${node.pageCount || 0}</span>
                </div>
                
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: #666;">Children:</span>
                    <span style="font-weight: 600;">${node.children ? node.children.length : 0}</span>
                </div>
                
                ${freshnessInfo ? `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #666;">Freshness:</span>
                    <span style="background: ${freshnessInfo.color}; 
                                color: white; 
                                padding: 2px 8px; 
                                border-radius: 12px; 
                                font-size: 12px;">
                        ${freshnessInfo.label}
                    </span>
                </div>
                ` : ''}
                
                ${node.url ? `
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                    <a href="${node.url}" 
                       target="_blank" 
                       style="display: block; 
                              text-align: center; 
                              padding: 8px 16px; 
                              background: #007cb6; 
                              color: white; 
                              text-decoration: none; 
                              border-radius: 6px;">
                        🔗 Visit Page
                    </a>
                </div>
                ` : ''}
            </div>
        `;
    }
    
    // Append to container
    container.appendChild(details);
    
    // Auto-dismiss on mobile after tap outside
    if (isMobile) {
        setTimeout(() => {
            const dismissHandler = (e) => {
                if (!details.contains(e.target)) {
                    details.remove();
                    selectedNode3D = null;
                    document.removeEventListener('click', dismissHandler);
                }
            };
            document.addEventListener('click', dismissHandler);
        }, 100);
    }
}

function highlightConnections3D(node) {
    if (!Graph3D) return;
    
    // Get connected nodes
    const connectedNodes = new Set([node.id]);
    
    // Find children
    if (node.children) {
        node.children.forEach(childId => connectedNodes.add(childId));
    }
    
    // Find parent
    const parent = graphData.links.find(link => {
        const targetId = typeof link.target === 'object' ? link.target.id : link.target;
        return targetId === node.id;
    });
    if (parent) {
        const sourceId = typeof parent.source === 'object' ? parent.source.id : parent.source;
        connectedNodes.add(sourceId);
    }
    
    // Update visualization - use less extreme opacity differences
    Graph3D.nodeOpacity(n => connectedNodes.has(n.id) ? 1 : 0.7); // Changed from 0.5
    Graph3D.linkOpacity(link => {
        const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
        const targetId = typeof link.target === 'object' ? link.target.id : link.target;
        return connectedNodes.has(sourceId) && connectedNodes.has(targetId) ? 0.8 : 0.2;
    });
}




function clearHighlights3D() {
    if (!Graph3D) return;
    
    // Reset to default values
    Graph3D.nodeOpacity(0.9);
    Graph3D.linkOpacity(0.3);
    Graph3D.nodeVisibility(true); // Ensure all nodes are visible
    Graph3D.linkVisibility(true); // Ensure all links are visible
}

// Performance optimization
function optimizeRendering() {
    const isMobile = checkIfMobile();
    
    // Implement level-of-detail (LOD)
    let lastCameraDistance = 0;
    
    Graph3D.onEngineTick(() => {
        const camera = Graph3D.camera();
        const currentDistance = camera.position.length();
        
        if (Math.abs(currentDistance - lastCameraDistance) > 50) {
            lastCameraDistance = currentDistance;
            
            // More aggressive LOD for mobile
            if (isMobile) {
                if (currentDistance > 800) {
                    Graph3D.nodeResolution(4);
                    Graph3D.nodeOpacity(0.7);
                } else if (currentDistance > 400) {
                    Graph3D.nodeResolution(8);
                    Graph3D.nodeOpacity(0.8);
                } else {
                    Graph3D.nodeResolution(12);
                    Graph3D.nodeOpacity(0.9);
                }
            } else {
                // Desktop LOD
                if (currentDistance > 1000) {
                    Graph3D.nodeResolution(8);
                } else if (currentDistance > 500) {
                    Graph3D.nodeResolution(12);
                } else {
                    Graph3D.nodeResolution(16);
                }
            }
        }
    });
}

// Utility functions
function toggleControlPanel3D() {
    const panel = document.querySelector('.controls-3d');
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
    } else {
        panel.style.display = 'none';
    }
}

function focusOnNode3D(node, duration = 1500) {
    if (!Graph3D || !node) return;
    
    // Ensure node has position data
    const x = node.x || 0;
    const y = node.y || 0; 
    const z = node.z || 0;
    
    const distance = 100;
    const distRatio = 1 + distance / Math.hypot(x, y, z);
    
    // Focus on node without hiding others
    Graph3D.cameraPosition(
        { 
            x: x * distRatio,
            y: y * distRatio,
            z: z * distRatio
        },
        { x, y, z }, // Look at the node
        duration
    );
    
    // Make sure we don't accidentally hide nodes
    setTimeout(() => {
        if (Graph3D) {
            Graph3D.nodeVisibility(true);
            Graph3D.linkVisibility(true);
        }
    }, duration + 100);
}




function backTo2D() {
    console.log('backTo2D called');
    switchView('tree');
}

function getFreshnessInfo(lastModified) {
    const now = new Date();
    const lastMod = new Date(lastModified);
    const daysSince = Math.floor((now - lastMod) / (1000 * 60 * 60 * 24));
    
    if (daysSince < 30) return { label: 'New', color: '#2e7d32' };
    if (daysSince < 90) return { label: 'Fresh', color: '#43a047' };
    if (daysSince < 180) return { label: 'Recent', color: '#fdd835' };
    if (daysSince < 365) return { label: 'Aging', color: '#fb8c00' };
    if (daysSince < 730) return { label: 'Old', color: '#e53935' };
    return { label: 'Stale', color: '#b71c1c' };
}

function getFreshnessColor(lastModified) {
    return getFreshnessInfo(lastModified).color;
}

// Add minimap for spatial awareness
function addMinimap3D() {
    // This would require additional implementation with a secondary camera
    // Placeholder for future enhancement
}

// Add statistics display
function addStats3D() {
    const stats = document.createElement('div');
    const isMobile = checkIfMobile();
    
    stats.style.cssText = `
        position: ${isMobile ? 'fixed' : 'absolute'};
        bottom: ${isMobile ? 'auto' : '20px'};
        top: ${isMobile ? '180px' : 'auto'};
        left: ${isMobile ? '85%' : '20px'};
        transform: ${isMobile ? 'translateX(-50%)' : 'none'};
        background: rgba(255, 255, 255, 0.9);
        padding: ${isMobile ? '8px 12px' : '10px 15px'};
        border-radius: ${isMobile ? '20px' : '8px'};
        font-size: ${isMobile ? '11px' : '12px'};
        color: #666;
        display: flex;
        gap: ${isMobile ? '12px' : '10px'};
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    `;
    
    stats.innerHTML = `
        <div>Nodes: <strong>${graphData.nodes.length}</strong></div>
        <div>Links: <strong>${graphData.links.length}</strong></div>
        <div id="search3dInfo"></div>
    `;
    
    document.getElementById('3d-graph-container').appendChild(stats);
}

// Context menu for nodes
function showNodeContextMenu3D(node, event) {
    // Implementation for right-click context menu
    const menu = document.createElement('div');
    menu.style.cssText = `
        position: absolute;
        left: ${event.clientX}px;
        top: ${event.clientY}px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 10000;
    `;
    
    menu.innerHTML = `
        <div style="padding: 8px 12px; cursor: pointer;" 
             onclick="expandBranch3D(${node.id}); this.parentElement.remove();">
            Expand Branch
        </div>
        <div style="padding: 8px 12px; cursor: pointer;" 
             onclick="collapseBranch3D(${node.id}); this.parentElement.remove();">
            Collapse Branch
        </div>
        <div style="padding: 8px 12px; cursor: pointer;" 
             onclick="isolateBranch3D(${node.id}); this.parentElement.remove();">
            Isolate Branch
        </div>
    `;
    
    document.body.appendChild(menu);
    
    // Remove menu on click outside
    setTimeout(() => {
        document.addEventListener('click', () => menu.remove(), { once: true });
    }, 10);
}  // <-- This closing brace was missing!

// Branch operations
function expandBranch3D(nodeId) {
    // Implementation for expanding a branch
}

function collapseBranch3D(nodeId) {
    // Implementation for collapsing a branch
}

function isolateBranch3D(nodeId) {
    // Show only this branch and its descendants
    const node = graphData.nodes.find(n => n.id === nodeId);
    if (!node) return;
    
    const visibleNodes = new Set([nodeId]);
    
    function addDescendants(parentId) {
        const children = graphData.nodes.filter(n => 
            graphData.links.some(l => l.source === parentId && l.target === n.id)
        );
        children.forEach(child => {
            visibleNodes.add(child.id);
            addDescendants(child.id);
        });
    }
    
    addDescendants(nodeId);
    
    Graph3D.nodeVisibility(n => visibleNodes.has(n.id));
    Graph3D.linkVisibility(link => {
        const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
        const targetId = typeof link.target === 'object' ? link.target.id : link.target;
        return visibleNodes.has(sourceId) && visibleNodes.has(targetId);
    });
}



    </script>
</body>
</html>
